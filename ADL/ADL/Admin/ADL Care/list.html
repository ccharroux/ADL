
<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ADL System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Facebook and Twitter integration -->
    <meta property="og:title" content="" />
    <meta property="og:image" content="" />
    <meta property="og:url" content="" />
    <meta property="og:site_name" content="" />
    <meta property="og:description" content="" />
    <meta name="twitter:title" content="" />
    <meta name="twitter:image" content="" />
    <meta name="twitter:url" content="" />
    <meta name="twitter:card" content="" />
    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <link rel="shortcut icon" href="../../favicon.ico">
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,300,700,900' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css?family=Playfair+Display:400,700" rel="stylesheet">
    <!-- Animate.css -->
    <link rel="stylesheet" href="../../css/animate.css">
    <!-- Icomoon Icon Fonts-->
    <link rel="stylesheet" href="../../css/icomoon.css">
    <!-- Simple Line Icons -->
    <link rel="stylesheet" href="../../css/simple-line-icons.css">
    <!-- Bootstrap  -->
    <link rel="stylesheet" href="../../css/bootstrap.css">
    <!-- Theme style  -->
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.18/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.2/css/responsive.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.5.2/css/buttons.dataTables.min.css" />
    <!--Chosen Dropdown-->
    <link rel="stylesheet" href="../../css/chosen.min.css" />
    <!-- Modernizr JS -->
    <script src="../../js/modernizr-2.6.2.min.js"></script>
    <!-- FOR IE9 below -->
    <!--[if lt IE 9]>
    <script src="js/respond.min.js"></script>
    <![endif]-->
    <style>
        a {
            white-space: nowrap !important;
        }

        td {
            max-width: 100px !important;
        }
        .careGrid
        {
            height: 35px;
        }
        .buttonCell
        {
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="fh5co-page">
        <header id="fh5co-header" role="banner">
            <div class="container">
                <div class="header-inner" id="menu"></div>
            </div>
        </header>
        <div id="fh5co-contact-section" class="contact-section">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 col-md-offset-3 text-center fh5co-heading">
                        <h2 id="pageTitle"></h2>

                    </div>
                </div>

                <!-- search / filter area -->
                <div class="row search-section">
                    <div class="col-md-5">
                        <label for="ddlFacilities" class="dropdown-label">Facility</label><br>
                        <select id="ddlFacilities" class="search-ddl-select dropdown-select report-filter" onchange="getList();"></select>
                    </div>
                    <div class="col-md-5">
                        <div class="col-md-2 DateLabel" class="dropdown-label">Date</div><br>
                        <div class="col-md-7 DateValue"><input type="text" id="dtDate" /></div>
                   </div>
                </div>

                <!-- start datatable-->
                <div class="dataTable-top-margin">
                    <table id="dt" class="dataTable-border dataTable-headers dataTable-cell-border">
                        <thead>
                            <tr>
                                <th class="exportColumn">Patient</th>
                                <th class="exportColumn">Late</th>
                                <th class="exportColumn">% Complete</th>
                                <th></th>
                            </tr>
                        </thead>

                    </table>
                </div>
                <!-- end datatable -->
            </div>
        </div>
        <!--<div id="map" data-animate-effect="fadeIn"></div>-->
    </div>
 
    <div id="DateDialog" title="" style="display:none">
        <h3 id="patient"></h3>
        <hr>
        <table id="details" width="100%">

        </table>
    </div>

   <!-- jQuery -->
    <script src="../../js/jquery.min.js"></script>
    <!-- jQuery Easing -->
    <script src="../../js/jquery.easing.1.3.js"></script>
    <!-- Bootstrap -->
    <script src="../../js/bootstrap.min.js"></script>
    <!-- Bootbox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
    <!-- Waypoints -->
    <script src="../../js/jquery.waypoints.min.js"></script>
    <!-- BlockUI JS -->
    <script src="../../js/blockUI.js"></script>
    <!-- Config JS -->
    <script src="../../js/config.js"></script>
    <!-- MAIN JS -->
    <script src="../../js/main.js"></script>
    <!-- genericReport JS -->
    <script src="../../js/genericReport.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.18/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.print.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.colVis.min.js"></script>
    <!-- plug-in to abbreviate HTML -->
    <script type="text/javascript" src="https://cdn.datatables.net/plug-ins/1.10.20/dataRender/ellipsis.js"></script>
    <!-- jQuery UI NEEDED FOR DIALOG -->
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <!--Chosen Dropdown-->
    <script src="../../js/chosen.jquery.min.js"></script>
</body>
</html>
<script>

    var currentPatient = "";
    var currentPatientId = 0;

    $(document).ready(function () {

        if (doesUserHaveAccessToFeature("adl care") == false)
        {
            return;
        }
        else {            
            buildUIDialogs();
            setTitle('Patient Care');
            setEventListeners();
            setDataTable();
            loadFacilities("ddlFacilities")           
            setDateControl();
            buildMainMenu("Admin");
            getList();
        }
     });

    function setDateControl()
    {
        var holdDate  = currentDate();

        $("#dtDate").val(holdDate);
        $("#dtDate").datepicker({
                                maxDate: "0",
                                onSelect: function(dateText, inst) { 
                        getList();
                    }
                                }); 
    }

    function buildUIDialogs() {

        $(function () {
            $("#DateDialog").dialog({
                autoOpen: false,
                resizable: false,
                width: 700,
                height: 500,
                modal: true,
                title: "Patient Care",
                create: function (event, ui) {
                    $(event.target).parent().css('position', 'fixed');
                }
            });
        });
        


    }
    function setEventListeners() {
        
        $("body").on("click", ".ui-icon-closethick", function () {
            getList();
        });

        $("body").on("click", "#clear_search_button", function () {
            //this gets the datatable and gives access to the apis
            var table = $("#dt").DataTable();
            //this redraws the table and passes no search data 
            //returning all rows back into the table unless there are any
            //filter columns set
            table.search('').draw();
        });
    }

    function setDataTable() 
    {
    
        var reportTitle = "Patient Care";
        var exportColumns = returnTableColumnsByClass("dt", "exportColumn");


        $("#dt").DataTable({
            "dom": "Blfrtip",
            "pageLength": gDataTableDefaultRows,
            "data": [],
            "order": [[ 0, "asc" ]],
            "columns": [
                {
                    "data": 'Patient',
                    "className": "text-align-left"
                },
                {
                    "data": 'LateADLs',
                    "className": "text-align-center"
                },
                {

                    mRender: function (data, type, row) {

                        var action = row.PctComplete +'%';
                       // <input value="Select All Days" onclick="selectAllDays();" class="default-button" type="button" />
 
 
                        action = action + "<table style='margin-top:2px;margin-bottom:2px' width='100%'>";
                        action = action + "<tr>";
                        
                        if (row.PctComplete == '100')
                        {
                            action = action + "<td style='background:green' width='100%'></td>";

                        }
                        else if (row.PctComplete == 0)
                        {
                            action = action + "<td style='background:red' width='100%'></td>";

                        }
                        else
                        {
                            action = action + "<td style='background:green' width='"+ row.PctComplete +"%'></td>";
                            var notDone = (100 - parseInt(row.PctComplete));
                            action = action + "<td style='background:red' width='"+ notDone +"%'></td>";

                        }
                         
                        action = action + "</tr>";
                        action = action + "</table>";

                        action = action + "<input type='button' class='default-button smallButton' onclick='openItem(";
                        action = action + row.PatientId + ',"';
                        action = action + row.Patient + '")' + ";' value='" + (row.PctComplete == '100' ? "View" : "Update") + "" + "' />";

                        return action;
                    },
                    "orderable": true,
                    "searchable": true,
                    "className": "text-align-center"
                },
                {
                    mRender: function (data, type, row) {

                        var action = '';

                            action = action + "<a href='#' onclick='patientScheduling(" + row.PatientId + ");'>Patient Schedule</a><br>";
                            action = action + "<a href='#' onclick='patienceMaintenance(" + row.PatientId + ");'>Patient Maintenance</a><br>";

                        return action;
                    },
                    "orderable": false,
                    "searchable": false,
                    "className": "text-align-center"
                }
            ],
            "pagingType": "full_numbers",
            "buttons": [
 
               {
                   extend: 'excel',
                   title: reportTitle,
                   exportOptions: {
                       columns: exportColumns,
                       format: {
                           header: function (data, columnIdx) {
                               return returnExportColumnHeadingTitle("dt", data, columnIdx);
                           }
                       }
                   }
               },
  
               {
                   extend: 'pdf',
                   title: reportTitle,
                   exportOptions: {
                       columns: exportColumns,
                       format: {
                           header: function (data, columnIdx) {
                               return returnExportColumnHeadingTitle("dt", data, columnIdx);
                           }
                       }
                   }
               },
               {
                   extend: 'print',
                   title: reportTitle,
                   exportOptions: {
                       columns: exportColumns,
                       format: {
                           header: function (data, columnIdx) {
                               return returnExportColumnHeadingTitle("dt", data, columnIdx);
                           }
                       }
                   }
               }
               //,
               //this button is supposed to handle column visibility
               //however it isn't working on our site
               //'colvis'
            ],
            initComplete: function () {
                $(".dataTables_filter").append('<button type="button" class="clear-button" id="clear_search_button"><img width="29" height="29" src="../../images/red-x.png" /></button>');
            },
            createdRow: function (row, data, index) {
                //this adds the class to every row
                $(row).addClass('single-line-height');
            },
            language: {
                //this changes search box label from Search: to Filter Results:
                search: "Filter Results:"
            }
        });

    }

    function patientScheduling(id)
    {
        document.location = '../../admin/patient scheduling/list.html';
    }

    function whatDateAreWeWorkingWith()
    {
        var td = $("#dtDate").val();
        var tdArray = td.split('/');
        var tdTransformed = tdArray[2] + '-' + tdArray[0] + '-' + tdArray[1];
        return tdTransformed;
    }
    function openItem(patientId, patient)
    {
        // validation first

        var tdTransformed = whatDateAreWeWorkingWith();

        currentPatient = patient;
        currentPatientId = patientId;

        getPatientADLListByDayAPICall(patientId, tdTransformed);

    }
    function getList() {

        setCurrentFacility();
        
        var url = ServicePrefix + "/patient/ADLLogSummaryListByDate/";
        url = url + getTokenInput();
        url = url + "&inFacilityId=" + getFacilityFromControl("ddlFacilities");
        url = url + "&inTransactionDate=" + $("#dtDate").val();
        
        $.ajax({
            url: url,
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',
            processData: false,
            success: function (data, textStatus, jQxhr) {

                console.log(data);
            
                populateDataTable("dt", data);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });
    }

    // functional area
    function patienceMaintenance(id)
    {
        window.location = "../../admin/users/item.html?userId=" + id;
    }

 
    function enterCare(control)
    {
        $("#" + control).html(currentDate());
    }

    function getPatientADLListByDaySuccess(data, textStatus, jQxhr)
    {
        if (data.response.status != "SUCCESS") 
        {
            ADLErrorMessage(data.response.errorMessage[0]);
        } 
        else 
        {      
            var str = "";
 
            $.each(data.rows, function (index) 
            {
                
                var obj = data.rows[index];
                
                str = str + "<tr style='height:60px'>";
                str = str + "<td width='20%' class='text-align-center'>" + convertFromMilitaryToStandard(obj.TimeOfDay, false) +"</td>";
                str = str + "<td width='50%'>" + obj.SystemADL + "</td>";
                str = str + "<td width='30%' class='text-align-center'>";
                
                if (obj.TransactionDate == "")
                {
                    str = str + '<input value="Update" onclick="markItDone('+ obj.ADLPatientId +');" class="default-button smallButton" type="button" />';
   
                }
                else
                {
                    str = str + obj.TransactionDate + "<br>" + obj.UserName;
                }

                str = str + "</td></tr>";
 

            });

            $("#details").html(str);
            setPatient(currentPatient);
            $("#DateDialog").dialog("open");            
 
        }

    }
    
    function markItDone( logId)
    {

        var obj = new Object();

        obj["inApiToken"] = getLocalStorage("APIToken"); 
        obj["inUserId"] = parseInt(getLocalStorage("userId"));
        obj["inADLPatientId"] = parseInt(logId);

        console.log(obj);
        // stringify
        obj = JSON.stringify(obj);
 
        insertPatientADLLogAPICall(obj);

    }
    function insertPatientADLLogSuccess(data, textStatus, jQxhr)
    {
        if (data.response.status != "SUCCESS") 
        {
            ADLErrorMessage(data.response.errorMessage[0]);
        } 
        else 
        {      
            var tdTransformed = whatDateAreWeWorkingWith();
            getPatientADLListByDayAPICall(currentPatientId, tdTransformed);
        }
    }
    function afterClose()
    {
        getList();
    }
</script>

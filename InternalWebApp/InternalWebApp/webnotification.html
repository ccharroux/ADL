<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>MKA Internal Media Site</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Facebook and Twitter integration -->
    <meta property="og:title" content="" />
    <meta property="og:image" content="" />
    <meta property="og:url" content="" />
    <meta property="og:site_name" content="" />
    <meta property="og:description" content="" />
    <meta name="twitter:title" content="" />
    <meta name="twitter:image" content="" />
    <meta name="twitter:url" content="" />
    <meta name="twitter:card" content="" />
    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <link rel="shortcut icon" href="favicon.ico">
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,300,700,900' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css?family=Playfair+Display:400,700" rel="stylesheet">
    <!-- Animate.css -->
    <link rel="stylesheet" href="/css/animate.css">
    <!-- Icomoon Icon Fonts-->
    <link rel="stylesheet" href="/css/icomoon.css">
    <!-- Simple Line Icons -->
    <link rel="stylesheet" href="/css/simple-line-icons.css">
    <!-- Bootstrap -->
    <link rel="stylesheet" href="/css/bootstrap.css">
    <!-- Theme style  -->
    <link rel="stylesheet" href="/css/style.css">

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.18/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.2/css/responsive.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.5.2/css/buttons.dataTables.min.css" />

    <!-- Modernizr JS -->
    <script src="/js/modernizr-2.6.2.min.js"></script>
    <!-- FOR IE9 below -->
    <!--[if lt IE 9]>
    <script src="js/respond.min.js"></script>
    <![endif]-->

</head>
<body>

    <div id="fh5co-page">
        <header id="fh5co-header" role="banner">
            <div class="container">
                <div class="header-inner" id="menu"></div>
            </div>
        </header>

        <div id="fh5co-contact-section" class="contact-section">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 text-center col-md-offset-3 fh5co-heading">
                        <h2>Web Notifications</h2>
                        <div style="color:red">TEMP: Web Notification List is currently cut off at 1000.</div>
                    </div>
                </div>

                <input type="hidden" id="hdnPersonnelId" value="" />

                <!--Search Filters Top Row-->
                <div class="row">
                    <div class="col-md-3">
                        <label for="ddlStatus" class="search-ddl-label">Status</label><br />
                        <select id="ddlStatus" class="search-ddl-select" style="">
                            <option value="">All</option>
                            <option value="notified">Notified</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="ddlRoles" class="search-ddl-label">Roles</label><br />
                        <select id="ddlRoles" class="search-ddl-select" style="">
                            <option value="">All Client Personnel</option>
                            <option value="contactsonly">Contacts Only</option>
                            <option value="recipientsonly">Recipients Only</option>
                        </select>
                    </div>
                </div>

                <!--Search Filters Bottom Row-->
                <div class="row">
                    <div class="col-md-3">
                        <label for="txtPersonnel" class="search-ddl-label">Personnel</label>
                        <input id="txtPersonnel" class="field-width-210" onclick="getPersonnel()" readonly />&nbsp;&nbsp;
                        <a class="" href="#" onclick="clearSelection('Personnel')">X</a>
                    </div>
                    <div class="col-md-3">
                        <label for="ddlMarket" class="search-ddl-label">Market</label>
                        <select id="ddlMarket" class="search-ddl-select" onchange="resetFilters('market');"></select>
                    </div>
                    <div class="col-md-3">
                        <label for="ddlOwner" class="search-ddl-label">Owner</label>
                        <select id="ddlOwner" class="search-ddl-select" onchange="resetFilters('owner');"></select>
                    </div>
                    <div class="col-md-1">
                        <label for="ddlNumberOfDays" class="field-width-100 search-ddl-label">Date</label>
                        <select id="ddlNumberOfDays" class="field-width-100 search-ddl-select" onchange="resetFilters('numberofdays');">
                            <option value="">All</option>
                            <option selected value="30">30 Days</option>
                            <option value="90">90 Days</option>
                            <option value="180">6 Months</option>
                            <option value="365">1 Year</option>
                        </select>
                    </div>
                    <div class="col-md-2 text-align-right" style="margin-top:5px;">
                        <br/>
                        <input type="button" id="btnShow" class="search-button" value="Show" onclick="getClientPersonnelNotificationList();" />

                    </div>
                </div>

                <!--Start Notification List datatable-->
                <div id="dtNotificationListHolder" class="dataTable-top-margin" style="padding-top:10px; padding-bottom:10px;">
                    <table id="dtNotificationList" class="striped"></table>
                </div>

                <!--End Notification List datatable-->

                <div class="default-button-section margin-top-10">
                    <div class="row">
                        <div class="col-md-4">

                        </div>
                        <div class="col-md-4">
                            <!--Users Selected:
                            <span id="lblUsersSelected">0</span>-->
                        </div>
                        <div class="col-md-4 text-align-right">
                            <input type="button" class="default-button" value="Send Bulk" onclick="sendEmail();" />
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>


    <!-- jQuery -->
    <script src="/js/jquery.min.js"></script>
    <!-- jQuery Easing -->
    <script src="/js/jquery.easing.1.3.js"></script>
    <!-- Bootstrap -->
    <script src="/js/bootstrap.min.js"></script>
    <!-- Bootbox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
    <!-- Waypoints -->
    <script src="/js/jquery.waypoints.min.js"></script>
    <!-- BlockUI JS -->
    <script src="/js/blockUI.js"></script>
    <!-- Config JS -->
    <script src="/js/config.js"></script>
    <!-- MAIN JS -->
    <script src="/js/main.js"></script>

    <script type="text/javascript" src="https://cdn.datatables.net/1.10.18/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.print.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.colVis.min.js"></script>

</body>
</html>
<script>

    var columns = [];
    var columnsToDisplay = new Array();
    var columnsToExport = new Array();

    $(document).ready(function () {

        buildMainMenu("Personnel");
        loadAdvancedSearch();
        getMarketList();

    });

    function resetFilters(filter) {

        if (filter.toLowerCase() == "personnel") {
            $("#ddlMarket").val("");
            $("#ddlOwner").val("");
            $("#ddlNumberOfDays").val("");
        }

        if (filter.toLowerCase() == "market") {
            $("#ddlOwner").val("");
            $("#ddlNumberOfDays").val("");
            $("#txtPersonnel").val("");
        }

        if (filter.toLowerCase() == "owner") {
            $("#ddlMarket").val("");
            $("#ddlNumberOfDays").val("");
            $("#txtPersonnel").val("");
        }

        if (filter.toLowerCase() == "numberofdays") {
            $("#ddlMarket").val("");
            $("#ddlOwner").val("");
            $("#txtpersonnel").val("");
        }

    }

    function buildInputParamObj() {

        var inputParamsObj = {};

        //ApiToken
        inputParamsObj["inApiToken"] = getLocalStorage("APIToken");

        if ($("#ddlStatus").val() != "") {

            //status param
            switch ($("#ddlStatus").val().toLowerCase()) {

                case "notified":
                    inputParamsObj["inNotifiedOnly"] = "1";
                    break;
                case "pending":
                    inputParamsObj["inPendingOnly"] = "1";
                    break;
                default:
                    bootbox.alert("There was an issue when selecting a status.");

            }
        }

        if ($("#ddlRoles").val() != "") {

            //role param
            switch ($("#ddlRoles").val().toLowerCase()) {

                case "contactsonly":
                    inputParamsObj["inContactsOnly"] = "1";
                    break;
                case "recipientsonly":
                    inputParamsObj["inRecipientsOnly"] = "1";
                    break;
                default:
                    bootbox.alert("There was an issue when selecting a role.");
            }
        }

        if ($("#txtPersonnel").val().trim() != "") {
            inputParamsObj["inPersonnelId"] = $("#hdnPersonnelId").val().trim();
        }

        if ($("#ddlMarket").val() != "") {
            inputParamsObj["inMarketId"] = $("#ddlMarket").val();
        }

        if ($("#ddlOwner").val() != "") {
            inputParamsObj["inOwnerId"] = $("#ddlOwner").val();
        }

        if ($("#ddlNumberOfDays").val() != "") {
            inputParamsObj["inNumberDays"] = $("#ddlNumberOfDays").val();
        }

        return inputParamsObj;
    }



    function getClientPersonnelNotificationList() {

        var inputParams = {};

        inputParams = buildInputParamObj();

        var url = ServicePrefix + '/api/Notification/GetClientPersonnelNotificationList';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify(inputParams),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                getClientPersonnelNotificationListSuccess(data, textStatus, jQxhr);
            },
            error: function (jQxhr, textStatus, errorThrown) {
                genericAjaxError(jQxhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);

    }

    function getClientPersonnelNotificationListSuccess(data, textStatus, jQxhr) {
        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.repsponse.errorMessage[0]);
        } else {

            buildColumnsArray(data, "dtNotificationList");

        }
    }

    function destroyDataTable(tableToDestroy) {
        if ($.fn.DataTable.isDataTable('#' + tableToDestroy)) {
            var searchTable = $('#' + tableToDestroy).DataTable();
            searchTable.destroy();
            $('#' + tableToDestroy).hide();
        }

    }



    function buildColumnsArray(dataObj, dataTable) {

        columnsToDisplay = new Array();

        columnsToDisplay.push("Client Personnel");
        columnsToDisplay.push("Contact");
        columnsToDisplay.push("Recipient");
        columnsToDisplay.push("Status");
        columnsToDisplay.push("Date");
        columnsToDisplay.push("Action");
        columnsToDisplay.push("Web User");

        if (!dataObj["report"]["rows"]) {
            destroyDataTable("dtNotificationList");
            return;
        }

        if (dataObj["report"]["rows"].length == 0) {
            destroyDataTable("dtNotificationList");
            return;
        }

        $('#' + dataTable).show();
        var data = dataObj["report"]["rows"][0];
        var ctr = -1;
        columns = new Array();

        //Adding column of checkboxes to first column
        columns.push({
            mRender: function (data, type, row) {
                return '<input type="checkbox" onclick="userSelected(' + row["Personnel ID"] + ')" />';
            },
            "orderable": false,
            "searchabble": false,
            "className": "chkColumn"
        });


        $.each(data, function (objectName, objectValue) {

            if (columnsToDisplay.includes(objectName)) {

                var className = "";

                if (isNaN(objectValue) == false) {
                    className = "text-align-right";
                }

                ctr++;
                columnsToExport.push(ctr);

                columns.push({
                    "title": objectName,
                    "visible": true,
                    "mData": objectName,
                    "orderable": true,
                    "className": className
                });
            }
        });

        columns.push({
            mRender: function (data, type, row) {
                return '<a href="#" onclick="sendIndividualEmail(' + row["Personnel ID"] + ')">Send</a>';
            },
            "orderable": false,
            "searchable": false,
            "className": "text-align-right"
        })

        loadResults(dataObj, columns, dataTable);
    }

    function loadResults(data, columns, dataTable) {
        //data is the data from the ajax call
        //columns is the array that was built previously

        //assigns the data from the ajax call
        var results = data["report"]["rows"];

        //creating a variable that will be used for datatable functions later
        var searchTable;


        //if the datatable already exists need to destroy it before building it
        //again with new results from the search.
        //if you try to destroy before it is a datatable, an error will occur.
        //this code will only destroy it if the table is a datatable.

        //The destroy function only destroys the data in the datatable.
        //However, the columns need to be same if repopulating the table.
        if ($.fn.DataTable.isDataTable('#' + dataTable)) {
            searchTable = $('#' + dataTable).DataTable();
            searchTable.destroy();
        }


        searchTable = $('#' + dataTable).DataTable({
            "dom": "Blfrtip",
            "pageLength": gDataTableDefaultRows,
            "order": [],
            "data": results,
            "columns": columns,
            "select": true,
            language: {
                search: "Filter Results:"
            },
            initComplete: function () {

                $("#dtNotificationList_length").after("<label class='users-selected'>Users Selected: <span id='spnUsersSelected'>0</span></label>");
                $(".dataTables_filter input").unbind();
                $(".dataTables_filter input").bind('keyup', function () {

                    //data table filter
                    searchTable.search(this.value).draw();

                    //getting all hidden rows and unchecking all checkboxes
                    var hiddenRows = searchTable.rows({ search: 'removed' }).nodes();
                    $(hiddenRows).find('.chkColumn input[type=checkbox]').prop('checked', false);

                    //updating selected checkbox count
                    updateSelectedCount();

                })
            },
            "buttons": [
                 //{
               //    extend: 'csv',
               //    exportOptions: {
               //        columns: columnsToExport
               //    }
               //},
               {
                   extend: 'excel',
                   title: "Notifications",
                   exportOptions: {
                       columns: columnsToExport
                   }
               },
               //{
               //    extend: 'pdf',
               //    title: reportObject.reportTitle,
               //    exportOptions: {
               //        columns: columnsToExport
               //     }
               //},
               {
                   extend: 'print',
                   title: "Notifications",
                   exportOptions: {
                       columns: columnsToExport

                   }
               }
            ],

        });
    }

    function updateSelectedCount() {

        var cnt = 0;

        //looping through all rows to count all selected checkboxes
        $("#dtNotificationList").DataTable().rows().every(function (index, element) {
            var row = $(this.node());
            if (row.find('.chkColumn input[type=checkbox]').prop('checked') == true) {
                cnt = cnt + 1;
            }
        });

        $("#spnUsersSelected").text(cnt);
    }

    function getMarketList() {

        var url = ServicePrefix + '/api/Market/GetMarketList';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken")
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                getMarketListSuccess(data, textStatus, jQxhr);
            },
            error: function (jQxhr, textStatus, errorThrown) {
                genericAjaxError(jQxhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);

    }

    function getMarketListSuccess(data, textStatus, jQxhr) {

        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
        }

        else {
            var str = '';
            str = '<option value="">-- Select a Market </option>';

            $.each(data.report.rows, function (index) {
                str = str + '<option value="' + data.report.rows[index].marketId + '">' + data.report.rows[index].marketName + '</option>';

            });

            $("#ddlMarket").append(str);

            getOwnerList();
        }
    }

    function getOwnerList() {

        var url = ServicePrefix + '/api/Owner/GetOwnerListUnfiltered';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inOwnerName": "",
                "inActiveOnly": "1",
                "inAddDetails": "0"
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                getOwnerListSuccess(data, textStatus, jQxhr);
            },
            error: function (jQxhr, textStatus, errorThrown) {
                genericAjaxError(jQxhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);

    }

    function getOwnerListSuccess(data, textStauts, jQxhr) {

        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0])
        }

        else {

            var str = '';

            str = "<option value=''> -- Select an Owner </option>";

            $.each(data.report.rows, function (index) {
                str = str + "<option value='" + data.report.rows[index].OwnerID + "'>" + data.report.rows[index].OwnerName + "</option>";
            });

            $("#ddlOwner").append(str);

            getClientPersonnelNotificationList();

        }

    }

    function getPersonnel() {

        var searchCriteriaObj = {
            "searchToken": "PERSONNEL",
            "txtPersonnel": $("#txtPersonnel").html(),
            "ddlStatus": $("#ddlStatus").val(),
            "ddlRoles": $("#ddlRoles").val(),
            "searchPage": window.location
        }

        setLocalStorage("gSearchCriteria", JSON.stringify(searchCriteriaObj));

        window.location = "/utilities/search.html";
    }

    function loadAdvancedSearch() {

        var searchResults = getLocalStorage("gSearchResults");

        if (!searchResults) {
            return;
        }

        var searchCriteria = $.parseJSON(searchResults);

        if (searchCriteria["searchToken"] == "PERSONNEL") {

            resetFilters("personnel");

            $("#ddlStatus").val(searchCriteria["ddlStatus"]);

            $("#ddlRoles").val(searchCriteria["ddlRoles"]);

            $("#txtPersonnel").val(searchCriteria["txtPersonnel"]);
            $("#hdnPersonnelId").val(searchCriteria["personnelId"]);

            searchCriteria["txtPersonnel"] = "";
            searchCriteria["personnelId"] = "";
            searchCriteria["ddlStatus"] = "";
            searchCriteria["ddlFilter"] = "";

            getClientPersonnelNotificationList();
        }
        destroySearchCriteria();

    }

    function destroySearchCriteria() {
        setLocalStorage("gSearchCriteria", null);
        setLocalStorage("gSearchResults", null);
    }

    function sendEmail() {
        bootbox.alert("This functionality is currently in development.");
    }

    function clearSelection(control) {
        $("#txt" + control).val("");
        $("#hid" + control).val("");
    }

    function userSelected(personnelId) {
        console.log(personnelId);

        updateSelectedCount();
    }

    function sendIndividualEmail() {
        bootbox.alert("This functionality is currently in development.");
    }

</script>
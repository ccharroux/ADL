
<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>MKA Internal Media Site</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Facebook and Twitter integration -->
    <meta property="og:title" content="" />
    <meta property="og:image" content="" />
    <meta property="og:url" content="" />
    <meta property="og:site_name" content="" />
    <meta property="og:description" content="" />
    <meta name="twitter:title" content="" />
    <meta name="twitter:image" content="" />
    <meta name="twitter:url" content="" />
    <meta name="twitter:card" content="" />
    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <link rel="shortcut icon" href="/favicon.ico">
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,300,700,900' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css?family=Playfair+Display:400,700" rel="stylesheet">
    <!-- Animate.css -->
    <link rel="stylesheet" href="/css/animate.css">
    <!-- Icomoon Icon Fonts-->
    <link rel="stylesheet" href="/css/icomoon.css">
    <!-- Simple Line Icons -->
    <link rel="stylesheet" href="/css/simple-line-icons.css">
    <!-- Bootstrap  -->
    <link rel="stylesheet" href="/css/bootstrap.css">
    <!-- Theme style  -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.18/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.2/css/responsive.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.5.2/css/buttons.dataTables.min.css" />
    <!--Chosen Dropdown-->
    <link rel="stylesheet" href="/css/chosen.min.css" />   
     <!-- Modernizr JS -->
    <script src="/js/modernizr-2.6.2.min.js"></script>
    <!-- FOR IE9 below -->
    <!--[if lt IE 9]>
    <script src="js/respond.min.js"></script>
    <![endif]-->
    <style>
        .noWrap
        {
            white-space: nowrap;
 
        }
        .search-ddl-select-rpt
        {
            width:360px!important;
        }
        .sectionSettings
        {
            border-radius: 15px;
            border: solid 1px silver;
            padding: 10px 10px 10px 10px;
            margin: 5px 5px 5px 5px;
        }
        h3{margin-bottom: 3px;
            margin-top:10px;
        }
        input
        {
            margin-left:20px!important;
        }
    </style>
</head>
<body>

    <div id="fh5co-page">
        <header id="fh5co-header" role="banner">
            <div class="container">
                <div class="header-inner" id="menu"></div>
            </div>
        </header>
        <div id="fh5co-contact-section" class="contact-section">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 col-md-offset-3 text-center fh5co-heading">
                        <h2>System User Settings</h2>
                        <h3 id="nameOfPersonnel"></h3>
                    </div>
                </div>
 
 
                <!-- end datatable -->
                <div class="col-md-12"  >
                    <div class="row"  >
 
                        <div class="col-md-5 SystemSettings sectionSettings" style="display:none">
                            <div style="padding:5px 5px 5px 5px; ">
                                <h3>System Settings</h3>
                                Reports + Queries<br />
                                <input type="radio" name="rbSameTabReporting" onclick="updateSystemUserSettings()" value="no"/>&nbsp;New Tab<br />
                                <input type="radio" name="rbSameTabReporting" onclick="updateSystemUserSettings()" value="yes"  checked="checked"  />&nbsp;Same Tab
                                <hr />
                                <h3>Launch Page</h3>
                                <div id="launchDiv">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5 MRRRecipientSettings sectionSettings" style="display:none">
                            <div style="padding:5px 5px 5px 5px; ">
                                <h3>MRR Recipient Settings</h3>
                                When market data becomes available, receive e-mail<br />
                                <input type="radio" name="rbEmailNotificationMRR" onclick="updateMRRRecipientUserSettings()" value="0" />&nbsp;No<br />
                                <input type="radio" name="rbEmailNotificationMRR" onclick="updateMRRRecipientUserSettings()" value="1" />&nbsp;Yes, per market<br />
                                <input type="radio" name="rbEmailNotificationMRR" onclick="updateMRRRecipientUserSettings()" checked="checked" value="2" />&nbsp;Yes, per month<br />
                                I want reports to use <select onchange="updateMRRRecipientUserSettings()" id="ddlMRRDefaultReportFormat">
                                    <option selected="selected" value="Interactive">Interactive</option>
                                    <option value="PDF">PDF</option>
                                    <option value="Excel">Excel</option>
                                </select>&nbsp;format by default
                            </div>
                        </div>
                        <div class="col-md-5 MRRContactSettings sectionSettings" style="display:none">
                            <div style="padding:5px 5px 5px 5px; ">
                                <h3>MRR Contact Settings</h3>
                                <input type="checkbox" id="chkEmailNotficationSubmitMRR" checked="checked" onclick="updateMRRContactUserSettings()" />&nbsp;Receive e-mail after submitting data<br />
                                <input type="checkbox" id="chkSaveButtonSubmitMRR" onclick="updateMRRContactUserSettings()" />&nbsp;Show <b>Save</b> button to submit data (no marking as final)<br />
                                <hr>For markets (if any) submitting multiple periods at once, I want tab order to go<br />
                                <input type="radio" name="rbMultipleMarketSubmission" onclick="updateMRRContactUserSettings()" checked="checked" value="0" />&nbsp;down, then across<br />
                                <input type="radio" name="rbMultipleMarketSubmission" onclick="updateMRRContactUserSettings()" value="1" />&nbsp;across, then down

                            </div>
                        </div>
                        <div class="col-md-5 XRYSettings sectionSettings" style="display:none">
                            <div style="padding:5px 5px 5px 5px; ">
                                <h3>XRY Settings</h3>
                                Queries for <b>All Periods</b> omit years before <select onchange="updateXRayUserSettings()" id="ddlXRAYOmitYears"></select>

                                <br /><b>Notes</b>:&nbsp;This option only affects queries with an <b>All Periods</b> option.&nbsp;This option will automatically advance to the next year on January 1.<hr />
                                Queries to export to  <select onchange="updateXRayUserSettings()" id="ddlXRYDefaultExportFormat">
                                    <option selected="selected" value="XLSX">Excel</option>
                                    <option value="PDF">PDF</option>
                                </select>&nbsp;format by default
                                <hr />
                                When market data becomes available, receive e-mail<br />
                                <input type="radio" name="rbEmailNotificationXRY" onclick="updateXRayUserSettings()" value="0" />&nbsp;No<br />
                                <input type="radio" name="rbEmailNotificationXRY" onclick="updateXRayUserSettings()" value="1" />&nbsp;Yes, per market<br />
                                <input type="radio" name="rbEmailNotificationXRY" onclick="updateXRayUserSettings()" checked="checked" value="2" />&nbsp;Yes, per month<br />
                            </div>
                        </div>
 
                    </div>
 
            </div>
        </div>
        <!--<div id="map" data-animate-effect="fadeIn"></div>-->
    </div>
    </div>
    <!-- jQuery -->
    <script src="/js/jquery.min.js"></script>
    <!-- jQuery Easing -->
    <script src="/js/jquery.easing.1.3.js"></script>
    <!-- Bootstrap -->
    <script src="/js/bootstrap.min.js"></script>
    <!-- Bootbox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
    <!-- Waypoints -->
    <script src="/js/jquery.waypoints.min.js"></script>
    <!-- BlockUI JS -->
    <script src="/js/blockUI.js"></script>
    <!-- Config JS -->
    <script src="/js/config.js"></script>
    <!-- MAIN JS -->
    <script src="/js/main.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.18/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.print.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.colVis.min.js"></script>
    <!--Chosen Dropdown-->
    <script src="/js/chosen.jquery.min.js"></script>

</body>
</html>
<script>



    var personnelId = 0;
    var nameOfUser = "";
    var columns = [];
    var columnsToDisplay = new Array();
    var columnsToExport = new Array();

    $(document).ready(function () {

        personnelId = getParameterByName("PersonnelId");
        if (personnelId == null)
        {
            window.location = "/admin/login/dashboard.html";
        }       
        getPageParameters();
        setupPageEvents();

        buildMainMenu("Personnel");

        loadQueryYears();
        loadDestinations();
 
        cleanupBackButton(window.location.pathname);
    });
    function loadQueryYears() {

        $("#ddlXRAYOmitYears").html("<option value=''>(none)</option>");
        var str = '';
        var hold = "";

        $.ajax({
            url: ServicePrefix + '/api/Personnel/GetQueryYears?inApiToken=' + getLocalStorage("APIToken") ,
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',
            //data: JSON.stringify({
            //    "inApiToken": getLocalStorage("APIToken"),
            //    "inPersonnelId": personnelId
            //}),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {

                    var holdProduct = "----";
                    $.each(data.report.rows, function (index) {
                        str = '';
                        var obj = data.report.rows[index];
                        $("#ddlXRAYOmitYears").append("<option value='"+obj["RevenueYear"]+"'>"+obj["RevenueYear"]+"</option>");
                     });

                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });


    }
    function loadDestinations()
    {
 
            $("#launchDiv").html("");
            var str = '';
            var hold = "";

            $.ajax({
                url: ServicePrefix + '/api/Personnel/GetUserDestinationList?inApiToken=' + getLocalStorage("APIToken") + '&inPersonnelId=' + personnelId,
                dataType: 'json',
                type: 'get',
                contentType: 'application/json',
                processData: false,
                success: function (data, textStatus, jQxhr) {

                    if (data.response.status != "SUCCESS") {
                        MKAErrorMessageRtn(data.response.errorMessage[0]);
                    }
                    else {

                        var holdProduct = "----";
                        $.each(data.report.rows, function (index) {

                            str = '';
                            var obj = data.report.rows[index];
 
                            if (obj["Destination Product"] != hold)
                            {
                                // lets do a heading...
                                switch (obj["Destination Product"].toUpperCase())
                                {
                                    case 'MRR':
                                        str = str + "<div><b>Market Revenue</b></div>";
                                        break;
                                    case 'XRY':
                                        str = str + "<div><b>X-Ray</b></div>";
                                        break;
                                    case 'TVB':
                                        str = str + "<div><b>TVB</b></div>";
                                        break;
                                    case 'MSS':
                                        str = str + "<div><b>MKA Surveys</b></div>";
                                        break;
                                    case 'DMA':
                                        str = str + "<div><b>DMA</b></div>";
                                        break;
                                    case 'DMX':
                                        str = str + "<div><b>DMX</b></div>";
                                        break;

                                }
                            }
 
                                str = str + '<input onclick="updateSystemUserSettings()" ';
                                if (index == 0)
                                {
                                    str = str + " checked='checked' "
                                }
                                str = str + ' type="radio" name="rbLaunch"';
                                str = str + ' mkaProduct=';
                                str = str + '"' + obj["Destination Product"] + '"';
                                str = str + " mkaPage=";
                                str = str + '"' + obj["Destination Page"] + '"';
                                str = str + " value=";
                                str = str + '"' + obj["Destination Code"] + '"';
                                str = str + ' />&nbsp;';
                                str = str + obj["Destination Description"] + "<br>";
                                hold = obj["Destination Product"];
               

                            $("#launchDiv").append(str);

                        });

                        loadPage();

                    }

                },
                error: function (jqXhr, textStatus, errorThrown) {
                    MKAErrorMessageRtn(errorThrown);

                }
            });

 
    }
    function setupPageEvents()
    {
            $("body").on("click", "#clear_search_button",
               function () {
                   var table = $("#dtPersonnelList").DataTable();
                   table.search('').draw();
               }
            );
    }
    function getPageParameters() {
        //these are values past in local storage
        var name = '';
        if (getLocalStorage("gPageParameters").length > 0) {
            var pageParameters = $.parseJSON(getLocalStorage("gPageParameters"));
            name = pageParameters["personnelName"];
            nameOfUser = pageParameters["personnelName"];
        }
        setUserName(name);
    }

    function setUserName(name) {
 
        $("#nameOfPersonnel").html("<a onclick='goToPersonnelPage()'>" + nameOfUser.toUpperCase() + "</a>");
    }

    function selectItems(controlchecked, control)
    {
       

        if ($("#" + controlchecked).is(':checked') == false)
        {
            $("#" + control + " option:selected").each(function () {
 
                $(this).prop("selected", false);
            });
        }
        else
        {
            $("#" + control + " option").each(function () {
                $(this).prop("selected", true);
            });
        }
    }

    function loadPage() {

        $(".MRRContactSettings").hide();
        $(".MRRRecipientSettings").hide();
        $(".XRYSettings").hide();
        $(".SystemSettings").hide();
 
        $.ajax({
            url: ServicePrefix + '/api/Personnel/GetSystemUserSetting?inApiToken=' + getLocalStorage("APIToken") + '&inPersonnelId=' + personnelId,
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {
                        var obj = data.report.rows[index];
 
                        $('input[name=rbLaunch]').each(function () {
                            if (obj['Product'].toUpperCase() == $(this).attr('mkaProduct').toUpperCase() &&
                                obj['Landing Page'].toUpperCase() == $(this).attr('mkaPage').toUpperCase())
                            {
                                 $(this).prop('checked', true);
                            }
                        });
                        $('input[name=rbSameTabReporting]').each(function () {
                            if (obj['Single Tab Reporting'].toUpperCase() == $(this).val().toUpperCase()) {
                                $(this).prop('checked', true);
                            }
                        });
                        if (obj['MRR Contact'] > 0)
                        {
                            $(".MRRContactSettings").show();
                        }

                        if (obj['MRR Recipient'] > 0) {
                            $(".MRRRecipientSettings").show();
                        }

                        if (obj['XRY Recipient'] > 0) {
                            $(".XRYSettings").show();
                        }

                        $(".SystemSettings").show();

                    });

                    loadMRRContactInfo();
                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });

    }
    function loadMRRContactInfo() {

        if ($(".MRRContactSettings").is(":visible") == false)
        {
            loadMRRRecipientInfo();
            return;
        }
 
        $.ajax({
            url: ServicePrefix + '/api/Personnel/GetMRRContactUserSetting?inApiToken=' + getLocalStorage("APIToken") + '&inPersonnelId=' + personnelId,
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',

            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {
                        var obj = data.report.rows[index];
        
                        $("#chkEmailNotficationSubmitMRR").prop("checked",   (obj['Email Confirm Data Entry'] == 1 ? true : false)) ;
                        $("#chkSaveButtonSubmitMRR").prop("checked", (obj['Data Entry Save Button'] == 1 ? true : false));
                        $('input[name=rbMultipleMarketSubmission]').each(function () {
                            if (obj['Tab Order']  == $(this).val() ) {
                                $(this).prop('checked', true);
                            }
                        });

                    });

                    loadMRRRecipientInfo();

                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });

    }
    function loadMRRRecipientInfo() {

 
        if ($(".MRRRecipientSettings").is(":visible") == false) {
            loadXRayInfo();
            return;
        }

        $.ajax({
            url: ServicePrefix + '/api/Personnel/GetMRRRecipientUserSetting?inApiToken=' + getLocalStorage("APIToken") + '&inPersonnelId=' + personnelId,
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {
                        var obj = data.report.rows[index];
                        console.log(obj);
                        $('input[name=rbEmailNotificationMRR]').each(function () {
                            if (obj['Email Delivery Notification'] == $(this).val()) {
                                $(this).prop('checked', true);
                            }
                        });
 
                        $("#ddlMRRDefaultReportFormat").val(obj["Default Report Format"]);
                     });

                    loadXRayInfo();


                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });

    }
    function loadXRayInfo() {

        if ($(".XRYSettings").is(":visible") == false) {
            return;
        }
 

        $.ajax({
            url: ServicePrefix + '/api/Personnel/GetXRayUserSetting?inApiToken=' + getLocalStorage("APIToken") + '&inPersonnelId=' + personnelId,
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {
                        var obj = data.report.rows[index];
 
                        $('input[name=rbEmailNotificationXRY]').each(function () {
                            if (obj['Email Delivery Notification'] == $(this).val()) {
                                $(this).prop('checked', true);
                            }
                        });
                        $("#ddlXRYDefaultExportFormat").val(obj["Default Export Format"]);
                        $("#ddlXRAYOmitYears").val(obj["First Year"]);
                        //$("#rbEmailNotificationMRR").prop("checked", (obj['Email Delivery Notification'] == 1 ? true : false));
                    });


                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });

    }

    function generalUpdate(api, apiParameters)
    {
        $.ajax({
            url: ServicePrefix + api,
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify(apiParameters),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                if (data.response.status.toUpperCase() === "SUCCESS") {
                    return;
                }
                else {
                    var msg = data.response.errorMessage[0];
                    bootbox.alert(msg, function () { });
                    return false;
                }
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });
    }

    function updateSystemUserSettings()
    {
        var apiParameters = new Object();
        var apiToken = getLocalStorage("APIToken");

        apiParameters["inApiToken"] = apiToken;
        apiParameters["inPersonnelId"] = personnelId;
        apiParameters["inSingleTabReporting"] = $("input[name='rbSameTabReporting']:checked").val();
        apiParameters["inInitialDestination"] = $("input[name='rbLaunch']:checked").val();
 
        var api = '/api/personnel/UpdateSystemUserSettings';

        generalUpdate(api, apiParameters);
        
    }
    function updateMRRContactUserSettings()
    {
        var apiParameters = new Object();
        var apiToken = getLocalStorage("APIToken");

        apiParameters["inApiToken"] = apiToken;
        apiParameters["inPersonnelId"] = personnelId;
        apiParameters["inEmailConfirmDataEntry"] = ($("#chkEmailNotficationSubmitMRR").is(":checked") == true ? "1" : "0");
        apiParameters["inDataEntrySaveButton"] = ($("#chkSaveButtonSubmitMRR").is(":checked") == true ? "1" : "0");
        apiParameters["inMultiplePeriodsTabOrder"] = $("input[name='rbMultipleMarketSubmission']:checked").val();

        var api = '/api/personnel/UpdateMRRContactUserSettings';

        generalUpdate(api, apiParameters);

        //console.log("updateMRRContactUserSettings");
        //console.log(apiParameters);
    }
    function updateMRRRecipientUserSettings() {

        var apiParameters = new Object();
        var apiToken = getLocalStorage("APIToken");

        apiParameters["inApiToken"] = apiToken;
        apiParameters["inPersonnelId"] = personnelId;
        apiParameters["inEmailDeliveryNotification"] = $("input[name='rbEmailNotificationMRR']:checked").val(); 
        apiParameters["inDefaultReportFormat"] = $("#ddlMRRDefaultReportFormat").val();

        var api = '/api/personnel/UpdateMRRRecipientUserSettings';

        generalUpdate(api, apiParameters);

        console.log("updateMRRRecipientUserSettings");
        console.log(apiParameters);
    }
    function updateXRayUserSettings() {

        var apiParameters = new Object();
        var apiToken = getLocalStorage("APIToken");

        apiParameters["inApiToken"] = apiToken;
        apiParameters["inPersonnelId"] = personnelId;
        apiParameters["inFirstYear"] = $("#ddlXRAYOmitYears").val();
        apiParameters["inDefaultExportFormat"] = $("#ddlXRYDefaultExportFormat").val();
        apiParameters["inEmailDeliveryNotification"] = $("input[name='rbEmailNotificationXRY']:checked").val();
        apiParameters["inQueryOutput"] = "0";

        var api = '/api/personnel/UpdateXRayUserSettings';

        generalUpdate(api, apiParameters);

        //console.log("updateXRayUserSettings");
        //console.log(apiParameters);
    }
    function goToPersonnelPage() {
        document.location = "/admin/personnel/personnel.html?personnelId=" + personnelId;

    }
</script>

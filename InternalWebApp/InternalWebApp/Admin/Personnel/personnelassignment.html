
<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>MKA Internal Media Site</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">



    <!-- Facebook and Twitter integration -->
    <meta property="og:title" content="" />
    <meta property="og:image" content="" />
    <meta property="og:url" content="" />
    <meta property="og:site_name" content="" />
    <meta property="og:description" content="" />
    <meta name="twitter:title" content="" />
    <meta name="twitter:image" content="" />
    <meta name="twitter:url" content="" />
    <meta name="twitter:card" content="" />

    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <link rel="shortcut icon" href="/favicon.ico">

    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,300,700,900' rel='stylesheet' type='text/css'>

    <link href="https://fonts.googleapis.com/css?family=Playfair+Display:400,700" rel="stylesheet">

    <!-- Animate.css -->
    <link rel="stylesheet" href="/css/animate.css">
    <!-- Icomoon Icon Fonts-->
    <link rel="stylesheet" href="/css/icomoon.css">
    <!-- Simple Line Icons -->
    <link rel="stylesheet" href="/css/simple-line-icons.css">
    <!-- Bootstrap  -->
    <link rel="stylesheet" href="/css/bootstrap.css">
    <!-- Theme style  -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.18/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.2/css/responsive.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.5.2/css/buttons.dataTables.min.css" />

    <!--Chosen Dropdown-->
    <link rel="stylesheet" href="/css/chosen.min.css" />
    <!-- Modernizr JS -->
    <script src="/js/modernizr-2.6.2.min.js"></script>

    <!-- FOR IE9 below -->
    <!--[if lt IE 9]>
    <script src="js/respond.min.js"></script>
    <![endif]-->
    <style type="text/css">
        .assignmentBoxes {
            border: silver solid 1px;
            border-radius: 15px;
            padding: 5px 5px 5px 5px;
            height: 287px;
        }

        .fh5co-heading {
            margin-bottom: unset;
        }

        hr {
            margin-top: 5px;
            margin-bottom: 5px;
        }

        .assignmentBoxHeader {
            padding-bottom: 3px;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            text-align: center;
            margin-bottom: 5px;
            margin-top: 0px;
            background-color: #34587a;
            color: white;
        }

        .ui-dialog-titlebar-close{
            display:none !important;
        }
    </style>

</head>
<body>


    <div id="fh5co-page">
        <header id="fh5co-header" role="banner">
            <div class="container">
                <div class="header-inner" id="menu"></div>
            </div>
        </header>
        <div id="fh5co-contact-section" class="contact-section">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 col-md-offset-3 text-center fh5co-heading">
                        <a name="workArea"></a>
                        <h2>Personnel Assignment</h2>
                        <h3 id="nameOfPersonnel"></h3>
                    </div>
                </div>
                <div id="divQuickReport"  >
                    <label for="ddlQuickReport" class="search-ddl-label" style="text-align:right">Reports:&nbsp;</label>
                    <select class="search-ddl-select" onchange="getQuickReport(this.value)" style="width:207px;font-size:14px" id="ddlQuickReport"></select>
                </div>


                <!-- search / filter area -->
                <div class="row">
                    <div class="col-md-10">
                        <label for="ddlProduct" class="search-ddl-label">Product</label>
                        <select id="ddlProduct" class="search-ddl-select" style="" onchange="loadScreenForProductChange()"></select>
                        <input value="Corporate Assignment" onclick="corporateAssignInitiate();" style="display:none;" id="btnCorporateAssignInitiate" class="default-button" type="button">
                    </div>
                    <div class="col-md-2 text-align-center">
                        <div class="gray-label width-130">
                            <span id="spnWebStatus"></span>
                        </div>
                    </div>
                </div>
                <div class="col-md-12" id="marketChoice" style="display:none">
                    <hr />
                    <div class="row" style="padding-bottom:10px">
                        <div>
                            <label for="ddlMarketAssign" class="search-ddl-label">Market</label>
                            <select id="ddlMarketAssign" class="search-ddl-select" style="" onchange="loadStationList()"></select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6" id="marketChoice">
                            <div class="assignmentBoxes">

                                <label for="ddlStation" class="search-ddl-label" style="vertical-align: top;">Stations</label>
                                <br /><div><input type="checkbox" id="chkSelectedStations" onclick="selectItems('chkSelectedStations', 'ddlStation')" /><span>&nbsp;Select All</span></div>
                                <select id="ddlStation" class="search-ddl-select" style="width:400px" multiple size="9"></select>
                            </div>
                        </div>
                        <div class="col-md-6 ProductChoices DMAChoices">
                            <div class="assignmentBoxes">
                                <label for="ddlReportDMA" class="search-ddl-label" style="vertical-align: top;">Reports</label><br />
                                <div><input type="checkbox" id="chkSelectedReportsDMA" onclick="selectItems('chkSelectedReportsDMA', 'ddlReportDMA')" /><span>&nbsp;Select All</span></div>

                                <select id="ddlReportDMA" class="search-ddl-select" style="width:400px" multiple size="9"></select>
                            </div>
                        </div>
                        <div class="col-md-6 ProductChoices MRRChoices">
                            <div class="assignmentBoxes">
                                <label for="ddlReport" class="search-ddl-label" style="vertical-align: top;">Reports</label><br />
                                <div><input type="checkbox" id="chkSelectedReports" onclick="selectItems('chkSelectedReports', 'ddlReport')" /><span>&nbsp;Select All</span></div>

                                <select id="ddlReport" class="search-ddl-select" style="width:400px" multiple size="9"></select>
                            </div>
                        </div>
                        <div class="col-md-6 ProductChoices DMXChoices" style="display:none">
                            <div class="assignmentBoxes" style="padding-top:0px;padding-left:0px;padding-right:0px">
                                <h4 class="assignmentBoxHeader">Assignment Actions</h4>
                                <div style="padding-left:10px; padding-right:10px">

                                    <input type="checkbox" id="chkDMXRecipient" onclick="resetRelatedControl(this, 'ddlAccessDMX');" style="margin-right:5px" checked="checked" readonly="readonly" /><label for="chkDMXRecipient">Recipient</label> <br />
                                    <label for="ddlAccessDMX" class="search-ddl-label" style="vertical-align: top; margin-left:10px">Access Levels</label>
                                    <select id="ddlAccessDMX" class="search-ddl-select" style="height: 170px;width: 340px;" size="9"></select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 ProductChoices XRYChoices" style="display:none">
                            <div class="assignmentBoxes" style="padding-top:0px;padding-left:0px;padding-right:0px">
                                <h4 class="assignmentBoxHeader">Assignment Actions</h4>
                                <div style="padding-left:10px; padding-right:10px">
                                    <input type="radio" name="radContactXRY" id="radXRYNotAContact" style="margin-right:5px" checked="checked" value="" /><label for="radXRYNotAContact">No Contact Assignment</label>
                                    &nbsp;&nbsp;
                                    <input type="radio" name="radContactXRY" id="radXRYPrimaryContact" style="margin-right:5px" value="primary" /><label for="radXRYPrimaryContact">Primary Contact</label>
                                    &nbsp;&nbsp;
                                    <input type="radio" name="radContactXRY" id="radXRYSecondaryContact" style="margin-right:5px" value="secondary" /><label for="radXRYSecondaryContact">Secondary Contact</label>
                                    <hr />
                                    <input type="checkbox" id="chkXRYRecipient" onclick="resetRelatedControl(this, 'ddlAccessXRY');" style="margin-right:5px" /><label for="chkXRYRecipient">Recipient</label> <br />
                                    <label for="ddlAccessXRY" class="search-ddl-label" style="vertical-align: top; margin-left:10px">Access Levels</label>
                                    <select id="ddlAccessXRY" class="search-ddl-select" onchange="checkRecipient();" style="height: 170px;width: 340px;" size="9"></select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 ProductChoices TVBChoices" style="display:none">
                            <div class="assignmentBoxes">
                                Time Sales Contact
                                <hr />
                                <input type="radio" name="radContactTVB" id="radTVBNotAContact" style="margin-right:5px" checked="checked" value="" /><label for="radTVBNotAContact">No Contact Assignment</label>
                                <br />
                                <input type="radio" name="radContactTVB" id="radTVBPrimaryContact" style="margin-right:5px" value="primary" /><label for="radTVBPrimaryContact">Primary Contact</label>
                                <br />
                                <input type="radio" name="radContactTVB" id="radTVBSecondaryContact" style="margin-right:5px" value="secondary" /><label for="radTVBSecondaryContact">Secondary Contact</label>
                                <div><b>NOTE:&nbsp;</b>Requires Market / Station selection.</div>

                            </div>
                        </div>
                    </div>
                    <div class="row" style="margin-top:10px;">
                        <div class="col-md-12 ProductChoices MRRChoices">

                            <div class="assignmentBoxes" style="padding-top:0px;padding-left:0px;padding-right:0px;height:auto">
                                <h4 class="assignmentBoxHeader">Assignment Actions</h4>
                                <div style="padding-left:20px; padding-right:20px">
                                    <input type="checkbox" id="chkMRRAdministrator" style="margin-right:5px" /><label for="chkMRRAdministrator">Administrator</label>
                                    <hr />
                                    <input type="radio" name="radContactMRR" id="radMRRNotAContact" style="margin-right:5px" checked="checked" value="" /><label for="radMRRNotAContact">No Contact Assignment</label>
                                    &nbsp;&nbsp;&nbsp;
                                    <input type="radio" name="radContactMRR" id="radMRRPrimaryContact" style="margin-right:5px" value="primary" /><label for="radMRRPrimaryContact">Primary Contact</label>
                                    &nbsp;&nbsp;&nbsp;
                                    <input type="radio" name="radContactMRR" id="radMRRSecondaryContact" style="margin-right:5px" value="secondary" /><label for="radMRRSecondaryContact">Secondary Contact</label>
                                    <hr />
                                    <input type="checkbox" id="chkMRRRecipient" style="margin-right:5px" /><label for="chkMRRRecipient">Recipient</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 ProductChoices TVBChoices" style="display:none">
                            <div class="assignmentBoxes">

                                <input type="checkbox" id="chkTVBRecipient" onclick="resetRelatedControl(this, 'ddlAccessTVB');" style="margin-right:5px" /><label for="chkTVBRecipient">Recipient</label>

                                <hr />

                                <label for="ddlAccessTVB" class="search-ddl-label" style="vertical-align: top; margin-left:10px">Access</label>
                                <select id="ddlAccessTVB" class="search-ddl-select" style="margin-top:10px" size="8"></select>
                                <div><b>NOTE:&nbsp;</b>Requires Market / Station selection.</div>
                            </div>
                        </div>
                        <div class="col-md-6 ProductChoices TVBChoices" style="display:none">
                            <div class="assignmentBoxes">
                                <input type="checkbox" id="chkTVBRepDataContact" onclick="resetRelatedControl(this, 'ddlRepFirms', 'chkSelectedRepFirms');" style="margin-right:5px" /><label for="chkTVBRepDataContact">Rep Data Contact</label>

                                <hr />

                                <div style="margin-left:10px;vertical-align: top; margin-left:20px"><input type="checkbox" id="chkSelectedRepFirms" onclick="selectItems('chkSelectedRepFirms', 'ddlRepFirms')" /><span>&nbsp;Select All</span></div>
                                <label for="ddlRepFirms" class="search-ddl-label" style="vertical-align: top; margin-left:10px">Rep Firms</label>
                                <select id="ddlRepFirms" style="margin-top:10px" class="search-ddl-select" multiple size="8"></select>

                            </div>
                        </div>
                    </div>
                    <div class="row" style="margin-top:10px;">
                        <div class="col-md-6 ProductChoices TVBChoices">

                            <div class="assignmentBoxes" style="padding-top:0px;padding-left:0px;padding-right:0px;height:80px">

                                <div style="padding-left:20px; padding-right:20px;padding-top:15px">
                                    <input type="checkbox" id="chkTVBEstimatedContact" style="margin-right:5px" /><label for="chkTVBEstimatedContact">Estimated Contact</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 ProductChoices TVBChoices">

                            <div class="assignmentBoxes" style="padding-top:0px;padding-left:0px;padding-right:0px;height:auto">

                                <div style="padding-left:20px; padding-right:20px;padding-top:15px">
                                    <input type="checkbox" id="chkTVBAdministrator" style="margin-right:5px" /><label for="chkTVBAdministrator">Administrator</label>
                                </div>
                                <div style="padding-left:20px;"><b>NOTE:&nbsp;</b>Requires Market / Station selection.</div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="row">
                    <div class="col-md-12" style="width:100%;text-align:center">
                        <hr />
                        <input value="Assign" id="btnAssign" class="default-button" type="button" style="display:none" onclick="doAssignment();" />
                        <!--<div class="back-button-div">
                            <input value="Back" onclick="goBackToDashboard();" class="default-button" type="button">
                        </div>-->
                        <hr />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <label for="ddlOwner" class="search-ddl-label">Owner</label>
                        <select id="ddlOwner" class="search-ddl-select" style="" onchange="resetFiltersAndRefreshGrid('owner');"></select>
                    </div>
                    <div class="col-md-3">
                        <label for="ddlMarket" class="search-ddl-label">Market</label>
                        <select id="ddlMarket" class="search-ddl-select" style="" onchange="resetFiltersAndRefreshGrid('market');"></select>
                    </div>
                    <div class="col-md-2">
                        <label for="ddlStationProduct" class="search-ddl-label">Station</label>
                        <select id="ddlStationProduct" class="search-ddl-select" style="" onchange="resetFiltersAndRefreshGrid('station');"></select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12" style="text-align:center">
                        <hr />
                        <strong>Data Level View:</strong> &nbsp;&nbsp;

                        <input type="radio" name="dataView" value="role" onclick="loadPersonnelAssignmentList('dtPersonnelAssignmentList');" />&nbsp;Role&nbsp;&nbsp;
                        <input type="radio" name="dataView" value="market" onclick="loadPersonnelAssignmentList('dtPersonnelAssignmentList');" />&nbsp;Market&nbsp;&nbsp;
                        <input type="radio" name="dataView" value="owner" onclick="loadPersonnelAssignmentList('dtPersonnelAssignmentList');" />&nbsp;Owner&nbsp;&nbsp;
                        <input type="radio" name="dataView" checked="checked" value="station" onclick="loadPersonnelAssignmentList('dtPersonnelAssignmentList');" />&nbsp;Station
                        <div style="display:inline-block" class="MRRChoices ProductChoices">&nbsp;&nbsp;<input type="radio" name="dataView" value="report" onclick="loadPersonnelAssignmentList('dtPersonnelAssignmentList');">&nbsp;Report</div>
                    </div>
                </div>
                <!-- start datatable-->
                <div id="dtPersonnelAssignmentListHolder" class="dataTable-top-margin" style="padding-top:10px; padding-bottom:10px">
                    <table id="dtPersonnelAssignmentList" class="dataTable-border dataTable-headers dataTable-cell-border"></table>
                </div>
                <div id="NotFunctional" style="display:none">
                    <h3>This functionality is not available at this time.</h3>
                </div>
                <!-- end datatable -->

            </div>
        </div>
        <!--<div id="map" data-animate-effect="fadeIn"></div>-->
    </div>

    <div id="corporateAssignDialog" title="" style="display:none; width: 100%;">
        <div id="corpAssignOwnerMarket" style="width:55%; display:inline-block; vertical-align:top;">
            <label for="ddlOwnerCorpAssign">Owner</label><br />
            <select id="ddlOwnerCorpAssign" class="search-ddl-select" style="" onchange="loadMarketListByOwner();"></select>
            <br />
            <label for="ddlMarketCorpAssign">Market</label><br />
            <div><input type="checkbox" id="chkSelectedMarketsCorpAssign" onclick="selectItems('chkSelectedMarketsCorpAssign', 'ddlMarketCorpAssign')" /><span>&nbsp;Select All</span></div>
            <select id="ddlMarketCorpAssign" class="search-ddl-select" style="height:170px;width:340px;" multiple size="8"></select>
        </div>
        <div id="corpAssignAccess" style="width:40%;display:inline-block; vertical-align:top;">
            <div id="corpAssignAccessXRY" style="display:none;">
                <label for="ddlAccessXRYCorpAssign" class="" style="">Access Levels</label>
                <select id="ddlAccessXRYCorpAssign" class="search-ddl-select" style="height:170px;width:340px;" size="9"></select>
            </div>
        </div>
        <div style="margin-top:20px; text-align:center;">
            <input type="button" id="btnCorporateAssign" value="Assign" class="default-button" onclick="doCorporateAssignment();" />
        </div>
        <div style="margin-top:4px; text-align:center">
            <input type="button" id="btnCorporateAssignCancel" value="Cancel" class="default-button" onclick="closeCorporateDialog()" />
        </div>
    </div>



    <!-- jQuery -->
    <script src="/js/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <!-- jQuery Easing -->
    <script src="/js/jquery.easing.1.3.js"></script>
    <!-- Bootstrap -->
    <script src="/js/bootstrap.min.js"></script>
    <!-- Bootbox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
    <!-- Waypoints -->
    <script src="/js/jquery.waypoints.min.js"></script>
    <!-- BlockUI JS -->
    <script src="/js/blockUI.js"></script>
    <!-- Config JS -->
    <script src="/js/config.js"></script>
    <!-- MAIN JS -->
    <script src="/js/main.js"></script>
    <!-- genericReport JS -->
    <script src="/js/genericReport.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.18/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.print.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.colVis.min.js"></script>

    <!--Chosen Dropdown-->
    <script src="/js/chosen.jquery.min.js"></script>

</body>
</html>
<script>

    //global vars

    var productId = "";
    var personnelId = 0;
    var nameOfUser = "";
    var emailAddress = "";

    var columns = [];
    var columnsToDisplay = new Array();
    var columnsToExport = new Array();

    $(document).ready(function () {

        pullQSData();

        setUI();

        buildMainMenu("Personnel");
        buildQuickReports(['personnel', 'owner', 'market', 'station']);
        buildUIDialogs();

        loadProductList();
        getPersonnelWebSetup();
        
        gDataTableDefaultRows = 10;


    });

    function buildUIDialogs() {
        $(function () {
            $("#corporateAssignDialog").dialog({
                autoOpen: false,
                resizable: false,
                width: 850,
                height: 460,
                modal: true,
                title: 'Corporate Assignment',
                create: function (event, ui) {
                    $(event.target).parent().css('position', 'fixed');                   
                }
            });
        });

    }

    function getPageParameters() {

        //these are values past in local storage
        if (getLocalStorage("gPageParameters").length > 0) {
            var pageParameters = $.parseJSON(getLocalStorage("gPageParameters"));
            nameOfUser = pageParameters["personnelName"];
            emailAddress = pageParameters["emailAddress"];
        }

    }



    function scrollToAnchor(aid) {
        var aTag = $("a[name='" + aid + "']");
        $('html,body').animate({ scrollTop: aTag.offset().top }, 'slow');
    }


    //--------------------------------//
    // Assignment start
    //--------------------------------//
    function doAssignment() {

        // validation
        if (areAssignmentsValid() == false)
        {
            return;
        }
        else
        {
            beginAssignmentProcess();
        }


    }

    function beginAssignmentProcess() {

        switch ($("#ddlProduct").val().toString().toLowerCase())
        {

            case "dma":
                return assignDMA();

            case "mrr":
                return assignMRR();

            case "xry":
                return assignXRY();

            case "tvb":
                return assignTVB();

            case "dmx":
                return assignDMX();

            default:
                return false;

        }

    }

    function assignDMA()
    {

        var stationArray = new Array();
        var reportArray = new Array();

        $("#ddlStation option:selected").each(function () {
            var stationObject = {
                "marketId": $("#ddlMarketAssign").val(),
                "stationId": $(this).val(),
                "selected": true
            }
            stationArray.push(stationObject);
        });


        $("#ddlReportDMA option:selected").each(function () {
            var reportObject = {
                "reportId": $(this).val(),
                "selected": true
            }
            reportArray.push(reportObject);
        });

        var inputObject = JSON.stringify({
            "inApiToken": getLocalStorage("APIToken"),
            "inPersonnelId": personnelId,
            "inMarketStationList": stationArray,
            "inReportList": reportArray,
            "inIsRecipient": 'true'
        });

        assignAJAX(inputObject, $("#ddlProduct").val(), $("#ddlProduct").val() + " Assignments Complete");

    }
    function assignTVB() {
        var stationArray = new Array();
        var repFirmArray = new Array();

        $("#ddlStation option:selected").each(function () {
            var stationObject = {
                "stationId": $(this).val(),
                "selected": true
            }
            stationArray.push(stationObject);
        });


        $("#ddlRepFirms option:selected").each(function () {
            var reportObject = {
                "repFirmId": $(this).val(),
                "selected": true
            }
            repFirmArray.push(reportObject);
        });

        var radioValue = $("input[name='radContactTVB']:checked").val();

        // default settings - not a contact
        var isContact = false;
        var isPrimaryContact = false;



        if (radioValue.toLowerCase() == "primary") {
            isContact = true;
            isPrimaryContact = true;
        }
        if (radioValue.toLowerCase() == "secondary") {
            isContact = true;
            isPrimaryContact = false;
        }

        var inputObject = JSON.stringify({
            "inApiToken": getLocalStorage("APIToken"),
            "inPersonnelId": personnelId,
            "inMarketId": $("#ddlMarketAssign").val(),
            "inStationList": stationArray,
            "inRepFirmList": repFirmArray,
            "inAccessLevelId": $("#ddlAccessTVB").val(),
            "inIsTimeSalesContact": isContact,
            "inIsPrimaryTimeSalesContact": isPrimaryContact,
            "inIsRepFirmContact": $("#chkTVBRepDataContact").is(':checked').toString(),
            "inIsEstimateContact": $("#chkTVBEstimatedContact").is(':checked').toString(),
            "inIsAdministrator": $("#chkTVBAdministrator").is(':checked').toString(),
            "inIsRecipient": $("#chkTVBRecipient").is(':checked').toString()

        });

        assignAJAX(inputObject, $("#ddlProduct").val(), $("#ddlProduct").val() + " Assignments Complete");

    }

    function assignDMX()
    {

        var stationArray = new Array();

        var radioValue = $("input[name='radContactDMX']:checked").val();

        $("#ddlStation option:selected").each(function ()
        {
            // recipient only array
            if ($("#chkDMXRecipient").is(':checked') == true)
            {
                var stationObject = {
                    "marketId": $("#ddlMarketAssign").val(),
                    "stationId": $(this).val(),
                    "selected": true
                }
                stationArray.push(stationObject);
            }

         });

        var inputObject = JSON.stringify({
            "inApiToken": getLocalStorage("APIToken"),
            "inPersonnelId": personnelId,
            "inMarketId": $("#ddlMarketAssign").val(),
            "inMarketStationList": stationArray,
            "inAccessLevelId": $("#ddlAccessDMX").val()
        });

 
        assignAJAX(inputObject, $("#ddlProduct").val(), $("#ddlProduct").val() + " Assignments Complete");

    }


    function assignXRY()
    {

        var stationArray = new Array();
        var stationSubmissionArray = new Array();

        var radioValue = $("input[name='radContactXRY']:checked").val();

        // default settings - not a contact
        var isContact = false;
        var isPrimaryContact = false;

        if (radioValue.toLowerCase() == "primary")
        {
            isContact = true;
            isPrimaryContact = true;
        }

        if (radioValue.toLowerCase() == "secondary")
        {
            isContact = true;
            isPrimaryContact = false;
        }

        $("#ddlStation option:selected").each(function ()
        {
            // recipient only array
            if ($("#chkXRYRecipient").is(':checked') == true)
            {
                var stationObject = {
                    "stationId": $(this).val(),
                    "selected": true
                }
                stationArray.push(stationObject);
            }

            // contacts only array
            if (isContact == true)
            {
                var stationObject = {
                    "stationId": $(this).val(),
                    "submissionId": '1',
                    "selected": true
                }
                stationSubmissionArray.push(stationObject);
            }

        });

        var inputObject = JSON.stringify({
            "inApiToken": getLocalStorage("APIToken"),
            "inPersonnelId": personnelId,
            "inMarketId": $("#ddlMarketAssign").val(),
            "inStationList": stationArray,
            "inStationSubmissionList": stationSubmissionArray,
            "inIsContact": isContact.toString(),
            "inIsPrimaryContact": isPrimaryContact.toString(),
            "inIsRecipient": $("#chkXRYRecipient").is(':checked').toString(),
            "inAccessLevelId": $("#ddlAccessXRY").val()
        });

        assignAJAX(inputObject, $("#ddlProduct").val(), $("#ddlProduct").val() + " Assignments Complete");

    }

    function assignMRR() {
        var stationArray = new Array();
        var reportArray = new Array();

        $("#ddlStation option:selected").each(function () {
            var stationObject = {
                "stationId": $(this).val(),
                "selected": true
            }
            stationArray.push(stationObject);
        });


        $("#ddlReport option:selected").each(function () {
            var reportObject = {
                "reportId": $(this).val(),
                "selected": true
            }
            reportArray.push(reportObject);
        });

        var radioValue = $("input[name='radContactMRR']:checked").val();

        // default settings - not a contact
        var isContact = false;
        var isPrimaryContact = false;

        if (radioValue.toLowerCase() == "primary") {
            isContact = true;
            isPrimaryContact = true;
        }
        if (radioValue.toLowerCase() == "secondary") {
            isContact = true;
            isPrimaryContact = false;
        }

        var inputObject = JSON.stringify({
            "inApiToken": getLocalStorage("APIToken"),
            "inPersonnelId": personnelId,
            "inMarketId": $("#ddlMarketAssign").val(),
            "inStationList": stationArray,
            "inReportList": reportArray,
            "inIsContact": isContact.toString(),
            "inIsPrimaryContact": isPrimaryContact.toString(),
            "inIsRecipient": $("#chkMRRRecipient").is(':checked').toString(),
            "inIsAdministrator": $("#chkMRRAdministrator").is(':checked').toString()
        });

        assignAJAX(inputObject, $("#ddlProduct").val(), $("#ddlProduct").val() + " Assignments Complete");

    }
    function assignAJAX(inputObject, product, successMessage)

    {
        // reset product for XRAY.. use XRAY instead of XRAY
        product = (product.toLowerCase() == 'xry' ? 'XRAY' : product.toUpperCase());

        //-------------------
        // API inconsistency accounted for...
        // MRR & XRY named UpdatePersonnel'MarketStation'Assignments
        // others UpdatePersonnelAssignments
        // NOT GOOD
        //-------------------

        var actionAlter = "";

        if (product.toUpperCase() == "MRR" || product.toUpperCase() == "XRAY")
        {
            actionAlter = "MarketStation";
        }

        var url = ServicePrefix + '/api/' + product + '/UpdatePersonnel' + actionAlter + 'Assignments';

        $.ajax({
            url: url,
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: inputObject,
            processData: false,
            success: function (data, textStatus, jQxhr)
            {

                if (data.response.status != "SUCCESS")
                {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                    return;
                }
                //bootbox.alert(successMessage);

                if ($("#spnWebStatus").text() == "")
                {
                    //Ask user if they want to send setup email
                    showSetupEmailDialog(successMessage);

                }
                else
                {
                    bootbox.alert(successMessage);
                    loadPersonnelAssignmentList("dtPersonnelAssignmentList");
                }

            },
            error: function (jqXhr, textStatus, errorThrown)
            {
                MKAErrorMessageRtn(errorThrown);
            }
        });

    }

    function showSetupEmailDialog(successMessage) {

        var strMessage = successMessage + ". This user does not have a web account, send setup email?"

        //ask if they want to send setup email now
        //if yes saml check, continue email
        bootbox.dialog({
            message: strMessage,
            buttons: {
                btnNo: {
                    label: "No",
                    callback: function () {
                        //create pending record.
                        insertPendingNotification();
                    }
                },
                btnYes: {
                    label: "Yes",
                    callback: function () {
                        //SAML check
                        checkSAMLStatus();
                    }
                }
            }
        });

    }

    function areAssignmentsValid()
    {


        switch ($("#ddlProduct").val().toString().toLowerCase()) {

            case "dma":
                return areDMAAssignmentsValid();

            case "mrr":
                return areMRRAssignmentsValid();

            case "dmx":
                return areDMXAssignmentsValid();

            case "xry":
                return areXRYAssignmentsValid();

            case "tvb":
                return areTVBAssignmentsValid();

            default:
                return false;

        }
    }
    function marketSelectionValid()
    {
        // a market must be selected
        if ($("#ddlMarketAssign").val() == "") {
            bootbox.alert("You must select a market to perform the assignment operation.");
            return false;
        }
        else {
            return true;
        }

    }

    function stationSelectionValid()
    {

        // at least 1 station
        var count = $("#ddlStation :selected").length;

        if (count <= 0) {
            bootbox.alert("You must select at least 1 station to perform the assignment operation.");
            return false;
        }
    }

    function areTVBAssignmentsValid()
    {

        // at least 1 action
        if ($("#chkTVBRepDataContact").is(':checked') == false &&
            $("#chkTVBRecipient").is(':checked') == false &&
            $("#chkTVBEstimatedContact").is(':checked') == false &&
            $("#chkTVBAdministrator").is(':checked') == false &&
            $('input[name=radContactTVB]:checked').val() == "") {
            bootbox.alert("You must select at least 1 assignment action to perform the assignment operation.");
            return false;
        }

        // Time Sales Contact
        if ($('input[name=radContactTVB]:checked').val() != "")
        {

            if (marketSelectionValid() == false) {
                return false;
            }

            if (stationSelectionValid() == false) {
                return false;
            }


        }

        // Recipients
        if ($("#chkTVBRecipient").is(':checked'))
        {

            if (marketSelectionValid() == false)
            {
                return false;
            }

            if (stationSelectionValid() == false)
            {
                return false;
            }

            var count = $("#ddlAccessTVB :selected").length;
            if (count <= 0) {
                bootbox.alert("You must select at least 1 Access Level to perform the assignment operation.");
                return false;
            }

        }

        // Administrator
        if ($("#chkTVBAdministrator").is(':checked'))
        {

            if (marketSelectionValid() == false) {
                return false;
            }

            if (stationSelectionValid() == false) {
                return false;
            }


        }


        // Rep Firm Contact
        if ($("#chkTVBRepDataContact").is(':checked'))
        {
            var count = $("#ddlRepFirms :selected").length;

            if (count <= 0) {
                bootbox.alert("You must select at least 1 Rep Firm to perform the assignment operation.");
                return false;
            }
        }

        return true;

    }
    function areMRRAssignmentsValid() {



        // at least 1 action
        if ($("#chkMRRAdministrator").is(':checked') == false &&
            $("#chkMRRRecipient").is(':checked') == false &&
            $('input[name=radContactMRR]:checked').val() == "")
        {
            bootbox.alert("You must select at least 1 assignment action to perform the assignment operation.");
            return false;
        }

        if (marketSelectionValid() == false)
        {
            return false;
        }

        if (stationSelectionValid() == false)
        {
            return false;
        }

        // Recipients
        if ($("#chkMRRRecipient").is(':checked'))
        {
            var count = $("#ddlReport :selected").length;

            if (count <= 0) {
                bootbox.alert("You must select at least 1 report to perform the assignment operation.");
                return false;
            }
        }

        return true;

    }
    function areDMAAssignmentsValid() {

        // Recipients

        var count = $("#ddlReportDMA :selected").length;

        if (count <= 0) {
            bootbox.alert("You must select at least 1 report to perform the assignment operation.");
            return false;
        }

        if (marketSelectionValid() == false) {
            return false;
        }

        if (stationSelectionValid() == false) {
            return false;
        }

        return true;
    }

    function areXRYAssignmentsValid()
    {

        // at least 1 action
        if ($("#chkXRYRecipient").is(':checked') == false && $('input[name=radContactXRY]:checked').val() == "")
        {
            bootbox.alert("You must select at least 1 assignment action to perform the assignment operation.");
            return false;
        }

        if (marketSelectionValid() == false) {
            return false;
        }

        if (stationSelectionValid() == false) {
            return false;
        }

        // Recipients
        if ($("#chkXRYRecipient").is(':checked')) {
            var count = $("#ddlAccessXRY :selected").length;

            if (count <= 0) {
                bootbox.alert("You must select an Access Level to perform the assignment operation.");
                return false;
            }
        }

        return true;

    }

    function areDMXAssignmentsValid()
    {

        // at least 1 action
        if ($("#chkDMXRecipient").is(':checked') == false && $('input[name=radContactDMX]:checked').val() == "")
        {
            bootbox.alert("You must select at least 1 assignment action to perform the assignment operation.");
            return false;
        }

        if (marketSelectionValid() == false)
        {
            return false;
        }

        if (stationSelectionValid() == false)
        {
            return false;
        }

        // Recipients
        if ($("#chkDMXRecipient").is(':checked'))
        {
            var count = $("#ddlAccessDMX :selected").length;

            if (count <= 0)
            {
                bootbox.alert("You must select an Access Level to perform the assignment operation.");
                return false;
            }
        }

        return true;

    }

    function doCorporateAssignment() {

        if (isCorporateAssignmentValid() == false) {
            return false;
        } else {
            beginCorporateAssignment();
        }

    }

    function beginCorporateAssignment() {

        switch ($("#ddlProduct").val().toString().toUpperCase()) {
            case "MRR":
                return assignMRRCorporate();
            case "XRY":
                return assignXRYCorporate();
            default:
                return false;
        }

    }

    function assignMRRCorporate() {

        var marketArray = new Array();

        if ($("#chkSelectedMarketsCorpAssign").is(':checked') == false) {
            $("#ddlMarketCorpAssign option:selected").each(function () {
                marketArray.push($(this).val());
            });
        }

        var url = ServicePrefix + '/api/MRR/InsertMRRCorporateAssignment';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inPersonnelId": personnelId,
                "inOwnerId": $("#ddlOwnerCorpAssign").val(),
                "inMarketList": marketArray
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                assignMRRCorporateSuccess(data, textStatus, jQxhr);

            },
            error: function (jQxhr, textStatus, errorThrown) {
                closeCorporateDialog();
                MKAErrorMessageRtn(errorThrown);
            }

        };

        $.ajax(url, settings);

    }

    function assignMRRCorporateSuccess(data, textStatus, jQxhr) {
        closeCorporateDialog();
        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
        } else {
            bootbox.alert("MRR Corporate Assignment completed successfully.");
        }
        loadPersonnelAssignmentList("dtPersonnelAssignmentList");
    }

    function assignXRYCorporate() {

        var marketArray = new Array();

        if ($("#chkSelectedMarketsCorpAssign").is(':checked') == false) {
            $("#ddlMarketCorpAssign option:selected").each(function () {
                marketArray.push($(this).val());
            });
        }

        var url = ServicePrefix + '/api/XRAY/InsertXRYCorporateAssignment';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inPersonnelId": personnelId,
                "inOwnerId": $("#ddlOwnerCorpAssign").val(),
                "inAccessLevelId": $("#ddlAccessXRYCorpAssign").val(),
                "inMarketList": marketArray
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                assignXRYCorporateSuccess(data, textStatus, jQxhr);
            },
            error: function (jQxhr, textStatus, errorThrown) {
                closeCorporateDialog();
                MKAErrorMessageRtn(errorThrown);
            }
        }
        $.ajax(url, settings);
    }

    function assignXRYCorporateSuccess(data, textStatus, jQxhr) {
        closeCorporateDialog();
        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
        } else {
            bootbox.alert("Corporate Assignment completed successfully.");
        }
        loadPersonnelAssignmentList("dtPersonnelAssignmentList");
    }

    function isCorporateAssignmentValid() {

        if ($("#ddlOwnerCorpAssign").val() == "") {
            corporateDialogErrorMessage("You must select an Owner to perform the assignment operation.");
            return false;
        }

        var marketCount = $("#ddlMarketCorpAssign :selected").length;

        if (marketCount <= 0) {
            corporateDialogErrorMessage("You must select at least 1 market to perform the assignment operation.");
            return false;
        }

        if ($("#ddlProduct").val().toUpperCase() == "XRY") {
            var accessCount = $("#ddlAccessXRYCorpAssign :selected").length;

            if (accessCount <= 0) {
                corporateDialogErrorMessage("You must select an Access Level to perform the assignment operation.");
                return false;
            }
        }
    }

    function corporateDialogErrorMessage(errorMessage) {
        closeCorporateDialog();
        bootbox.alert(errorMessage, function () {
            setTimeout("openCorporateDialog()", 1);
        });
    }


    //--------------------------------//
    // Assignment end
    //--------------------------------//

    function resetFiltersAndRefreshGrid(filter) {
        if (filter.toLowerCase() == "station") {
            $("#ddlMarket").val("");
            $("#ddlOwner").val("");
        }

        if (filter.toLowerCase() == "market") {
            $("#ddlStationProduct").val("");
            $("#ddlOwner").val("");
        }

        if (filter.toLowerCase() == "owner") {
            $("#ddlMarket").val("");
            $("#ddlStationProduct").val("");
        }

        loadPersonnelAssignmentList('dtPersonnelAssignmentList');
    }
    function pullQSData()
    {
        personnelId = getParameterByName("PersonnelId");

        if (personnelId == null)
        {
            window.location = "/admin/login/dashboard.html";
        }

        //gets nameOfUser param from /admin/personnel/personnellist.html page
        getPageParameters();

        productId = getParameterByName("productId");
        if (productId == null)
        {
            productId = "";
        }

        $("#nameOfPersonnel").html("<a onclick='goToPersonnelPage()'>" + nameOfUser.toUpperCase()+ "</a>");
    }

    function goToPersonnelPage()
    {
        document.location = "/admin/personnel/personnel.html?personnelId=" + personnelId;

    }
    function setUI() {
        $("body").on("click", "#clear_search_button",
                     function () {
                         var table = $("#dtPersonnelList").DataTable();
                         table.search('').draw();
                     });
    }

    function selectItems(controlchecked, control) {

        if ($("#" + controlchecked).is(':checked') == false) {
            $("#" + control + " option:selected").each(function () {

                $(this).prop("selected", false);
            });
        }
        else {
            $("#" + control + " option").each(function () {
                $(this).prop("selected", true);
            });
        }
    }
    function uncheckACheckbox(controlToUncheck) {
        $("#" + controlToUncheck).prop("checked", false);
    }

    function uncheckAllCheckboxes() {
        $("#chkSelectedStations").prop("checked", false);
        $("#chkSelectedReportsDMA").prop("checked", false);
        $("#chkSelectedReports").prop("checked", false);
        $("#chkSelectedRepFirms").prop("checked", false);
    }

    function loadScreenForProductChange() {
        // Hide all choices
        $(".ProductChoices").hide();

        // show selected choice
        $("." + $("#ddlProduct").val() + "Choices").show();

        $("#ddlStation").html("");

        uncheckAllCheckboxes();

        // special scenario for MRR
        if ($("#ddlProduct").val().toString().toLowerCase() != 'mrr') {
            if ($("input[name='dataView']:checked").val().toLowerCase() == "report") {
                $('input:radio[name="dataView"]').filter('[value="station"]').attr('checked', true);
            }
        }

        // hide / show assign button
        if ($("#ddlProduct").val() == "") {
            $("#btnAssign").hide();
            $("#marketChoice").hide();
        }
        else {
            $("#btnAssign").show();
            $("#marketChoice").show();
        }

        hideShowCorporateAssign();

        scrollToAnchor('workArea');
        loadMarketList();
        loadOwnerList('ddlOwner');
        loadStationListByProduct();
        loadPersonnelAssignmentList("dtPersonnelAssignmentList");

        loadProductSpecificAssignmentLists();

    }

    function hideShowCorporateAssign() {

        if ($("#ddlProduct").val().toUpperCase() == "MRR" || $("#ddlProduct").val().toUpperCase() == "XRY") {
            $("#btnCorporateAssignInitiate").show();
        } else {
            $("#btnCorporateAssignInitiate").hide();
        }

    }

    function loadPersonnelAssignmentList(dataTable) {
        if ($("#ddlProduct").val() == "MSS") {
            destroyDataTable('dtPersonnelAssignmentList');
            $("#NotFunctional").show();
            return;
        }
        else {
            $("#NotFunctional").hide();
        }

        if (!$("input[name='dataView']:checked").val()) {
            //bootbox.alert("A view must be selected");
            return;
        }
        if ($("#ddlProduct").val() == "") {
            return;
        }

        var apiParameters = new Object();
        var columns = [];
        var apiToken = getLocalStorage("APIToken");

        // need to branch here by product...
        var api = '/api/' + getProductController($("#ddlProduct").val()) + '/Get' + $("#ddlProduct").val() + 'PersonnelAssignmentsBy';
        api = api + $("input[name='dataView']:checked").val();
        api = api + "?inApiToken=" + apiToken;
        api = api + "&inPersonnelId=" + personnelId;

        if ($("#ddlStationProduct").val() != "") {
            api = api + "&inStationId=" + $("#ddlStationProduct").val();
        }
        if ($("#ddlOwner").val() != "") {
            api = api + "&inOwnerId=" + $("#ddlOwner").val();
        }

        if ($("#ddlMarket").val() != "") {
            api = api + "&inMarketId=" + $("#ddlMarket").val();
        }

        //if ($("#ddlProduct").val() != "")
        //{
        //    apiParameters["inProductId"] = $("#ddlProduct").val();
        //}


        $.ajax({
            url: ServicePrefix + api,
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',
            processData: false,
            success: function (data, textStatus, jQxhr) {
                if (data.response.status.toUpperCase() === "SUCCESS") {

                    buildColumnsArray(data, dataTable);

                }
                else {
                    var msg = data.response.errorMessage[0];
                    bootbox.alert(msg, function () { });
                    return false;
                }
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });
    }

    function destroyDataTable(tableToDestroy) {
        if ($.fn.DataTable.isDataTable('#' + tableToDestroy)) {
            var searchTable = $('#' + tableToDestroy).DataTable();
            searchTable.destroy();
            $('#' + tableToDestroy).hide();
        }

        resetDataTableDOM(tableToDestroy, tableToDestroy + "Holder");
    }

    function buildColumnsArray(dataObj, dataTable) {

        columnsToDisplay = new Array();

        if ($("input[name='dataView']:checked").val() == "market") {
            columnsToDisplay.push("Market");

            columnsToDisplay.push("Role");
            columnsToDisplay.push("Station Count");

        }

        if ($("input[name='dataView']:checked").val() == "owner") {

            columnsToDisplay.push("Owner");

            columnsToDisplay.push("Role");
            columnsToDisplay.push("Station Count");

        }


        if ($("input[name='dataView']:checked").val() == "role") {

            columnsToDisplay.push("Role");
            columnsToDisplay.push("Station Count");

        }

        if ($("input[name='dataView']:checked").val() == "station") {
            columnsToDisplay.push("Market");
            columnsToDisplay.push("Owner");
            columnsToDisplay.push("Station");
            columnsToDisplay.push("Role");

            columnsToDisplay.push("Report Count");
        }

        if ($("input[name='dataView']:checked").val() == "report") {
            columnsToDisplay.push("Market");
            columnsToDisplay.push("Owner");
            columnsToDisplay.push("Station");
            columnsToDisplay.push("Role");
            columnsToDisplay.push("Report");
        }
        columnsToExport = new Array();

        if (!dataObj["report"]["rows"]) {
            destroyDataTable("dtPersonnelAssignmentList");
            return;
        }

        if (dataObj["report"]["rows"].length == 0) {
            destroyDataTable("dtPersonnelAssignmentList");
            return;
        }


        $('#' + dataTable).show();
        var data = dataObj["report"]["rows"][0];
        var ctr = -1;
        columns = new Array();
        var bCreateSpecialExportCol = false;

        $.each(data, function (objectName, objectValue) {

            if (columnsToDisplay.includes(objectName)) {
                var className = "";

                if (isNaN(objectValue) == false) {
                    className = "text-align-right";
                }

                if (!objectValue) {
                    className = "text-align-left";
                }

                switch (objectName) {
                    case "Market":
                        {
                            // This is the exportable column
                            columns.push({
                                "title": objectName,
                                "visible": false,
                                "mData": objectName,
                                "orderable": false,
                                "className": className
                            });
                            ctr++;
                            columnsToExport.push(ctr);

                            // This is the displayable column
                            columns.push({
                                "title": objectName,
                                "visible": true,
                                "mRender": function (data, type, row) {

                                    var bTVBRecip = false;

                                    if ($("#ddlProduct").val().toString().toLowerCase() == 'tvb') {
                                        $("#ddlAccessTVB option").each(function () {
                                            if ($(this).text().toString().toLowerCase() == row["Role"].toString().toLowerCase()) {
                                                bTVBRecip = true;
                                            }
                                        });
                                    }

                                    if (($("#ddlProduct").val().toString().toLowerCase() == 'dma') ||
                                        (bTVBRecip == true) ||
                                        ($("#ddlProduct").val().toString().toLowerCase() == 'tvb' && row["Role"].toString().toLowerCase() == "rep firm contact") ||
                                        ($("#ddlProduct").val().toString().toLowerCase() == 'mrr' && row["Role"].toString().toLowerCase() == "recipient") ||
                                        ($("#ddlProduct").val().toString().toLowerCase() == 'xry' && row["Role"].toString().toLowerCase().indexOf('contact') == -1)) {
                                        return row["Market"] + '&nbsp;<a href="#" onclick="buildMarketLevelRemove(\'' + row.MarketId + '\', ' + '\'' + row.Market + '\', ' + '\'' + row.Role + '\'' + ');"><img src="/images/red-x.png" width="20" height="20" title="remove market assignment" alt="remove market assignment"></a>';
                                    }
                                    else {
                                        return row["Market"];
                                    }

                                },
                                "orderable": true,
                                "className": className + " noWrap"
                            });
                            ctr++;

                        }
                        break;
                    case "Report":
                        {
                            // This is the exportable column
                            columns.push({
                                "title": objectName,
                                "visible": false,
                                "mData": objectName,
                                "orderable": false,
                                "className": className
                            });
                            ctr++;
                            columnsToExport.push(ctr);

                            // This is the displayable column
                            columns.push({
                                "title": objectName,
                                "visible": true,
                                "mRender": function (data, type, row) {
                                    if ($("#ddlProduct").val().toString().toLowerCase() == 'mrr' &&
                                            row["Role"].toString().toLowerCase() == "recipient") {
                                        return row["Report"] + '&nbsp;<a href="#" onclick="buildReportLevelRemove(\'' + row.StationId + '\', ' + '\'' + row.Station + ':&nbsp;' + row.Report + '\', ' + '\'' + row.MarketId + '\', ' + '\'' + row.Role + '\',' + '\'' + row.ReportId + '\' ' + ');"><img src="/images/red-x.png" width="20" height="20" title="remove report assignment" alt="remove report assignment"></a>';
                                    }
                                    else {
                                        return row["Report"]
                                    }
                                },
                                "orderable": true,
                                "className": className + " noWrap"
                            });
                            ctr++;

                        }
                        break;
                    case "Station":
                        {
                            // This is the exportable column
                            columns.push({
                                "title": objectName,
                                "visible": false,
                                "mData": objectName,
                                "orderable": false,
                                "className": className
                            });
                            ctr++;
                            columnsToExport.push(ctr);

                            // This is the displayable column
                            columns.push({
                                "title": objectName,
                                "visible": true,
                                "mRender": function (data, type, row) {

                                    if (row["Station"] == "N/A") {
                                        return row["Station"];
                                    }
                                    else {
                                        return row["Station"] + '&nbsp;<a href="#" onclick="buildStationLevelRemove(\'' + row.StationId + '\', ' + '\'' + row.Station + '\', ' + '\'' + row.MarketId + '\', ' + '\'' + row.Role + '\'' + ');"><img src="/images/red-x.png" width="20" height="20" title="remove station assignment" alt="remove station assignment"></a>';
                                    }
                                },
                                "orderable": true,
                                "className": className + " noWrap"
                            });
                            ctr++;

                        }
                        break;
                    case "Role":
                        bCreateSpecialExportCol = false;
                        // This is the displayable column
                        columns.push({
                            "title": objectName,
                            "visible": true,
                            "mRender": function (data, type, row) {

                                if ($("#ddlProduct").val().toString().toLowerCase() == 'tvb' && row["Role"].toString().toLowerCase() == "estimated contact") {
                                    bCreateSpecialExportCol = true;
                                    return row["Role"] + '&nbsp;<a href="#" onclick="buildMarketLevelRemove(\'' + row.MarketId + '\', ' + '\'' + row.Role + '\', ' + '\'' + row.Role + '\'' + ');"><img src="/images/red-x.png" width="20" height="20" title="remove role assignment" alt="remove role assignment"></a>';
                                }
                                else {
                                    bCreateSpecialExportCol = false;
                                    return row["Role"];
                                }

                            },
                            "orderable": true,
                            "className": className + " noWrap"
                        });
                        ctr++;

                        // This is the exportable column
                        if (bCreateSpecialExportCol == true) {

                            columns.push({
                                "title": objectName,
                                "visible": false,
                                "mData": objectName,
                                "orderable": false,
                                "className": className
                            });
                            ctr++;
                        }
                        columnsToExport.push(ctr);

                        break;

                    default:
                        ctr++;
                        columnsToExport.push(ctr);
                        columns.push({
                            "title": objectName,
                            "visible": true,
                            "mData": objectName,
                            "orderable": true,
                            "className": className
                        });

                }
                //ctr++;
                //columnsToExport.push(ctr);

                //columns.push({
                //    "title": objectName,
                //    "visible": true,
                //    "mData": objectName,
                //    "orderable": true,
                //    "className": className
                //});
            }
        });
        //console.log(columns);
        //$('#dtPersonnelAssignmentList').show();
        loadResults(dataObj, columns, dataTable);
    }

    function IsThisATVBRecipient(label) {
        var bReturn = false;

        $("#ddlAccessTVB option").each(function () {

            if ($(this).text().toString().toLowerCase() == label.toLowerCase()) {

                bReturn = true;
            }
        });

        return bReturn;

    }
    function getProductController(product) {
        if (product.toLowerCase() == 'xry') {
            return 'xray';
        }
        else {
            return product;
        }
    }
    function loadResults(data, columns, dataTable) {
        //data is the data from the ajax call
        //columns is the array that was built previously

        //assigns the data from the ajax call
        var results = data["report"]["rows"];




        //if the datatable already exists need to destroy it before building it
        //again with new results from the search.
        //if you try to destroy before it is a datatable, an error will occur.
        //this code will only destroy it if the table is a datatable.

        //The destroy function only destroys the data in the datatable.
        //However, the columns need to be same if repopulating the table.
        //if ($.fn.DataTable.isDataTable('#' + dataTable)) {
        //    searchTable = $('#' + dataTable).DataTable();
        //    searchTable.destroy();
        //}

        destroyDataTable(dataTable);

        //this code rebuilds the datatable with the updated data from the search
        //or initial load.

        //////If you want to repopulate the datatable with new columns and data,
        //////you need to remove the datatable from the DOM.
        //////The .remove function will remove it.
        ////$("#" + dataTable).remove();

        //////Once you remove the datatable from the DOM, you need add the HTML back to the page.
        //////I added a name to the DIV that has the table html. I used the datatable name plus added "Holder".
        //////The following coding adds the table back.
        ////$("#"+ dataTable +"Holder").html('<table id="' + dataTable +'" class="dataTable-border dataTable-headers dataTable-cell-border"></table>');

        //creating a variable that will used for datatable functions later
        var searchTable;
        //once the remove and the html is added back, you can reload the table.
        //the new columns and data should now populate properly in the datatable.
        searchTable = $('#' + dataTable).DataTable({
            "dom": "Blfrtip",
            "pageLength": gDataTableDefaultRows,
            "order": [],
            "data": results,
            "columns": columns,
            "select": true,
            language: {
                search: "Filter Results:"
            },
            "buttons": [
               //{
               //    extend: 'csv',
               //    exportOptions: {
               //        columns: columnsToExport
               //    }
               //},
               {
                   extend: 'excel',
                   title: "Personnel Assignments",
                   exportOptions: {
                       columns: columnsToExport
                   }
               },
               //{
               //    extend: 'pdf',
               //    title: reportObject.reportTitle,
               //    exportOptions: {
               //        columns: columnsToExport
               //     }
               //},
               {
                   extend: 'print',
                   title: "Personnel Assignments",
                   exportOptions: {
                       columns: columnsToExport

                   }
               }
            ],
        });

    }
    function resetRelatedControl(masterControl, controlToChange, relatedCheckbox) {

        $('#' + controlToChange + ' option').each(function () {

            this.selected = false;

        });

        if (!relatedCheckbox == false) {
            uncheckACheckbox(relatedCheckbox);
        }

    }
    function loadStationList() {
        var str = '';
        var controlToLoad = "#ddlStation";

        $(controlToLoad).html("");
        uncheckAllCheckboxes();

        // no market select
        if ($("#ddlMarketAssign").val() == "") {
            $("#ddlReport").html("");
            $("#ddlReportDMA").html("");
            $("#ddlStation").html("");

            return;
        }

        var apiParameters = new Object();
        var apiToken = getLocalStorage("APIToken");

        apiParameters["inApiToken"] = apiToken;
        apiParameters["inMarketId"] = $("#ddlMarketAssign").val();
        apiParameters["inPersonnelId"] = personnelId;

        if ($("#ddlProduct").val() != "") {
            apiParameters["inProductId"] = $("#ddlProduct").val();
        }


        $.ajax({
            url: ServicePrefix + '/api/Station/GetStationListByMarketPersonnel',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify(apiParameters),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {

                        str = '';
                        var obj = data.report.rows[index];

                        str = str + '<option value="' + obj.reid + '">';
                        str = str + (obj.fullName).toUpperCase() + ' (' + obj.reid + ')';
                        str = str + '</option>';

                        $(controlToLoad).append(str);

                    });



                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });

        loadProductSpecificAssignmentLists();

    }

    function loadProductSpecificAssignmentLists() {
        if ($("#ddlProduct").val().toString().toLowerCase() == 'mrr') {
            loadReportList();
        }

        if ($("#ddlProduct").val().toString().toLowerCase() == 'xry') {
            loadXrayAccessLevelList("ddlAccessXRY");
        }

        if ($("#ddlProduct").val().toString().toLowerCase() == 'dmx') {
            loadXrayAccessLevelList("ddlAccessDMX");
        }

        if ($("#ddlProduct").val().toString().toLowerCase() == 'dma') {
            loadReportListDMA();

        }

        if ($("#ddlProduct").val().toString().toLowerCase() == 'tvb') {
            loadRepFirmList();
            loadTVBAccessLevelList();
        }
    }

    function loadXrayAccessLevelList(control) {
        var str = '';
        var controlToLoad = "#" + control;

        $(controlToLoad).html("");
        //str = str + '<option value="">';
        //str = str + '-- Select an Access Level';
        //str = str + '</option>';
        //$(controlToLoad).append(str);

        var apiParameters = new Object();
        var apiToken = getLocalStorage("APIToken");

        apiParameters["inApiToken"] = apiToken;
        apiParameters["inMarketId"] = $("#ddlMarket").val();


        var api =

        $.ajax({
            url: ServicePrefix + '/api/XRAY/GetXRYAccessLevelList?inApiToken=' + apiToken,
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {

                        str = '';
                        var obj = data.report.rows[index];

                        str = str + '<option value="' + obj.AccessLevelId + '">';
                        str = str + (obj['Access Description']);
                        str = str + '</option>';

                        $(controlToLoad).append(str);

                    });



                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });


    }

    function loadReportListDMA() {
        var str = '';
        var controlToLoad = "#ddlReportDMA";

        $(controlToLoad).html("");
        //str = str + '<option value="">';
        //str = str + '-- Select a Market';
        //str = str + '</option>';
        //$(controlToLoad).append(str);

        var apiParameters = new Object();
        var apiToken = getLocalStorage("APIToken");

        apiParameters["inApiToken"] = apiToken;

        $.ajax({
            url: ServicePrefix + '/api/DMA/GetReportList',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify(apiParameters),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {

                        str = '';
                        var obj = data.report.rows[index];

                        str = str + '<option value="' + obj.reportId + '">';
                        str = str + (obj.reportTitle);
                        str = str + '</option>';

                        $(controlToLoad).append(str);

                    });



                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });


    }
    function loadReportList() {
        var str = '';
        var controlToLoad = "#ddlReport";

        $(controlToLoad).html("");
        //str = str + '<option value="">';
        //str = str + '-- Select a Market';
        //str = str + '</option>';
        //$(controlToLoad).append(str);

        if ($("#ddlMarketAssign").val() == "") {
            return;
        }

        var apiParameters = new Object();
        var apiToken = getLocalStorage("APIToken");

        apiParameters["inApiToken"] = apiToken;
        apiParameters["inMarketId"] = $("#ddlMarketAssign").val();




        $.ajax({
            url: ServicePrefix + '/api/MRR/GetMarketReportList',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify(apiParameters),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {

                        str = '';
                        var obj = data.report.rows[index];

                        if (obj.selected == true) {
                            str = str + '<option value="' + obj.reportId + '">';
                            str = str + (obj.reportTitle);
                            str = str + '</option>';

                            $(controlToLoad).append(str);
                        }
                    });



                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });


    }
    function loadTVBAccessLevelList() {

        var str = '';
        var controlToLoad = "#ddlAccessTVB";

        $(controlToLoad).html("");
        //str = str + '<option value="">';
        //str = str + '-- Select an Access Level';
        //str = str + '</option>';

        //$(controlToLoad).append(str);


        $.ajax({
            url: ServicePrefix + '/api/TVB/GetAccessLevelList?inAPIToken=' + getLocalStorage("APIToken"),
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {

                        str = '';
                        var obj = data.report.rows[index];

                        str = str + '<option value="' + obj.accessLevelId + '">';
                        str = str + obj.accessLevelName;
                        str = str + '</option>';

                        $(controlToLoad).append(str);

                    });



                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });


    }
    function loadRepFirmList() {

        var str = '';
        var controlToLoad = "#ddlRepFirms";

        $(controlToLoad).html("");
        //str = str + '<option value="">';
        //str = str + '-- Select a Rep Firm';
        //str = str + '</option>';

        $(controlToLoad).append(str);


        $.ajax({
            url: ServicePrefix + '/api/RepFirm/GetRepFirmList',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken")
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {

                        str = '';
                        var obj = data.report.rows[index];

                        str = str + '<option value="' + obj.repFirmId + '">';
                        str = str + obj.repFirmName;
                        str = str + '</option>';

                        $(controlToLoad).append(str);

                    });



                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });


    }
    function loadMarketList() {

        var str = '';
        var controlToLoad = "#ddlMarket";

        $(controlToLoad).html("");
        str = str + '<option value="">';
        str = str + '-- Select a Market';
        str = str + '</option>';

        $("#ddlMarketAssign").html("");

        $(controlToLoad).append(str);
        $("#ddlMarketAssign").append(str);

        $.ajax({
            url: ServicePrefix + '/api/Market/GetMarketListByPersonnel',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inPersonnelId": personnelId,
                "inProductId": $("#ddlProduct").val(),
                "inActiveOnly": true
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {

                        str = '';
                        var obj = data.report.rows[index];

                        str = str + '<option value="' + obj.marketId + '">';
                        str = str + obj.marketName + ' (' + obj.marketId + ')';
                        str = str + '</option>';

                        $(controlToLoad).append(str);
                        $("#ddlMarketAssign").append(str);

                    });

                    convertToChosenSelect("ddlMarket", gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);
                    convertToChosenSelect("ddlMarketAssign", gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);

                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });


    }
    function loadProductList() {

        var str = '';

        $("#ddlProduct").html("");
        str = str + '<option value="">';
        str = str + '-- Select a Product';
        str = str + '</option>';

        $("#ddlProduct").append(str);

        var bProductSelected = false;

        $.ajax({
            url: ServicePrefix + '/api/Personnel/GetPersonnelProductList',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inPersonnelId": personnelId
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {

                        str = '';
                        var obj = data.report.rows[index];
                        if (obj.active == true) {
                            str = str + '<option value="' + obj.productId.toUpperCase();
                            str = str + '"';

                            if (productId.toUpperCase() == obj.productId.toUpperCase())
                            {
                                bProductSelected = true;
                                str = str + " selected ";
                            }

                            str = str + '">';


                            str = str + obj.productId.toUpperCase();
                            str = str + '</option>';
                        }
                        $("#ddlProduct").append(str);

                    });

                    convertToChosenSelect("ddlProduct", gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);

                    if (bProductSelected == true)
                    {
                        loadScreenForProductChange();
                    }
                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });


    }
    function loadOwnerList(control) {

        var str = '';

        if ($("#ddlProduct").val() == "") {
            return;
        }


        $("#" + control).html("");
        str = str + '<option value="">';
        str = str + '-- Select an Owner';
        str = str + '</option>';

        $("#" + control).append(str);

        $.ajax({
            url: ServicePrefix + '/api/Personnel/GetPersonnelAssignedOwnershipList',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inPersonnelId": personnelId,
                "inProduct": $("#ddlProduct").val()
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {

                        str = '';
                        var obj = data.report.rows[index];

                        str = str + '<option value="' + obj.ownerId + '">';
                        str = str + obj.ownerName;
                        str = str + '</option>';

                        $("#" + control).append(str);

                    });

                    convertToChosenSelect(control, gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);

                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });


    }
    function loadStationListByProduct() {

        var str = '';

        if ($("#ddlProduct").val() == "") {
            return;
        }

        $("#ddlStationProduct").html("");
        str = str + '<option value="">';
        str = str + '-- Select a Station';
        str = str + '</option>';

        $("#ddlStationProduct").append(str);

        $.ajax({
            url: ServicePrefix + '/api/Personnel/GetPersonnelAssignedStationListByProduct',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inPersonnelId": personnelId,
                "inProduct": $("#ddlProduct").val()
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {

                        str = '';
                        var obj = data.report.rows[index];

                        str = str + '<option value="' + obj["Station Id"] + '">';
                        str = str + obj.Station + ' (' + obj["Station Id"] + ')';
                        str = str + '</option>';

                        $("#ddlStationProduct").append(str);

                    });

                    convertToChosenSelect("ddlStationProduct", gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);

                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });


    }



    function loadLastSearch() {

        var search = getParameterByName("search");

        if (!search == false) {
            if (search.length > 0) {
                var sArray = new Array();
                sArray = search.split("|");

                $("#ddlOwner").val(sArray[0]);
                $("#searchText").val(sArray[1].toString());
                $("#searchText2").val(sArray[2].toString());

                getPersonnelList();
            }
        }

    }
    function buildMarketLevelRemove(marketId, descriptor, role, reportId) {
        buildStationLevelRemove(null, descriptor, marketId, role, -1);
    }
    function buildReportLevelRemove(stationId, descriptor, marketId, role, reportId) {
        buildStationLevelRemove(stationId, descriptor, marketId, role, reportId);
    }

    function buildStationLevelRemove(stationId, descriptor, marketId, role, reportId) {

        if (!reportId) {
            reportId = -1;
        }

        //if (!stationId) {
        //    stationId = -1;
        //}

        if (stationId == 'CLUSTER') {
            stationId = -1;
        }

        switch ($("#ddlProduct").val().toString().toUpperCase()) {

            case "DMA":
                var inputObject = buildDMARemoveObject(stationId, marketId, role, reportId);
                break;

            case "DMX":
                var inputObject = buildDMXRemoveObject(stationId, marketId, role, reportId);
                break;

            case "MRR":
                var inputObject = buildMRRRemoveObject(stationId, marketId, role, reportId);
                break;

            case "XRY":
                var inputObject = buildXRYRemoveObject(stationId, marketId, role, reportId);
                break;

            case "TVB":
                var inputObject = buildTVBRemoveObject(stationId, marketId, role, reportId);
                break;

            default:
                return false;

        }

        var msg = "Are you sure you want to remove " + role + " assignments for " + descriptor;

        bootbox.confirm(msg + "?", function (result) {
            if (result == false) {
                return;
            }
            else {
                assignAJAX(inputObject, $("#ddlProduct").val(), $("#ddlProduct").val() + " Assignments Removed");
            }


        });
    }
    function buildMRRRemoveObject(stationId, marketId, role, reportId) {

        var stationArray = new Array();
        var reportArray = new Array();

        var stationObject = {
            "stationId": stationId,
            "selected": true
        }
        stationArray.push(stationObject);

        var reportObject = {
            "reportId": reportId,
            "selected": true
        }
        reportArray.push(reportObject);


        var radioValue = $("input[name='radContactMRR']:checked").val();

        // default settings - not a contact
        var isContact = false;
        var isPrimaryContact = false;
        var isAdministrator = false;
        var isRecipient = false;


        if (role.toLowerCase().toString().indexOf("contact") > -1) {
            isContact = true;
        }
        if (role.toLowerCase() == "recipient") {
            isRecipient = true;
        }
        if (role.toLowerCase() == "manager" || role.toLowerCase() == "administrator") {
            isAdministrator = true;
        }

        var inputObject = JSON.stringify({
            "inApiToken": getLocalStorage("APIToken"),
            "inPersonnelId": personnelId,
            "inMarketId": marketId,
            "inStationList": stationArray,
            "inReportList": reportArray,
            "inIsContact": isContact.toString(),
            "inIsPrimaryContact": isContact.toString(),
            "inIsRecipient": isRecipient.toString(),
            "inIsAdministrator": isAdministrator.toString(),
            "inDeleteOperation": true
        });

        return inputObject;
    }

    function buildDMARemoveObject(stationId, marketId, role, reportId) {
        var stationArray = new Array();
        var reportArray = new Array();

        var stationObject = {
            "marketId": marketId,
            "stationId": stationId,
            "selected": true
        }
        stationArray.push(stationObject);

        var reportObject = {
            "reportId": reportId,
            "selected": true
        }
        reportArray.push(reportObject);


        var inputObject = JSON.stringify({
            "inApiToken": getLocalStorage("APIToken"),
            "inPersonnelId": personnelId,
            "inMarketStationList": stationArray,
            "inReportList": reportArray,
            "inDeleteOperation": true
        });

        return inputObject;
    }

    function buildDMXRemoveObject(stationId, marketId, role, reportId)
    {
        var stationArray = new Array();
        var reportArray = new Array();

        var stationObject = {
            "marketId": marketId,
            "stationId": stationId,
            "selected": true
        }
        stationArray.push(stationObject);

        var reportObject = {
            "reportId": reportId,
            "selected": true
        }
        reportArray.push(reportObject);


        var inputObject = JSON.stringify({
            "inApiToken": getLocalStorage("APIToken"),
            "inPersonnelId": personnelId,
            "inMarketStationList": stationArray,
            "inReportList": reportArray,
            "inDeleteOperation": true
        });

        return inputObject;
    }


    function buildXRYRemoveObject(stationId, marketId, role, accessId) {
        var isContact = false;
        var isPrimaryContact = false;
        var isRecipient = false;


        if (role.toLowerCase().toString().indexOf("contact") > -1) {
            isContact = true;
        }
        else {
            isRecipient = true;
        }

        var stationArray = new Array();
        var stationSubmissionArray = new Array();

        var stationObject = {
            "stationId": stationId,
            "selected": true
        }
        stationArray.push(stationObject);

        var submissionObject = {
            "stationId": stationId,
            "submissionId": 1,
            "selected": true
        }
        stationSubmissionArray.push(submissionObject);


        var inputObject = JSON.stringify({
            "inApiToken": getLocalStorage("APIToken"),
            "inPersonnelId": personnelId,
            "inMarketId": marketId,
            "inStationList": stationArray,
            "inStationSubmissionList": stationSubmissionArray,
            "inIsContact": isContact.toString(),
            "inIsPrimaryContact": isContact.toString(),
            "inIsRecipient": isRecipient,
            "inAccessLevelId": accessId,
            "inDeleteOperation": true
        });

        return inputObject;

    }

    function buildTVBRemoveObject(stationId, marketId, role, accessId) {
        var repFirmArray = new Array();
        var stationArray = new Array();

        var isContact = false;
        var isRecipient = false;
        var isAdministrator = false;
        var isEstimatedContact = false;
        var isRepFirmContact = false;

        if (role.toString().toLowerCase() == "secondary contact" || role.toString().toLowerCase() == "primary contact") {
            isContact = true;
        }

        isRecipient = IsThisATVBRecipient(role.toString().toLowerCase());

        if (role.toString().toLowerCase() == 'manager') {
            isAdministrator = true;
        }

        if (role.toString().toLowerCase() == 'estimated contact') {
            isEstimatedContact = true;
        }

        if (role.toString().toLowerCase() == "rep firm contact") {
            isRepFirmContact = true;

        }

        var stationArray = new Array();
        var stationSubmissionArray = new Array();

        var stationObject = {
            "stationId": stationId,
            "selected": true
        }
        stationArray.push(stationObject);

        var repFirmObject = {
            "repFirmId": marketId,
            "selected": true
        }
        repFirmArray.push(repFirmObject);

        var inputObject = JSON.stringify({
            "inApiToken": getLocalStorage("APIToken"),
            "inPersonnelId": personnelId,
            "inMarketId": marketId,
            "inStationList": stationArray,
            "inRepFirmList": repFirmArray,
            "inAccessLevelId": accessId,
            "inIsTimeSalesContact": isContact,
            "inIsPrimaryTimeSalesContact": isContact,
            "inIsRepFirmContact": isRepFirmContact.toString(),
            "inIsEstimateContact": isEstimatedContact.toString(),
            "inIsAdministrator": isAdministrator.toString(),
            "inIsRecipient": isRecipient.toString(),
            "inDeleteOperation": true
        });


        return inputObject;

    }

    function corporateAssignInitiate() {

        loadOwnerList("ddlOwnerCorpAssign");
        $("#ddlMarketCorpAssign").html("");
        $("#chkSelectedMarketsCorpAssign").prop("checked", false);

        if ($("#ddlProduct").val().toUpperCase() == "MRR") {
            $("#corpAssignAccessXRY").hide();
        }

        if ($("#ddlProduct").val().toUpperCase() == "XRY") {
            $("#corpAssignAccessXRY").show();
            loadXrayAccessLevelList("ddlAccessXRYCorpAssign");
        }

        $("#corporateAssignDialog").dialog("open");

    }

    function loadMarketListByOwner() {

        if ($("#ddlOwnerCorpAssign").val() == "") {
            return;
        }

        var url = ServicePrefix + '/api/Market/GetMarketListByOwnerProduct';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inOwnerId": $("#ddlOwnerCorpAssign").val(),
                "inProductId": $("#ddlProduct").val()
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                loadMarketListByOwnerSuccess(data, textStatus, jQxhr);
            },
            error: function (jQxhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);
            }
        };

        $.ajax(url, settings);

    }

    function loadMarketListByOwnerSuccess(data, textStatus, jQxhr) {
        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage);
        } else {
            var str = '';

            $.each(data.report.rows, function (index) {
                str = str + '<option value="' + data.report.rows[index].MarketId + '">' + data.report.rows[index].Market + '</option>';
            });

            $("#ddlMarketCorpAssign").html(str);

        }
    }

    function closeCorporateDialog() {
        $("#corporateAssignDialog").dialog("close");
    }

    function openCorporateDialog() {
        $("#corporateAssignDialog").dialog("open");
    }

    function userExitedDialog() {
        console.log("user has exited dialog.");
    }

    function getPersonnelWebSetup() {

        var url = ServicePrefix + '/api/Personnel/GetPersonnelWebSetupStatus';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inPersonnelId": personnelId
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                getPersonnelWebSetupSuccess(data, textStatus, jQxhr);
            },
            error: function (jQxhr, textStatus, errorThrown) {
                genericAjaxError(jQxhr, textStatus, errorThrown);
            }
        }

        $.ajax(url, settings);

    }

    function getPersonnelWebSetupSuccess(data, textStatus, jQxhr) {

        if (data.response.status != "SUCCESS") {
            bootbox.alert('Process Failed.\n\r\n\r' + data.response.errorMessage[0] + '.\n\r\n\rDevelopment has been notified and is looking into this issue.', function () {

            });
        } else {

            $.each(data.report.rows, function (index) {
                var obj = data.report.rows[index];
                var status = -1;


                if (obj.status != null) {
                    if (obj.status == 0) {
                        status = 0;
                    }
                    if (obj.status == 2) {
                        status = 2;
                    }
                }
                if (obj.notificationStatus != null && obj.notificationStatus == 1) {
                    status = 1
                }

                if (status == 0) {
                    $("#spnWebStatus").text("WEB User");
                }
                if (status == 2) {
                    $("#spnWebStatus").text("Notified");
                }
                if (status == 1) {
                    $("#spnWebStatus").text("Pending");
                }
                             
            });
        }
    }


    function checkSAMLStatus() {

        var url = ServicePrefix + '/api/Personnel/GetPersonnelSAMLStatus';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inPersonnelId": personnelId
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                checkSAMLStatusSuccess(data, textStatus, jQxhr);
            },
            error: function (jQxhr, textStatus, errorThrown) {
                genericAjaxError(jQxhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);
    }

    function checkSAMLStatusSuccess(data, textStatus, jQxhr) {
        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
        } else {

            switch (data.report.rows[0].passwordOrSAML) {
                case 1:
                    //SAML ONLY
                    showSAMLOnlyMessage();
                    break;
                case 2:
                    //SAML or Regular
                    showSAMLOrRegularMessage();
                    break;
                case 0:
                    //Regular Only
                    sendInitialSetupEmail(false);
                    break;
                default:
                    bootbox.alert("There was an issue when checking the SAML status of this user.");
                    break;
            }

        }
    }

    function showSAMLOnlyMessage(personnelId, email, token) {
        var strMessage = 'This personnel is a SAML only user. If this is wrong, please click cancel and put in a request to change this. If this is correct, click Continue to send the SAML version of this email.';

        bootbox.dialog({
            message: strMessage,
            buttons: {
                btnCancel: {
                    label: "Cancel",
                    callback: function () {
                        bootbox.alert("Process has been canceled. No emails have been sent.", function () {
                            //Process cancelled, pending record created.
                            insertPendingNotification();
                        });             
                    }
                },
                btnContinue: {
                    label: "Continue",
                    callback: function () {
                        sendInitialSetupEmail(true);
                    }
                }
            }
        });

    }


    function showSAMLOrRegularMessage() {
        var strMessage = 'This user is SAML compatible, please select either the SAML version or Regular version for this email.';

        bootbox.dialog({
            message: strMessage,
            buttons: {
                btnCancel: {
                    label: "Cancel",
                    callback: function () {
                        bootbox.alert("Process has been canceled. No emails have been sent.", function () {
                            //Process cancelled, pending record created.
                            insertPendingNotification();
                        });

                    }
                },
                btnSAMLEmail: {
                    label: "SAML",
                    callback: function () {
                        sendInitialSetupEmail(true);
                    }
                },
                btnRegularEmail: {
                    label: "Regular",
                    callback: function () {
                        sendInitialSetupEmail(false);
                    }
                }
            }
        });

    }



    function sendInitialSetupEmail(isSAMLEmail) {

        if (emailAddress == "" || emailAddress == null) {
            //throw error
            bootbox.alert("Email Address missing - Email could not be sent.", function () {
                return;
            });
        }
        var url = ServicePrefix + '/api/Notification/InitiateWebNotification';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inPersonnelID": personnelId,
                "inNotificationToken": "InitialPersonnelClientSetup",
                "inEmail": emailAddress,
                "inSAMLUser": isSAMLEmail
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                sendInitialSetupEmailSuccess(data, textStatus, jQxhr);
            },
            error: function (jQxhr, textStatus, errorThrown) {
                genericAjaxError(jQxhr, textStatus, errorThrown);
            }
        };
        
        $.ajax(url, settings);

    }

    function sendInitialSetupEmailSuccess(data, textStatus, jQxhr) {
        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
        } else {
            $.each(data.report.rows, function (index) {

                bootbox.alert("Email has been sent.", function () {
                    loadPersonnelAssignmentList("dtPersonnelAssignmentList");
                    getPersonnelWebSetup();
                });


            });
        }

    }

    function insertPendingNotification() {

        var url = ServicePrefix + '/api/Personnel/InsertPersonnelNotification';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inPersonnelId": personnelId,
                "inActionToken": "InitialPersonnelClientSetup"
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                insertPendingNotificationSuccess(data, textStatus, jQxhr);
            },
            error: function (jQxhr, textStatus, errorThrown) {
                genericAjaxError(jQxhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);

    }

    function insertPendingNotificationSuccess(data, textStatus, jQxhr) {
        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
        } else {

            bootbox.alert("Pending record has been created for this user.", function () {
                loadPersonnelAssignmentList("dtPersonnelAssignmentList");
                getPersonnelWebSetup();

            });

        }
    }

    function checkRecipient()
    {
        $("#chkXRYRecipient").prop("checked", true);
    }

</script>

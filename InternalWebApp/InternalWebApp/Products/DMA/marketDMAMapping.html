<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>MKA Internal Media Site</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Facebook and Twitter integration -->
    <meta property="og:title" content="" />
    <meta property="og:image" content="" />
    <meta property="og:url" content="" />
    <meta property="og:site_name" content="" />
    <meta property="og:description" content="" />
    <meta name="twitter:title" content="" />
    <meta name="twitter:image" content="" />
    <meta name="twitter:url" content="" />
    <meta name="twitter:card" content="" />
    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <link rel="shortcut icon" href="favicon.ico">
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,300,700,900' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css?family=Playfair+Display:400,700" rel="stylesheet">
    <!-- Animate.css -->
    <link rel="stylesheet" href="/css/animate.css">
    <!-- Icomoon Icon Fonts-->
    <link rel="stylesheet" href="/css/icomoon.css">
    <!-- Simple Line Icons -->
    <link rel="stylesheet" href="/css/simple-line-icons.css">
    <!-- Bootstrap  -->
    <link rel="stylesheet" href="/css/bootstrap.css">
    <!-- Theme style  -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- Modernizr JS -->
    <script src="/js/modernizr-2.6.2.min.js"></script>
    <!-- FOR IE9 below -->
    <!--[if lt IE 9]>
    <script src="js/respond.min.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.18/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.2/css/responsive.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.5.2/css/buttons.dataTables.min.css" />

</head>
<body>
    <div id="fh5co-page">
        <header id="fh5co-header" role="banner">
            <div class="container">
                <div class="header-inner" id="menu"></div>
            </div>
        </header>
        <div id="fh5co-contact-section" class="contact-section">
            <div class="container">

                <div class="row">
                    <div class="col-md-6 col-md-offset-3 text-center fh5co-heading">
                        <h2>DMA Market Category Mapping</h2>
                    </div>
                </div>

                <div class="row input-row">
                    <div class="col-md-3 text-align-left">
                        <label for="txtMarketName">Market Name</label>
                    </div>
                    <div class="col-md-9 text-align-left">
                        <input type="hidden" id="txtParentMarketId" value="" />
                        <input type="hidden" id="txtMarketId" value="" />
                        <input type="text" class="field-width-325" id="txtMarketName" value="" maxlength="50" disabled="disabled" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <hr />
                    </div>
                </div>

                <div class="row">
                    <div class="text-center">
                        <h3>Category Assignments</h3>
                    </div>
                </div>

                <div class="row input-row">
                    <div class="col-md-6">
                        <select class="field-width-500" id="ddlDMACategories" onchange="getCategoryMappings()" size="10"></select>
                    </div>
                </div>

                <div class="dataTable-top-margin">
                    <table id="dtResults" class="stripe"></table>
                    <div id="noDataFound" style="display:none; color: red">No data found</div>
                </div>


                <!-- select with category and counts -->
                <!--
                datatable with values
                add will map to this category
                    pass(marketid, mrrcategoryid)
                release will remove from this category
                    pass(parentmarketid, marketid, mrrcategoryid)
                addfromother will remove entry and add to this category
                    pass(parentmarketid, marketid, mrrcategoryid)
                -->
                <!-- Buttons -->
                <div class="default-button-section">
                    <div class="row input-row">
                        <div class="col-md-12" id="txtMessaging">
                            Messaging will go here based on assignments
                        </div>

                    </div>
                    <div class="row input-row">
                        <div class="col-md-3">
                            <div>

                            </div>
                        </div>
                        <div class="col-md-9 text-align-left">
                            <div>
                                <input value="Assign Category Template" onclick="assignCategoriesToParentMarket()" class="default-button" type="button">
                            </div>
                            <div style="padding-top: 10px">
                                <input value="Back" onclick="goBackToMarket();" class="default-button" type="button">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Buttons-->
            </div>
        </div>
    </div>




    <!-- jQuery -->
    <script src="/js/jquery.min.js"></script>
    <!-- jQuery Easing -->
    <script src="/js/jquery.easing.1.3.js"></script>
    <!-- Bootstrap -->
    <script src="/js/bootstrap.min.js"></script>
    <!-- Bootbox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
    <!-- Waypoints -->
    <script src="/js/jquery.waypoints.min.js"></script>
    <!-- BlockUI JS -->
    <script src="/js/blockUI.js"></script>
    <!-- Config JS -->
    <script src="/js/config.js"></script>
    <!-- MAIN JS -->
    <script src="/js/main.js"></script>

    <script type="text/javascript" src="https://cdn.datatables.net/1.10.18/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.print.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.colVis.min.js"></script>

</body>
</html>

<script>
    var marketId = 0;
    var marketName = '';
    var parentMarketId = 0;
    var displayColumns = [];
    var bEditMode = false;
    var iTotalAssigned = 0;

    $(document).ready(function () {

        marketId = (getParameterByName("MarketID") == null ? 0 : getParameterByName("MarketID"));
        marketName = (getParameterByName("MarketName") == null ? '' : getParameterByName("MarketName"));
        parentMarketId = (getParameterByName("ParentMarketId") == null ? 0 : getParameterByName("ParentMarketId"));
        bEditMode = getParameterByName("Edit") === "true" ? true : false;

        console.log(bEditMode);

        if (marketId <= 0) {
            //need to determine what to do if no market id is passed through
        }

        if (parentMarketId <= 0) {
            //go get the parent market
        }

        $("#txtMarketId").val(marketId);
        $("#txtMarketName").val(marketName);
        $("#txtParentMarketId").val(parentMarketId);

        buildMainMenu("Markets");
        //need to determine which menu to display. probably markets since we started on the market page.

        //need to figure out if new or not to activate the product
        //also does this still need the partnerid functionality to activate?

        //get parent market id based on market


        //get DMA categories along with any MRR mappings
        //the list of DMA categories should include the number MRR categories mapped
        //list any MRR categories that are not mapped
        //need to figure out the design of the page

        //if no mapping display messaging at the bottom saying the product will be disabled

        //once there are mappings continue to the marketproductdma.html?MarketId=" + marketId + "&ProductNew=1


        //cancel button should go back to market page

        getDMACategoriesByParentAndMarket();

        displayColumns = getDisplayColumns();

        $("#dtAssignmentList").DataTable();
    });

    function getDMACategoriesByParentAndMarket(dmaCategory) {

        //still need to get back the total for each category

        $.ajax({
            url: ServicePrefix + '/api/ParentMarketCategory/GetDMACategoriesByParentAndMarket?inApiToken=' + getLocalStorage("APIToken") +
                "&inParentMarketId=" + $("#txtParentMarketId").val() + "&inMarketId=" + $("#txtMarketId").val(),
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',
            processData: false,
            success: function (data, textType, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);

                }
                else {
                    $("#ddlDMACategories").empty();

                    var str = '';

                    iTotalAssigned = 0;

                    $.each(data.report.rows, function (index) {

                        var obj = data.report.rows[index];

                        str = str + "<option value='" + obj.CategoryId + "'>" + obj['Category Name'] + "</option>";

                        iTotalAssigned += obj['Assigned Total'];

                    });

                    //console.log(iTotalAssigned);

                    $("#ddlDMACategories").append(str);

                    //if the dropdown is updating to reflect changes
                    //select the DMA category that was initially clicked 
                    //and refresh the assignment table.
                    if (dmaCategory !== null && dmaCategory !== undefined) {
                        $("#ddlDMACategories").val(dmaCategory).change();
                    }

                }

            },
            error: function (jqXhr, textType, errorThrown) {
                genericAjaxError(jqXhr, textType, errorThrown);
            }
        });

    }

    function getCategoryMappings() {

        //console.log($("#ddlDMACategories").val());
        //pass apitoken, parentmarket, market to the api

        $.ajax({
            url: ServicePrefix + '/api/ParentMarketCategory/GetDMAMRRCategoryAssignmentsByParentAndMarket?inApiToken=' + getLocalStorage("APIToken") +
                "&inParentMarketId=" + $("#txtParentMarketId").val() + "&inMarketId=" + $("#txtMarketId").val() +
                "&inDMACategoryId=" + $("#ddlDMACategories").val(),
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',
            processData: false,
            success: function (data, textType, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);

                }
                else {

                    //build the datatable
                    loadResults("dtResults", data, displayColumns);
                }

            },
            error: function (jqXhr, textType, errorThrown) {
                genericAjaxError(jqXhr, textType, errorThrown);
            }
        });
    }

    function getDisplayColumns() {

        var columnsToDisplay = new Array();

        columnsToDisplay.push(
            {
                "title": "MRR Category",
                "visible": true,
                "mData": "MRR Category",
                "orderable": true,
                "searchable": true
            });

        //columnsToDisplay.push({
        //    "title": "Assigned DMA Category Id",
        //    "visible": true,
        //    "mData": "Assigned DMA Category Id",
        //    "orderable": true
        //});

        columnsToDisplay.push({
            "title": "Assigned DMA Category",
            "visible": true,
            "mData": "Assigned DMA Category",
            "orderable": true,
            "searchable": true
        });

        columnsToDisplay.push({
            "title": "Status",
            "mRender": function(data, type, row) {
                //build link to assign/remove etc
                var action = "assignMRRCategory('" +
                    row["MRR Category Id"] +
                    "','" +
                    $("#ddlDMACategories").val() +
                    "'," +
                    row["Parent Market Id"] +
                    "," +
                    row["Market Id"] +
                    ")";
                return '<a href="#" onclick="' + action + '">'+ row.Status + '</a>';
            },
            "orderable": false,
            "searchable": false
        });

        return columnsToDisplay;
    }

    function loadResults(tableObject, data, columns) {

        var results = data["report"]["rows"];

        var searchTable;

        if ($.fn.DataTable.isDataTable('#' + tableObject)) {
            searchTable = $('#' + tableObject).DataTable();
            searchTable.destroy();
        }

        searchTable = $('#' + tableObject).DataTable({
            "dom": "Blfrtip",
            "pageLength": gDataTableDefaultRows,
            "order": [],
            "data": results,
            "columns": columns,
            "select": true,
            language: {
                search: "Filter Results:"
            },
            "buttons": [

            ],
            createdRow: function (row, data, index) {
                //this adds the class to every row
                $(row).addClass('single-line-height');
            }
        });
    }

    function assignMRRCategory(mrrCategoryId, dmaCategoryId, parentMarketId, marketId) {
        //do call to update the assignment
        //afterwards update the dropdown of counts and this should also reload the mapping table.

        $.ajax({
            url: ServicePrefix + '/api/MarketCategory/UpdateDMAMRRCategoryAssignmentByMarket',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inMarketId": marketId,
                "inMRRCategoryId": mrrCategoryId,
                "inDMACategoryId": dmaCategoryId
            }),
            processData: false,
            success: function (data, textType, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);

                }
                else {

                    //if successful
                    //reload dma dropdown
                    getDMACategoriesByParentAndMarket(dmaCategoryId);

                }

            },
            error: function (jqXhr, textType, errorThrown) {
                genericAjaxError(jqXhr, textType, errorThrown);
            }
        });

    }

    function goBackToMarket() {
        window.location = "/market.html?MarketID=" + $("#txtMarketId").val();
    }

</script>
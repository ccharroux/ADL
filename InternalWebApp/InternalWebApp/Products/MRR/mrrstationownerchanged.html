<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>MKA Internal Media Site</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Facebook and Twitter integration -->
    <meta property="og:title" content="" />
    <meta property="og:image" content="" />
    <meta property="og:url" content="" />
    <meta property="og:site_name" content="" />
    <meta property="og:description" content="" />
    <meta name="twitter:title" content="" />
    <meta name="twitter:image" content="" />
    <meta name="twitter:url" content="" />
    <meta name="twitter:card" content="" />
    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <link rel="shortcut icon" href="favicon.ico">
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,300,700,900' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css?family=Playfair+Display:400,700" rel="stylesheet">
    <!-- Animate.css -->
    <link rel="stylesheet" href="/css/animate.css">
    <!-- Icomoon Icon Fonts-->
    <link rel="stylesheet" href="/css/icomoon.css">
    <!-- Simple Line Icons -->
    <link rel="stylesheet" href="/css/simple-line-icons.css">
    <!-- Bootstrap  -->
    <link rel="stylesheet" href="/css/bootstrap.css">
    <!-- Theme style  -->
    <link rel="stylesheet" href="/css/style.css">
    <!--Chosen Dropdown-->
    <link rel="stylesheet" href="/css/chosen.min.css" />
    <!-- Modernizr JS -->
    <script src="/js/modernizr-2.6.2.min.js"></script>
    <!-- FOR IE9 below -->
    <!--[if lt IE 9]>
    <script src="js/respond.min.js"></script>
    <![endif]-->
</head>
<body>
    <div id="fh5co-page">
        <header id="fh5co-header" role="banner">
            <div class="container">
                <div class="header-inner" id="menu"></div>
            </div>
        </header>
        <div id="fh5co-contact-section" class="contact-section">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 col-md-offset-3 text-center fh5co-heading">
                        <h2 class="inline-block">MRR Station/Owner Archive Sync</h2>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <hr />
                        <div>This process is for syncing up Station Ownership changes. This screen will list all stations that are out of sync ownership wise between the Stations data and the Stations Archive data.</div>
                        <hr />
                    </div>
                </div>
                        <div class="row">
                            <div class="col-md-12">
                                
                                <div>Steps:</div>
                                <ul>
                                    <li>Change the station(s) to the new ownership - <font color="red">SHOULD ALREADY BE DONE</font></li>
                                    <li>Re-rank the market for the current and prior year - <font color="red">SHOULD ALREADY BE DONE</font></li>
                                    <li>Once the 2 prior steps are complete, you can select stations and apply the change of ownership retroactively and re-rank older years.</li>
                                </ul>
                                <div style="margin-left:30px">
                                    <div><b>NOTE:</b> This process does NOT cover the following:</div>
                                    <ul>
                                        <li>Users</li>
                                        <li>Account executives / rep offices</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <hr />
                        <div class="text-center margin-top-0">
                            <!--Media Type-->
                            <div class="row input-row">
                                <div id="divMediaType" class="col-md-3 text-align-left">
                                    <label for="ddlMediaType">Media Type</label>
                                </div>
                                <div class="col-md-9 text-align-left">
                                    <select id="ddlMediaType" class="field-width-325" onchange="getMarketList(); getOwnerList();"></select>
                                </div>
                            </div>
                            <!--Market-->
                            <div class="row input-row">
                                <div class="col-md-3 text-align-left">
                                    <label for="ddlMarket"><font color="red">*&nbsp;Market</font></label>
                                </div>
                                <div class="col-md-9 text-align-left">
                                    <select id="ddlMarket" class="mkaRequired field-width-325" errorMessage="You must select a market." onchange="getOwnerList();"></select>
                                </div>
                            </div>
                            <!--Ownership-->
                            <div class="row input-row">
                                <div class="col-md-3 text-align-left">
                                    <label for="ddlNewOwnership"><font color="red">*&nbsp;Ownership</font></label>
                                </div>
                                <div class="col-md-9 text-align-left">
                                    <select id="ddlNewOwnership" class="mkaRequired field-width-325" errorMessage="You must select an ownership." onchange="getMarketList();"></select>
                                </div>
                            </div>
                            <!--Station(s)-->
                            <div class="row input-row">
                                <div class="col-md-12 text-align-left">
                                    <label for="divStaionList">Station(s)</label>
                                    <div id="divStaionList">
                                        None
                                    </div>
                                </div>
 
                            </div>
                            <!--Buttons-->
                            <hr />
                            <div class="default-button-section">
                                <div class="row input-row">
                                    <div class="col-md-3">
                                    </div>
                                    <div class="col-md-9 text-align-left">
                                        <div>
                                            <input value="Update" onclick="updatePastYears();" class="default-button" type="button" />
                                        </div>
                                        <div class="back-button-div">
                                            <input value="Back" onclick="goBackToDashboard();" class="default-button" type="button" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    <!-- jQuery -->
    <script src="/js/jquery.min.js"></script>
    <!-- jQuery Easing -->
    <script src="/js/jquery.easing.1.3.js"></script>
    <!-- Bootstrap -->
    <script src="/js/bootstrap.min.js"></script>
    <!-- Bootbox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
    <!-- Waypoints -->
    <script src="/js/jquery.waypoints.min.js"></script>
    <!-- BlockUI JS -->
    <script src="/js/blockUI.js"></script>
    <!-- Config JS -->
    <script src="/js/config.js"></script>
    <!-- MAIN JS -->
    <script src="/js/main.js"></script>
    <!--Chosen Dropdown-->
    <script src="/js/chosen.jquery.min.js"></script>

</body>
</html>
<script>

    var gotMarkets = false;
    var gotOwners = false;
    var gotStations = false;

    var marketsRefreshed = false;
    var ownersRefreshed = false;

    var stationList = [];

    $(document).ready(function () {
        buildMainMenu("Stations");
        getMediaTypeList();
    });

    function getMediaTypeList() {

        var url = ServicePrefix + '/api/MediaType/GetMediaTypeList';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken")
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                getMediaTypeListSuccess(data, textStatus, jQxhr);
            },
            error: function (jQxhr, textStatus, errorThrown) {
                genericAjaxError(jQxhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);
    }

    function getMediaTypeListSuccess(data, textStatus, jQxhr) {

        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        var str = '';
        str = '<option value="-1">-- Select a Media Type</option>';
        $.each(data.report.rows, function (index) {
            str = str + '<option value="' + data.report.rows[index].MediaTypeID + '">' + data.report.rows[index].MediaTypeName + '</option>';

        });
        $("#ddlMediaType").html(str);
        convertToChosenSelect("ddlMediaType", gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);

        getMarketList();
        getOwnerList();

    }

    function getMarketList() {

        marketsRefreshed = false;

        var mediaTypeId = $("#ddlMediaType").val();
        //if (mediaTypeId <= 0) {
        //    return;
        //}

        var ownerId = gotOwners ? $("#ddlNewOwnership").val() : -1;

        var url = ServicePrefix + '/api/Market/GetMarketListForOwnerChange';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inMediaTypeId": mediaTypeId,
                "inOwnerId": ownerId,
                "inProductId": "MRR"
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                getMarketListSuccess(data, textStatus, jQxhr);
            },
            error: function (jQxhr, textStatus, errorThrown) {
                genericAjaxError(jQxhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);
    }


    function getMarketListSuccess(data, textStatus, jQxhr) {

        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        var previousMarketId = gotMarkets ? $("#ddlMarket").val() : -1;

        var str = '';
        str = '<option value="-1">-- Select a Market</option>';
        $.each(data.report.rows, function (index) {
            str = str + '<option value="' + data.report.rows[index].marketId + '">' + data.report.rows[index].marketName + '</option>';

        });
        $("#ddlMarket").html(str);
        convertToChosenSelect("ddlMarket", gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);

        var previousMarketIdStillInList = false;
        $("#ddlMarket option").each(function () {
            if (this.value == previousMarketId) {
                previousMarketIdStillInList = true;
                return false;
            }
        });
        $("#ddlMarket").val(previousMarketIdStillInList ? previousMarketId : -1);

        marketsRefreshed = true;
        gotMarkets = true;
        getStationList();

    }

    function getOwnerList() {

        ownersRefreshed = false;

        var mediaTypeId = $("#ddlMediaType").val();
        //if (mediaTypeId <= 0) {
        //    return;
        //}

        var marketId = gotMarkets ? $("#ddlMarket").val() : -1;

        var url = ServicePrefix + '/api/Owner/GetOwnerListForOwnerChange';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inMediaTypeId": mediaTypeId,
                "inMarketId": marketId,
                "inProductId": "MRR"
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                getOwnerListSuccess(data, textStatus, jQxhr);
            },
            error: function (jQxhr, textStatus, errorThrown) {
                genericAjaxError(jQxhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);

    }

    function getOwnerListSuccess(data, textStatus, jQxhr) {

        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        var previousOwnerId = gotOwners ? $("#ddlNewOwnership").val() : -1;

        var str = '';
        str = '<option value="-1">-- Select an Ownership</option>';
        $.each(data.report.rows, function (index) {
            str = str + '<option value="' + data.report.rows[index].ownerId + '">' + data.report.rows[index].ownerName + '</option>';
        });

        $("#ddlNewOwnership").html(str);
        convertToChosenSelect("ddlNewOwnership", gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);

        var previousOwnerIdStillInList = false;
        $("#ddlNewOwnership option").each(function () {
            if (this.value == previousOwnerId) {
                previousOwnerIdStillInList = true;
                return false;
            }
        });
        $("#ddlNewOwnership").val(previousOwnerIdStillInList ? previousOwnerId : -1);

        gotOwners = true;
        ownersRefreshed = true;
        getStationList();

    }

    function getStationList() {

        if (marketsRefreshed == false || ownersRefreshed == false)
        {
            return;
        }

        if ($("#ddlMarket").val() == -1 || $("#ddlNewOwnership").val() == -1)
        {
            return;
        }

        var marketId = $("#ddlMarket").val();
        var ownerId = $("#ddlNewOwnership").val();

        var url = ServicePrefix + '/api/Station/GetStationListForOwnerChange';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inMarketId": marketId,
                "inOwnerId": ownerId,
                "inProductId": "MRR"
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                getStationListSuccess(data, textStatus, jQxhr);
            },
            error: function (jQxhr, textStatus, errorThrown) {
                genericAjaxError(jQxhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);

    }

    function getStationListSuccess(data, textStatus, jQxhr) {

        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }


        var str = '<div class="row">';

        if (data.report.rows.length > 0)
        {
            str = str + '<div class="col-md-1">';
            str = str + '&nbsp;';
            str = str + '</div>';

            str = str + '<div class="col-md-2" style="font-weight:600">';
            str = str + 'Station Id';
            str = str + '</div>';
            str = str + '<div class="col-md-3" style="font-weight:600">';
            str = str + 'Station';
            str = str + '</div>';
            str = str + '<div class="col-md-2" style="font-weight:600">';
            str = str + 'Old Owner Id';
            str = str + '</div>';
            str = str + '<div class="col-md-4" style="font-weight:600">';
            str = str + 'Old Owner';
            str = str + '</div>';
        }
        else
        {
            str = str + '<div class="col-md-12">';
            str = str + 'None';
            str = str + '</div>';
        }


        str = str + "</div>";


        $.each(data.report.rows, function (index) {


            str = str + '<div class="row">';

            str = str + '<div class="col-md-1">';
            str = str + '<input class="stationsToUpdate" type="checkbox" name="stationChange" value="' + data.report.rows[index].stationId + '" />';
            str = str + '</div>';

            str = str + '<div class="col-md-2">';
            str = str + data.report.rows[index].stationId;
            str = str + '</div>';
            str = str + '<div class="col-md-3">';
            str = str + data.report.rows[index].stationName;
            str = str + '</div>';
            str = str + '<div class="col-md-2">';
            str = str + data.report.rows[index].oldOwnerId;
            str = str + '</div>';
            str = str + '<div class="col-md-4">';
            str = str + data.report.rows[index].oldOwnerName;
            str = str + '</div>';

            str = str + "</div>";
        });
        
        $("#divStaionList").html(str);
        
 
        gotStations = true;

    }

    function updatePastYears()
    {

        if ($("#ddlMarket").val() == -1) {
            bootbox.alert("Must select a market first");
            return;
        }

        if ($("#ddlNewOwnership").val() == -1) {
            bootbox.alert("Must select an owner first");
            return;
        }

        stationList = [];
        var foundProblem = false;
        //$('input.myclass[type=checkbox]').each(function () {
        //    var sThisVal = (this.checked ? $(this).val() : "");
        //});
        $(".stationsToUpdate:checkbox:checked").each(function (index, value) {

            if (foundProblem == true)
            {
                return;
            }

            stationId = $(this).val();

            if (stationId == -1)
            {
                return;
            }

            if (stationList.includes(stationId))
            {
                bootbox.alert('Station ' + $(this).text() + ' is selected multiple times');
                foundProblem = true;
                return;
            }

            stationList.push(stationId);
        });

        if (foundProblem == true)
        {
            return;
        }

        if (stationList.length == 0)
        {
            bootbox.alert("Must select one or more stations first");
            return;
        }

        // in this context we only care whether market is currently being ranked, which is independent of year/period, so just pass some placeholder values
        var d = new Date();
        var thisYear = d.getFullYear();
        var thisMonth = d.getMonth() + 1; // getMonth() returns 0 to 11
        var thisPeriod = (thisMonth < 10) ? "0" + thisMonth.toString() : thisMonth.toString();

        var url = ServicePrefix + '/api/MRR/GetMarketRankStatus';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inMarketId": $("#ddlMarket").val(),
                "inYear": thisYear,
                "inPeriod": thisPeriod
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                updatePastYears_getMarketRankStatusSuccess(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);
    }

    function updatePastYears_getMarketRankStatusSuccess(data, textStatus, jQxhr)
    {
        if (data.response.status != "SUCCESS")
        {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        if (data.report.rows.length == 0)
        {
            MKAErrorMessageRtn("Failed to get market rank status");
            return;
        }

        if (data.report.rows[0].marketRankingInProgress == true)
        {
            bootbox.alert("Market ranking is still in progress");
            return;
        }

        var url = ServicePrefix + '/api/MRR/UpdateStationOwnershipRetroactively';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inMarketId": $("#ddlMarket").val(),
                "inNewOwnerId": $("#ddlNewOwnership").val(),
                "inStationList": stationList
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                updatePastYearsSuccess(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);
    }

    function updatePastYearsSuccess(data, textStatus, jQxhr) {

        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        getStationList();

        bootbox.alert("Archived specs updated.<br>Market scheduled for re-ranking of past years.<br>You should receive an e-mail when it is complete.");


    }

</script>

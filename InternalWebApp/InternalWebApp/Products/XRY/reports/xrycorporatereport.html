<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>MKA Internal Media Site</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Facebook and Twitter integration -->
    <meta property="og:title" content="" />
    <meta property="og:image" content="" />
    <meta property="og:url" content="" />
    <meta property="og:site_name" content="" />
    <meta property="og:description" content="" />
    <meta name="twitter:title" content="" />
    <meta name="twitter:image" content="" />
    <meta name="twitter:url" content="" />
    <meta name="twitter:card" content="" />

    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <link rel="shortcut icon" href="/favicon.ico">

    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,300,700,900' rel='stylesheet' type='text/css'>

    <link href="https://fonts.googleapis.com/css?family=Playfair+Display:400,700" rel="stylesheet">

    <!-- Animate.css -->
    <link rel="stylesheet" href="/css/animate.css">
    <!-- Icomoon Icon Fonts-->
    <link rel="stylesheet" href="/css/icomoon.css">
    <!-- Simple Line Icons -->
    <link rel="stylesheet" href="/css/simple-line-icons.css">
    <!-- Bootstrap  -->
    <link rel="stylesheet" href="/css/bootstrap.css">
    <!-- Theme style  -->
    <link rel="stylesheet" href="/css/style.css">

    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <!-- CSS for the Chosen dropdown -->
    <link rel="stylesheet" href="/css/chosen.min.css" />

    <!-- Modernizr JS -->
    <script src="/js/modernizr-2.6.2.min.js"></script>

    <!-- FOR IE9 below -->
    <!--[if lt IE 9]>
    <script src="js/respond.min.js"></script>
    <![endif]-->

    <style>
        .rptView {
            margin-left: 5px;
            vertical-align: top;
            display: inline-block;
        }

        .rptStartDate, .rptEndDate {
            /*max-width:100px;*/
            text-align: center;
        }

 

        .requiredText {
            color: red !important;
        }

        .rptButton {
            vertical-align: top;
            display: inline-block;
            float: right;
        }
    </style>

</head>
<body>

    <div id="fh5co-page">
        <header id="fh5co-header" role="banner">
            <div class="container">
                <div class="header-inner" id="menu"></div>
            </div>
        </header>

        <div id="fh5co-contact-section" class="contact-section">
            <div class="container">
                <div class="row" id="reportTitleRow">
                    <div class="col-md-6 col-md-offset-3 text-center fh5co-heading">
                        <h2 id="reportTitle"></h2>
                    </div>
                </div>
                <div id="divQuickReport" >
                    <label for="ddlQuickReport" class="search-ddl-label" style="text-align:right">Reports:&nbsp;</label>
                    <select class="search-ddl-select" onchange="getQuickReport(this.value)" style="width:207px;font-size:14px" id="ddlQuickReport"></select>
                </div>

                <!-- search / filter area -->
                <div class="row search-section">
                    <div class="col-md-12 ">
                        <div class="form-group rptView rptOwner">
                            <label for="ddlOwner" class="dropdown-label rptView rptOwner">Owner</label>
                            <select id="ddlOwner" apiInput="inOwnerId" class="dropdown-select rptView rptOwner"></select>
                        </div>

                        <div class="form-group rptView rptFromYearPeriod">
                            <label for="ddlFromYYYYMM" class="dropdown-label rptView rptFromYearPeriod">From Period</label>
                            <select id="ddlFromYYYYMM" apiInput="inFromPeriodYYYYMM" class="dropdown-select rptView rptFromYearPeriod"></select>
                        </div>

                        <div class="form-group rptView rptToYearPeriod">
                            <label for="ddlToYYYYMM" class="dropdown-label rptView rptToYearPeriod">To Period</label>
                            <select id="ddlToYYYYMM" apiInput="inToPeriodYYYYMM" class="dropdown-select rptView rptToYearPeriod"></select>
                        </div>

                        <div class="form-group rptView rptYear">
                            <label for="ddlYear" class="dropdown-label rptView rptYear">Year</label>
                            <select id="ddlYear" apiInput="inYear" class="dropdown-select rptView rptYear"></select>
                        </div>

                        <div class="form-group rptView rptPeriod">
                            <label for="ddlPeriod" class="dropdown-label rptView rptPeriod">Period</label>
                            <select id="ddlPeriod" apiInput="inPeriod" class="dropdown-select rptView rptPeriod"></select>
                        </div>

                        <div class="form-group rptView rptMarket">
                            <label for="ddlMarket" class="dropdown-label rptView rptMarket">Market</label>
                            <select id="ddlMarket" apiInput="inMarketId" class="dropdown-select rptView rptMarket"></select>
                        </div>

                        <div class="form-group rptView rptInternalReport">
                            <label for="ddlInternalReport" class="dropdown-label rptView rptInternalReport">Report Type</label>
                            <select id="ddlInternalReport" apiInput="inInternalReport" class="dropdown-select rptView rptInternalReport">
                                <option selected value="0">Client</option>
                                <option value="1">Internal</option>
                            </select>
                        </div>

                        <div class="form-group rptView rptYTDReport">
                            <label for="ddlYTDReport" class="dropdown-label rptView rptYTDReport">Date Type</label>
                            <select id="ddlYTDReport" apiInput="inYTDReport" class="dropdown-select rptView rptYTDReport">
                                <option selected value="0">Quarterly</option>
                                <option value="1">Year To Date</option>
                            </select>
                        </div>

                        <div class="form-group col-md-3 rptButton" style="text-align: right;">
                            <label for="btnReport" class="dropdown-label">&nbsp;</label>
                            <input type="button" id="btnReport" class="search-button" value="Run Report" onclick="getReport()" />
                        </div>

                    </div>
                </div>

            </div>
        </div>


    </div>




    <!-- jQuery -->
    <script src="/js/jquery.min.js"></script>
    <!-- jQuery Easing -->
    <script src="/js/jquery.easing.1.3.js"></script>
    <!-- Bootstrap -->
    <script src="/js/bootstrap.min.js"></script>
    <!-- Bootbox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
    <!-- Waypoints -->
    <script src="/js/jquery.waypoints.min.js"></script>
    <!-- BlockUI JS -->
    <script src="/js/blockUI.js"></script>
    <!-- Config JS -->
    <script src="/js/config.js"></script>
    <!-- MAIN JS -->
    <script src="/js/main.js"></script>
    <!-- genericReport JS -->
    <script src="/js/genericReport.js"></script>


    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <!--Chosen Dropdown-->
    <script src="/js/chosen.jquery.min.js"></script>

</body>
</html>
<script>

    var reportObject = new Object();
    var reportFilterArray = new Array();
    var reportId = 0;

    var api = "";
    var apiParameters = new Object();
    var apiToken = "";


    $(document).ready(function () {

        reportId = getParameterByName("reportId");

        if (validReportIdCheck(reportId) == false) {
            return;
        }

        // get report objects
        reportObject = getReportObject(reportId);
        reportFilterArray = reportObject.filters;

        if (reportObject.apiControllerAction == null || reportObject.apiControllerAction.length == 0) {
            var msg = reportObject.reportTitle + " Report has not been implemented.";
            bootbox.alert(msg, function () { window.location = "/products/xry/xrycorporatereport.html"; });
            return false;
        }

        // report title
        $("#reportTitle").html(reportObject.reportTitle);

        buildXRYMenu("");
        
        setUIEvents();

        //display filters
        displayFilters(reportFilterArray);

    });

    function setUIEvents()
    {
        $("select").change(function () {

            $("#btnReport").addClass("flash-button");
            $(document).unbind('ajaxStart');
            $(document).unbind('ajaxStop');

        });

    }

    function validReportIdCheck(reportId) {
        var bReturn = true;

        if (!reportId) {
            //fi we got here from js/main.js goBackToDashboard(), then extract reportId and redirct
            var searchParams = getParameterByName("search");

            if (searchParams != null) {
                searchParams = searchParams.toLowerCase().split('|');
                if (searchParams.length > 0) {
                    if (searchParams[0].indexOf('reportId=') >= 0) {
                        reportId = searchParams[0].substring(9, searchParams[0].length);
                        //  getQuickReport(reportId);   TODO
                        return false;
                    }
                }
            }

            //else punt
            var msg = "Invalid page request, no report passed.";
            bootbox.alert(msg, function () { window.location = "/admin/login/dashboard.html"; });
            return false;

        } else {
            return true;
        }
    }


    function displayFilters(arrayFilters) {

        //set all filters display to
        $(".rptView").hide();

        for (var i = 0; i < arrayFilters.length; i++) {

            activateFilter(arrayFilters[i]);
            var input = $("#" + arrayFilters[i].objectName);

            if (arrayFilters[i].required == true) {

                $("label[for=" + input.attr("id") + "]").css("color", "red");
                $("label[for=" + input.attr("id") + "]").prepend(" * ");

            }

            if (arrayFilters[i].multiFieldOption !== "undefined" && arrayFilters[i].multiFieldOption == true) {
                $("label[for=" + input.attr("id") + "]").prepend(" ** ");

                if ($(".multi-field-message-area").is(":visible")) {
                    $(".multi-field-message").append(" or " + $("label[for=" + input.attr("id") + "]").text().replace(/\*/g, ''));
                } else {
                    $(".multi-field-message").append(" " + $("label[for=" + input.attr("id") + "]").text().replace(/\*/g, ''));
                    $(".multi-field-message-area").show();
                }
            }


        }
    }

    function getReport() {



        api = reportObject.apiControllerAction;
        apiParameters = new Object();
        apiToken = getLocalStorage("APIToken");
        searchText = "";

        //------------------------
        //setup the parameters for the API
        //------------------------

        if (reportObject.apiType.toLowerCase() == "post") {
            apiParameters["inApiToken"] = apiToken;
        } else {
            api = api + "?inApiToken=" + apiToken;
        }

        //------------------------
        // loop thru filters
        //------------------------
        var itemsToCheckLength = reportFilterArray.length;

        //-------------------------------
        // This is the no filter use case
        //-------------------------------

        if (itemsToCheckLength == 0) {
            //Something went wrong, all corporate reports should have a filter? //TODO CHECK IF TRUE
        }

        var hasMultiField = false;
        var oneMultiFieldCompleted = false;

        for (var i = 0; i < reportFilterArray.length; i++) {
            var filterObject = reportFilterArray[i];

            if (filterObject.multiFieldOption !== undefined) {
                hasMultiField = true;
            }
        }

        $.each(reportFilterArray, function (objectName, objectValue) {
            var control = objectValue.objectName;


            var nameOfParm = $("#" + control).attr("apiInput");
            var item = "#" + control;
            var isRequired = objectValue.required;

            var isMultiField = objectValue.multiFieldOption !== undefined ? objectValue.multiFieldOption : false;

            //if ($(item).prop("tagName") == "SELECT") {

            if ($(item).val() != "") {
                if (reportObject.apiType.toLowerCase() == "post") {
                    apiParameters[nameOfParm] = $(item).val();
                }
                else {
                    api = api + "&" + nameOfParm + "=" + $(item).val();
                }

                if (isMultiField) {
                    oneMultiFieldCompleted = true;
                }

            }
            else {
                if (isRequired) {
                    var msg = "Please select a " + nameOfParm.toLowerCase().replace("in", "").replace("id", "") + ".";
                    bootbox.alert(msg, function () { });
                    return false;
                }
            }

            // when done with the loop
            // get the report
            if (objectName == (itemsToCheckLength - 1)) {

                if (hasMultiField && oneMultiFieldCompleted == false) {
                    var msg = "Please complete at least one field with **.";
                    bootbox.alert(msg, function () { });
                    return false;
                }

                getReportAjax();
            }

        });

    }

    function getReportAjax() {

        $(document).ajaxStart($.blockUI).ajaxStop($.unblockUI);
        $("#btnReport").removeClass("flash-button");

        var url = ServicePrefix + api;

        var settings = {
            dataType: 'json',
            type: reportObject.apiType.toString().toLowerCase(),
            contentType: 'application/json',
            data: JSON.stringify(apiParameters),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                getReportAjaxSuccess(data, textStatus, jQxhr);
            },
            error: function (jQxhr, textStatus, errorThrown) {
                genericAjaxError(jQxhr, textStatus, errorThrown);
            }
        }

        $.ajax(url, settings);

    }

    function getReportAjaxSuccess(data, textStatus, jQxhr) {
        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
        }
        else {
            bootbox.alert("Report has successfully been added to queue, an email will be sent out when the report is ready.");

        }
    }


    function activateFilter(filterObject) {

        var classToShow = "rpt" + filterObject.token;
        $("." + classToShow).show();

        if ($("#" + filterObject.objectName + "_chosen").length > 0) {
            $("#" + filterObject.objectName).hide();
        }

        if (filterObject.jsCall == null) {
            return;
        }

        var jsCallParams = (filterObject.jsCallParameters == undefined ? new Array() : filterObject.jsCallParameters);

        var fn = window[filterObject.jsCall];
        fn.apply(filterObject, jsCallParams);

    }

    function saveLoadedControlSelection(control) {
        var searchResults = getLocalStorage("gSearchResults");

        if (!searchResults) {
            return;
        }

        var searchCriteria = $.parseJSON(searchResults);
        $("#" + control).val(searchCriteria[control]);

    }


    //--------------------------------
    // Filters get loaded here
    //--------------------------------

    function getOwnerList() {

        var url = ServicePrefix + '/api/Owner/GetOwnerListUnfiltered';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inActiveOnly": "1",
                "inAddDetails": "0"
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                getOwnerListSuccess(data, textStatus, jQxhr);
            },
            error: function (jQxhr, textStatus, errorThrown) {
                genericAjaxError(jQxhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);
    }

    function getOwnerListSuccess(data, textStatus, jQxhr) {

        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);

        }
        else {

            var str = '';

            $("#ddlOwner").html("<option value=''>-- Select an Owner </option>");

            $.each(data.report.rows, function (index) {
                var obj = data.report.rows[index];
                str = str + "<option value='" + obj.OwnerID + "'>" + obj.OwnerName   + "</option>";
            });

            $("#ddlOwner").append(str);

            convertToChosenSelect("ddlOwner", gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);

            saveLoadedControlSelection("ddlOwner");

        }

    }

    function getPeriodList_YYYYMM() {

        var control = this.objectName;

        var str = '';
        str = '<option value="">-- Select a Period --</option>';

        var thisYear = (new Date()).getFullYear();

        for (var i = thisYear; i > (thisYear - 10) ; i--) {

            for (var i2 = 12; i2 > 0; i2--) {

                var period = i + '/' + addZero(i2);


                str = str + '<option value="' + period + '">' + period + '</option>';
            }
        }

        $("#" + control).html(str);

        convertToChosenSelect(control, gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);

        saveLoadedControlSelection(control);

    }

    function getPeriodList(typesToLoad) {

        if (!typesToLoad) {
            typesToLoad = "all";
        }

        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        var str = '';
        str = '<option value="">-- Select a Period --</option>';

        if (typesToLoad.toLowerCase() == "all" || typesToLoad.toLowerCase() == "months") {

            for (var i = 1; i <= 12; i++) {

                str = str + '<option value="' + (i < 10 ? '0' + i.toString() : i.toString()) + '">' + monthNames[i - 1] + '</option>';
            }
        }

        if (typesToLoad.toLowerCase() == "all") {
            str = str + '<option value="">-----------</option>';
        }

        if (typesToLoad.toLowerCase() == "all" || typesToLoad.toLowerCase() == "quarters") {
            for (var i = 1; i <= 4; i++) {

                str = str + '<option value="Q' + i.toString() + '">Quarter - ' + i.toString() + '</option>';
            }
        }


        $("#ddlPeriod").html(str);

        convertToChosenSelect("ddlPeriod", gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);

        //saveLoadedControlSelection("ddlPeriod");
    }

    function getYearList() {
        var str = '';
        str = '<option value="">-- Select a Year --</option>';

        var thisYear = (new Date()).getFullYear();

        for (var i = thisYear; i > (thisYear - 10) ; i--) {

            str = str + '<option value="' + i + '">' + i + '</option>';
        }

        $("#ddlYear").html(str);

        convertToChosenSelect("ddlYear", gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);

        saveLoadedControlSelection("ddlYear");

    }

    function getMarketListByProduct(inProduct) {

        var url = ServicePrefix + '/api/Market/GetMarketListByProduct';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inProductId": inProduct,
                "inActiveOnly": true
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                getMarketListByProductSuccess(data, textStatus, jQxhr);
            },
            error: function (jQxhr, textStatus, errorThrown) {
                genericAjaxError(jQxhr, textStatus, errorThrown);
            }
        }

        $.ajax(url, settings);
    }

    function getMarketListByProductSuccess(data, textStatus, jQxhr) {
        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
        }
        else {

            var str = '';
            str = '<option value="">-- Select a Market --</option>';
            $.each(data.report.rows, function (index) {

                str = str + '<option value="' + data.report.rows[index].marketId + '">' + data.report.rows[index].marketName + ' (' + data.report.rows[index].marketId + ')' + '</option>';

            });

            $("#ddlMarket").html(str);

            convertToChosenSelect('ddlMarket', gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);
            saveLoadedControlSelection("ddlMarket");
            //preSelectItem('quickReportQS');

        }
    }

    function getOwnerListByProduct(inProduct) {

        var url = ServicePrefix + '/api/Owner/GetOwnerListByProduct';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inProductId": inProduct
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                getOwnerListByProductSuccess(data, textStatus, jQxhr);
            },
            error: function (jQxhr, textStatus, errorThrown) {
                genericAjaxError(jQxhr, textStatus, errorThrown);
            }
        }

        $.ajax(url, settings);

    }

    function getOwnerListByProductSuccess(data, textStatus, jQxhr) {
        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
        }
        else {

            var str = '';

            str = "<option value=''>-- Select an Owner --</option>";

            $.each(data.report.rows, function (index) {
                var obj = data.report.rows[index];
                str = str + "<option value='" + obj.ownerid + "'>" + obj.ownername  + "</option>";

            });
            $("#ddlOwner").html(str);
            convertToChosenSelect("ddlOwner", gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);
        }
    }
</script>

<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->
<head>
    <title></title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>MKA Internal Media Site</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Facebook and Twitter integration -->
    <meta property="og:title" content="" />
    <meta property="og:image" content="" />
    <meta property="og:url" content="" />
    <meta property="og:site_name" content="" />
    <meta property="og:description" content="" />
    <meta name="twitter:title" content="" />
    <meta name="twitter:image" content="" />
    <meta name="twitter:url" content="" />
    <meta name="twitter:card" content="" />

    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <link rel="shortcut icon" href="/favicon.ico">

    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,300,700,900' rel='stylesheet' type='text/css'>

    <link href="https://fonts.googleapis.com/css?family=Playfair+Display:400,700" rel="stylesheet">

    <!-- Animate.css -->
    <link rel="stylesheet" href="/css/animate.css">
    <!-- Icomoon Icon Fonts-->
    <link rel="stylesheet" href="/css/icomoon.css">
    <!-- Simple Line Icons -->
    <link rel="stylesheet" href="/css/simple-line-icons.css">
    <!-- Bootstrap  -->
    <link rel="stylesheet" href="/css/bootstrap.css">
    <!-- Theme style  -->
    <link rel="stylesheet" href="/css/style.css">

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.18/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.2/css/responsive.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.5.2/css/buttons.dataTables.min.css" />
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <!--Chosen Dropdown-->
    <link rel="stylesheet" href="/css/chosen.min.css" />

    <!-- Modernizr JS -->
    <script src="/js/modernizr-2.6.2.min.js"></script>
    <!-- FOR IE9 below -->
    <!--[if lt IE 9]>
    <script src="js/respond.min.js"></script>
    <![endif]-->

    <style>
        .rptView {
            margin-left: 5px;
            vertical-align: top;
            display: inline-block;
        }

        .rptStartDate, .rptEndDate {
            /*max-width:100px;*/
            text-align: center;
        }

        .requiredText {
            color: red !important;
        }

        .rptButton {
            vertical-align: top;
            display: inline-block;
            float: right;
        }

        select {
            max-width: 200px;
        }

        .vertical-center {
            /*margin: 0;
            position: absolute;
            top: 50%;
            -ms-transform: translateY(-50%);
            transform: translateY(-50%);*/
            vertical-align: middle;
        }

        .rtpViewRight {
            margin-right: 5px;
            vertical-align: top;
            display: inline-block;
        }

        .rdo-label {
            padding-left: 5px;
        }
    </style>
</head>
<body>
    <div id="fh5co-page">
        <header id="fh5co-header" role="banner">
            <div class="container">
                <div class="header-inner" id="menu"></div>
            </div>
        </header>

        <div id="fh5co-contact-section" class="contact-section">
            <div class="container">
                <div class="row" id="reportTitleRow">
                    <div class="col-md-6 col-md-offset-3 text-center fh5co-heading">
                        <h2 id="pageTitle"></h2>
                    </div>
                </div>

                <div class="row search-section">
                    <div class="col-md-12 ">
                        <!-- filters -->
                        <div class="form-group rptView vertical-center">
                            <input type="radio" name="matchType" id="rdoAdvertiser" value="advertiser" class="report-filter" checked="checked"><label class="rdo-label rtpViewRight" for="rdoAdvertiser">Advertiser</label>
                            <br />
                            <input type="radio" name="matchType" id="rdoAgency" value="agency" class="report-filter"><label class="rdo-label rtpViewRight" for="rdoAgency">Agency</label>
                            <br />
                            <input type="radio" name="matchType" id="rdoMedia" value="media" class="report-filter"><label class="rdo-label rtpViewRight" for="rdoMedia">Third Party</label>
                        </div>
                        <div class="form-group rptView vertical-center match-station match-media">
                            <label for="ddlPeriod" class="dropdown-label rptView">Period</label>
                            <select id="ddlPeriod" apiInput="inPeriod" class="mkaRequired dropdown-select rptView report-filter" errorMessage="Select a period."></select>
                        </div>
                        <div class="form-group rptView vertical-center match-station match-media">
                            <label for="ddlYear" class="dropdown-label rptView">Year</label>
                            <select id="ddlYear" apiInput="inYear" class="mkaRequired dropdown-select rptView report-filter" errorMessage="Select a year."></select>
                        </div>
                        <div class="form-group rptView vertical-center match-station match-media">
                            <label for="ddlMarket" class="dropdown-label rptView">Market</label>
                            <select id="ddlMarket" apiInput="inMarketId" onchange="" class="dropdown-select rptView report-filter"></select>
                        </div>
                        <div class="form-group rptView vertical-center match-station">
                            <label for="ddlOwner" class="dropdown-label rptView">Owner</label>
                            <select id="ddlOwner" apiInput="inOwnerId" onchange="" class="dropdown-select rptView report-filter"></select>
                        </div>
                        <div class="form-group rptView vertical-center match-station">
                            <label for="ddlStation" class="dropdown-label rptView">Station</label>
                            <select id="ddlStation" apiInput="inStationId" onchange="" class="dropdown-select rptView report-filter"></select>
                        </div>
                        <div class="form-group rptView vertical-center match-media">
                            <label for="ddlMediaType" class="dropdown-label rptView">Media Type</label>
                            <select id="ddlMediaType" apiInput="inMediaTypeId" onchange="" class="dropdown-select rptView report-filter"></select>
                        </div>
                        <div class="form-group rptView vertical-center match-station match-media">
                            <label for="ddlOptions" class="dropdown-label rptView">Options</label>
                            <select id="ddlOptions" apiInput="inOptionId" onchange="" class="dropdown-select rptView report-filter"></select>
                        </div><!-- adding comments here-->
                        <div class="form-group col-md-3 rptButton" style="text-align: right">
                            <label for="btnReport" class="dropdown-label">&nbsp;</label>
                            <input type="button" id="btnReport" class="search-button" value="Show" onclick="getMatchingReport()" />
                        </div>
                    </div>
                </div>

                <!-- datatable -->
                <div class="dataTable-top-margin">
                    <div id="dtResultsHolder">
                        <table id="dtResults" class="cell-border dataTable-border dataTable-headers dataTable-cell-border"></table>
                    </div>
                    <div id="noDataFound" style="display:none; color: red">No data found</div>
                </div>


            </div>
        </div>
    </div>


    <!-- jQuery -->
    <script src="/js/jquery.min.js"></script>
    <!-- jQuery Easing -->
    <script src="/js/jquery.easing.1.3.js"></script>
    <!-- Bootstrap -->
    <script src="/js/bootstrap.min.js"></script>
    <!-- Bootbox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
    <!-- Waypoints -->
    <script src="/js/jquery.waypoints.min.js"></script>
    <!-- BlockUI JS -->
    <script src="/js/blockUI.js"></script>
    <!-- Config JS -->
    <script src="/js/config.js"></script>
    <!-- MAIN JS -->
    <script src="/js/main.js"></script>
    <!-- genericReport JS -->
    <script src="/js/genericReport.js"></script>

    <script type="text/javascript" src="https://cdn.datatables.net/1.10.18/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.print.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.colVis.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <!--Chosen Dropdown-->
    <script src="/js/chosen.jquery.min.js"></script>

</body>
</html>
<script>

    //advertiser or agency
    //will default to advertiser
    var matchPageType = "";
    var marketId = 0;
    var ownerId = 0;
    var stationId = 0;
    var period = "";
    var year = "";
    var product = "XRY";
    var matchOptions = "";
    var mediaType = "";

    $(document).ready(function () {


        buildXRYMenu("Revenue");

        clearLocalStorage();

        //get the information from link
        getParameters();

        setupUI();

        loadPeriods();
        loadYears();
        loadReportOptions();

        getMediaAdvertiserMediaTypeList();

        //load markets
        getMarketListByProduct(product);

 
    });

    function clearLocalStorage() {
        setLocalStorage("newAdvertiserMatch", "");
        setLocalStorage("newAgencyMatch", "");
        setLocalStorage("newMediaMatch", "");
        setLocalStorage("StandardInputId", "");
        setLocalStorage("MediaStandardInputId", "");
    }

    function getParameters() {
        /*
         * ownerid
         * marketid
         * stationid
         * period
         * year
         * token for advertiser or agency (match type)
         * need to also get the submission id
         */

        ownerId = (getParameterByName("OwnerID") == null ? "" : getParameterByName("OwnerID"));
        marketId = (getParameterByName("MarketID") == null ? "" : getParameterByName("MarketID"));
        stationId = (getParameterByName("StationID") == null ? "" : getParameterByName("StationID"));
        period = (getParameterByName("Period") == null ? "" : getParameterByName("Period"));
        year = (getParameterByName("Year") == null ? "" : getParameterByName("Year"));
        matchPageType = (getParameterByName("MatchPage") == null ? "ADV" : getParameterByName("MatchPage"));
        matchOptions = (getParameterByName("OptionFlag") == null ? "unmatched" : getParameterByName("OptionFlag"));
        mediaType = (getParameterByName("MediaType") == null ? "" : getParameterByName("MediaType"));

        //set radio buttons based on matchpage value
        switch (matchPageType.toLowerCase()) {
            case 'adv':
                $("#rdoAdvertiser").prop('checked', true);
                $("#rdoAdvertiser").click();
                break;
            case 'agy':
                $("#rdoAgency").prop('checked', true);
                $("#rdoAgency").click();
                break;
            case 'media':
                $("#rdoMedia").prop('checked', true);
                $("#rdoMedia").click();
                break;
            default:
                $("#rdoAdvertiser").prop('checked', true);
                $("#rdoAdvertiser").click();
                break;
        }

        //lets get the back button data and assign it
        if (hasBackButtonData() == false) {
            return;
        }

        var reportParamData = getBackButtonDataByPage(window.location.pathname);

        for (var key in reportParamData)
        {
            if (key.indexOf("rdo") > -1)
            {
                $("#" + key).prop('checked', reportParamData[key]);
            }

            if (key.indexOf("rdo") > -1 && reportParamData[key] == true) {
                $("#" + key).change();
            }

            //period, year, market, owner, station, mediatype, options
            //set each variable from above to value matching key
            if (key.indexOf("Period") > -1)
            {
                period = reportParamData[key];
            }

            if (key.indexOf("Year") > -1) {
                year = reportParamData[key];
            }

            if (key.indexOf("Market") > -1) {
                marketId = reportParamData[key];
            }

            if (key.indexOf("Owner") > -1) {
                ownerId = reportParamData[key];
            }

            if (key.indexOf("Station") > -1) {
                stationId = reportParamData[key];
            }

            if (key.indexOf("Options") > -1) {
                matchOptions = reportParamData[key];
            }

            if (key.indexOf("MediaType") > -1) {
                mediaType = reportParamData[key];
            }

        }

        cleanupBackButton(window.location.pathname);

    }

    function assignPageTitle() {

        if ($('#rdoAgency').is(':checked')) {
            $("#pageTitle").html("Station Agency Match Page");

        } else if ($('#rdoMedia').is(':checked')) {
            $("#pageTitle").html("Third Party Advertiser Match Page");

        } else {
            $("#pageTitle").html("Station Advertiser Match Page");
        }
    }

    function setupUI() {
        assignPageTitle();

        setupInitialFilters();

        //market change get stations
        $("#ddlMarket").change(function () {
            getStations();
        });

        //owner change get stations
        $("#ddlOwner").change(function () {
            getStations();
        });

        $('input[type=radio][name=matchType]').change(function () {

            setupFilters(this.value);
            assignPageTitle();
        });
    }

    function setupInitialFilters() {
        var radioValue = $("input[name='matchType']:checked").val();

        setupFilters(radioValue);
    }

    function setupFilters(radioValue) {
        switch (radioValue.toLowerCase()) {
            case 'advertiser':
                $(".match-media").hide();
                $(".match-station").show();
                break;
            case 'agency':
                $(".match-media").hide();
                $(".match-station").show();
                break;
            case 'media':
                $(".match-station").hide();
                $(".match-media").show();
                break;
            default:
                $(".match-media").hide();
                $(".match-station").show();
                break;
        }
    }

    function loadPeriods() {
        getPeriodList(); //does this only need to be months or do quarters need to be included

        if (period.length > 0) {
            $("#ddlPeriod").val(period);
        }
    }

    function loadYears() {
        getYearList();

        if (year.length > 0) {
            $("#ddlYear").val(year);
        }
    }

    function loadReportOptions()
    {

        var str = '';
        str =  '<option value="">-- Select a Media Type --</option>';
        str += '<option value="unmatched" selected="selected">Only Unmatched</option>';
        str += '<option value="matched">Only Matched</option>';
        str += '<option value="both">Both Matched and Unmatched</option>';

        $("#ddlOptions").html(str);
        convertToChosenSelect("ddlOptions", gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);

        if (matchOptions.length > 0) {
            $("#ddlOptions").val(matchOptions.toLowerCase());
        } else {
            $("#ddlOptions").val("unmatched");
        }
    }

    function getAdvertiserColumns() {
        /*
         * station
         * owner
         * market
         * station advertiser
         * link
         */

        var columnsToDisplay = new Array();

        columnsToDisplay.push({
            "title": "Station",
            "visible": true,
            "mData": "Station",
            "orderable": true,
            "searchable": true
        });

        columnsToDisplay.push({
            "title": "Owner",
            "visible": true,
            "mData": "Owner",
            "orderable": true,
            "searchable": true
        });

        columnsToDisplay.push({
            "title": "Market",
            "visible": true,
            "mData": "Market",
            "orderable": true,
            "searchable": true
        });


        columnsToDisplay.push({
            "title": "Station Advertiser",
            "visible": true,
            "mData": "Station Advertiser",
            "orderable": true,
            "searchable": true
        });

        columnsToDisplay.push({
            "title": "Market Advertiser",
            "visible": true,
            "mData": "Market Advertiser",
            "orderable": true,
            "searchable": true
        });

        columnsToDisplay.push({
            "mRender": function (data, type, row) {
                var action = "";


                //pass the advertiser name, station category
                if (row["linkedAdvertiserId"] > 0) {
                    action = "";
                    action += "editStationAdvertiser(";
                    action += "'" + row["Station Category"] + "','" + row["Station Agency"] + "'," + row["linkedAdvertiserId"] + "," + row["Standard Input ID"] + ");";
                    return '<a href="#" onclick="' + action + '">Edit&nbsp;Station&nbsp;Advertiser</a>';
                } else {
                    action = "";
                    action += "createStationAdvertiser(";
                    action += row["marketId"] + "," + row["ownerId"] + "," + row["stationId"] + ",";
                    action += "'" + row["Station Advertiser"] + "','" + row["Station Category"] + "','" + row["Station Advertiser Code"] + "'";
                    action += ",'" + row["Station Agency"] + "'," + row["linkedAdvertiserId"] + "," + row["Standard Input ID"] + ");";
                    return '<a href="#" onclick="' + action + '">Match&nbsp;Station&nbsp;Advertiser</a>';
                }
            },
            "orderable": false,
            "searchable": false,
            "className": "text-align-right"
        });

        return columnsToDisplay;

    }

    function getAdvertiserExportColumns() {
        var columnsToExport = new Array();

        columnsToExport.push(0);
        columnsToExport.push(1);
        columnsToExport.push(2);
        columnsToExport.push(3);
        columnsToExport.push(4);

        return columnsToExport;
    }

    function getAgencyColumns() {
        /*
         * station
         * owner
         * market
         * station agency
         * link
         */

        var columnsToDisplay = new Array();

        columnsToDisplay.push({
            "title": "Station",
            "visible": true,
            "mData": "Station",
            "orderable": true,
            "searchable": true
        });

        columnsToDisplay.push({
            "title": "Owner",
            "visible": true,
            "mData": "Owner",
            "orderable": true,
            "searchable": true
        });

        columnsToDisplay.push({
            "title": "Market",
            "visible": true,
            "mData": "Market",
            "orderable": true,
            "searchable": true
        });


        columnsToDisplay.push({
            "title": "Station Agency",
            "visible": true,
            "mData": "Station Agency",
            "orderable": true,
            "searchable": true
        });

        columnsToDisplay.push({
            "title": "Market Agency",
            "visible": true,
            "mData": "Market Agency",
            "orderable": true,
            "searchable": true
        });

        columnsToDisplay.push({
            "mRender": function (data, type, row) {
                var action = "";

                if (row["linkedAgencyId"] > 0) {
                    action = "";
                    action += "editStationAgency(";
                    action += "'" + row["Station Category"] + "','" + row["Station Advertiser"] + "'," + row["linkedAgencyId"] + "," + row["Standard Input ID"] + ");";
                    return '<a href="#" onclick="' + action + '">Edit&nbsp;Station&nbsp;Agency</a>';
                } else {
                    action += "createStationAgency(";
                    action += row["marketId"] + "," + row["ownerId"] + "," + row["stationId"] + ",";
                    action += "'" + row["Station Agency"] + "','" + row["Station Category"] + "','" + row["Station Agency Code"] + "'";
                    action += ",'" + row["Station Advertiser"] + "'," + row["linkedAgencyId"] + "," + row["Standard Input ID"] + ");";
                    return '<a href="#" onclick="' + action + '">Match&nbsp;Station&nbsp;Agency</a>';
                }
            },
            "orderable": false,
            "searchable": false,
            "className": "text-align-right"
        });

        return columnsToDisplay;
    }

    function getAgencyExportColumns()
    {
        var columnsToExport = new Array();

        columnsToExport.push(0);
        columnsToExport.push(1);
        columnsToExport.push(2);
        columnsToExport.push(3);
        columnsToExport.push(4);

        return columnsToExport;
    }

    function getMediaAdvertiserColumns() {
        var columnsToDisplay = new Array();

        columnsToDisplay.push({
            "title": "Market",
            "visible": true,
            "mData": "Market",
            "orderable": true,
            "searchable": true
        });

        columnsToDisplay.push({
            "title": "Media Advertiser",
            "visible": true,
            "mData": "Media Advertiser",
            "orderable": true,
            "searchable": true
        });

        columnsToDisplay.push({
            "title": "Media Type",
            "visible": true,
            "mData": "Media Type",
            "orderable": true,
            "searchable": true
        });

        columnsToDisplay.push({
            "title": "Media Period",
            "visible": true,
            "mData": "Media Period",
            "orderable": true,
            "searchable": true
        });


        columnsToDisplay.push({
            "title": "Market Advertiser",
            "visible": true,
            "mData": "Market Advertiser",
            "orderable": true,
            "searchable": true
        });

        columnsToDisplay.push({
            "title": "Market Category",
            "visible": true,
            "mData": "Market Category",
            "orderable": true,
            "searchable": true
        });

        columnsToDisplay.push({
            "title": "Market Sub-Category",
            "visible": true,
            "mData": "Market Sub-Category",
            "orderable": true,
            "searchable": true
        });

        columnsToDisplay.push({
            "mRender": function (data, type, row) {
                var action = "";
                //pass the advertiser name, station category
                if (row["linkedAdvertiserId"] > 0) {
                    action = "";
                    action += "editMediaAdvertiser(";
                    action += "'" + row["Media Category"] + "'," + row["linkedAdvertiserId"] + ","+ row["Standard Media Input ID"] + ");";
                    return '<a href="#" onclick="' + action + '">Edit&nbsp;Media&nbsp;Advertiser</a>';
                } else {
                    action = "";
                    action += "createMediaAdvertiser(";
                    action += row["marketId"] + ",'" + row["mediaTypeId"] + "','" + row["Media Advertiser"] + "'";
                    action += ",'" + row["Media Category"] + "','" + row["Media Advertiser Code"] + "'";
                    action += "," + row["linkedAdvertiserId"] + "," + row["Standard Media Input ID"] + ");";
                    return '<a href="#" onclick="' + action + '">Match&nbsp;Media&nbsp;Advertiser</a>';
                }
            },
            "orderable": false,
            "searchable": false,
            "className": "text-align-right"
        });

        return columnsToDisplay;
    }

    function getMediaAdvertiserExportColumns() {
        var columnsToExport = new Array();

        columnsToExport.push(0);
        columnsToExport.push(1);
        columnsToExport.push(2);
        columnsToExport.push(3);
        columnsToExport.push(4);
        columnsToExport.push(5);
        columnsToExport.push(6);

        return columnsToExport;
    }

    function createStationAdvertiser(marketId, ownerId, stationId, advertiserName, category, stationAdvertiserCode, stationAgency, linkedAdvertiserId, standardInputId) {
        /*
         * load object
         * save object to local storage
         * redirect to station advertiser CRUD page
         * add flag to notate coming from this page
         */

        //use what is passed in for the edit functionality
        setLocalStorage("StandardInputId", standardInputId);
        var queryString = buildPreviousPageQueryString();

        var advertiserMatchData =
            {
                period: $("#ddlPeriod").val(),
                year: $("#ddlYear").val(),
                station: stationId,
                advertiser: advertiserName,
                market: marketId,
                stationAdvertiserCode: stationAdvertiserCode,
                advertiserCategory: category,
                stationAgency: stationAgency,
                previousPage: "/products/xry/revenue/xrymatch.html" + queryString
            }

        setLocalStorage("newAdvertiserMatch", JSON.stringify(advertiserMatchData));

        window.location = "/admin/stationadvertiser/stationadvertiser.html?StationAdvertiserID=" + linkedAdvertiserId + "&AdvMatch=true";

    }

    function editStationAdvertiser(category, stationAgency, linkedAdvertiserId, standardInputId) {
        /*
         * load object
         * save object to local storage
         * redirect to station advertiser CRUD page
         * add flag to notate coming from this page
         */

        //use what is passed in for the edit functionality
        setLocalStorage("StandardInputId", standardInputId);
        var queryString = buildPreviousPageQueryString();

        var advertiserMatchData =
            {
                period: $("#ddlPeriod").val(),
                year: $("#ddlYear").val(),
                advertiserCategory: category,
                stationAgency: stationAgency,
                previousPage: "/products/xry/revenue/xrymatch.html" + queryString
            }

        setLocalStorage("newAdvertiserMatch", JSON.stringify(advertiserMatchData));

        window.location = "/admin/stationadvertiser/stationadvertiser.html?StationAdvertiserID=" + linkedAdvertiserId + "&AdvMatch=true";

    }

    function createStationAgency(marketId, ownerId, stationId, agencyName, category, stationAgencyCode, stationAdvertiser, linkedAgencyId, standardInputId) {
        /*
         * load object
         * save object to local storage
         * redirect to station agency CRUD page
         * add flag to notate coming from this page
         */

        setLocalStorage("StandardInputId", standardInputId);
        var queryString = buildPreviousPageQueryString();

        var agencyMatchData =
            {
                period: $("#ddlPeriod").val(),
                year: $("#ddlYear").val(),
                station: stationId,
                agency: agencyName,
                market: marketId,
                stationAgencyCode: stationAgencyCode,
                agencyCategory: category,
                stationAdvertiser: stationAdvertiser,
                previousPage: "/products/xry/revenue/xrymatch.html" + queryString
            }


        setLocalStorage("newAgencyMatch", JSON.stringify(agencyMatchData));

        window.location = "/admin/stationagency/stationagency.html?StationAgencyID=" + linkedAgencyId + "&AgyMatch=true";
    }

    function editStationAgency(category, stationAdvertiser, linkedAgencyId, standardInputId) {
        /*
         * load object
         * save object to local storage
         * redirect to station agency CRUD page
         * add flag to notate coming from this page
         */
        setLocalStorage("StandardInputId", standardInputId);
        var queryString = buildPreviousPageQueryString();

        var agencyMatchData =
            {
                period: $("#ddlPeriod").val(),
                year: $("#ddlYear").val(),
                agencyCategory: category,
                stationAdvertiser: stationAdvertiser,
                previousPage: "/products/xry/revenue/xrymatch.html" + queryString
            }

        setLocalStorage("newAgencyMatch", JSON.stringify(agencyMatchData));

        window.location = "/admin/stationagency/stationagency.html?StationAgencyID=" + linkedAgencyId + "&AgyMatch=true";
    }

    function createMediaAdvertiser(marketId, mediaTypeId, mediaAdvertiser, category, mediaAdvertiserCode, linkedAdvertiserId, standardInputId)
    {
        setLocalStorage("MediaStandardInputId", standardInputId);
        var advertiserMatchData =
        {
            period: $("#ddlPeriod").val(),
            year: $("#ddlYear").val(),
            market: marketId,
            mediaType: mediaTypeId,
            mediaAdvertiser: mediaAdvertiser,
            mediaAdvertiserCode: mediaAdvertiserCode,
            advertiserCategory: category
        }

        setLocalStorage("newMediaMatch", JSON.stringify(advertiserMatchData));

        window.location = "/admin/mediaadvertiser/mediaadvertiser.html?MediaAdvertiserID=" + linkedAdvertiserId + "&AdvMatch=true";
    }

    function editMediaAdvertiser(category, linkedAdvertiserId, standardInputId)
    {
        setLocalStorage("MediaStandardInputId", standardInputId);
        var advertiserMatchData =
        {
            period: $("#ddlPeriod").val(),
            year: $("#ddlYear").val(),
            advertiserCategory: category
        }

        setLocalStorage("newMediaMatch", JSON.stringify(advertiserMatchData));

        window.location = "/admin/mediaadvertiser/mediaadvertiser.html?MediaAdvertiserID=" + linkedAdvertiserId + "&AdvMatch=true";

    }

    function buildPreviousPageQueryString() {
        var queryString = "";

        queryString += "?Period=" + $("#ddlPeriod").val();
        queryString += "&Year=" + $("#ddlYear").val();
        queryString += "&OwnerID=" + $("#ddlOwner").val();
        queryString += "&MarketID=" + $("#ddlMarket").val();
        queryString += "&StationID=" + $("#ddlStation").val();
        queryString += "&MatchPage=" + matchPageType;
        queryString += "&OptionFlag=" + $("#ddlOptions").val();
        return queryString;
    }

    

    function getMarketListByProduct(inProduct) {
        var control = "ddlMarket";

        if (inProduct == "" || inProduct == null || inProduct == undefined) {
            var str = '';
            str = '<option value="">-- Select a Market --</option>';
            $("#" + control).html(str);
            convertToChosenSelect(control, gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);
            return;
        }

        $.ajax({
            url: ServicePrefix + '/api/Market/GetMarketListByProduct',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inProductId": product,
                "inActiveOnly ": true
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {

                    var str = '';
                    str = '<option value="">-- Select a Market --</option>';
                    $.each(data.report.rows, function (index) {
                        str = str + '<option value="' + data.report.rows[index].marketId + '">' + data.report.rows[index].marketName + ' (' + data.report.rows[index].marketId + ')' + '</option>';

                    });

                    $("#" + control).html(str);
                    convertToChosenSelect(control, gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);

                    $("#" + control).val(marketId);

                    getOwnerListByProduct(product);
                }


            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });

    }

    function getOwnerListByProduct(inProduct) {
        var control = "ddlOwner";

        if (inProduct == "" || inProduct == null || inProduct == undefined) {
            $("#" + control).html("<option value=''>-- Select an Owner --</option>");
            convertToChosenSelect(control, gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);
            return;
        }

        $.ajax({
            url: ServicePrefix + '/api/Owner/GetOwnerListByProduct',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inProductId": product
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {

                    var str = '';

                    $("#" + control).html("<option value=''>-- Select an Owner --</option>");

                    $.each(data.report.rows, function (index) {
                        var obj = data.report.rows[index];
                        str = str + "<option value='" + obj.ownerid + "'>" + obj.ownername + "</option>";

                    });
                    $("#" + control).append(str);
                    convertToChosenSelect(control, gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);

                    $("#" + control).val(ownerId);

                    getStations();

                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });

    }

    function getStations() {

        var control = "ddlStation";

        if ($("#ddlMarket").val() == "" && $("#ddlOwner").val() == "") {
            //create a blank version to have a standard width ddl for stations.
            $("#" + control).html("<option value=''>-- Select a Station --</option>");
            convertToChosenSelect(control, gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);

            getMatchingReport();

            return;
        }

        var stationApi = "/api/Station/GetStationList";

        $.ajax({
            url: ServicePrefix + stationApi,
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inProductId": product,
                "inMarketId": $("#ddlMarket").val(),
                "inOwnerId": $("#ddlOwner").val(),
                "inActiveOnly": true,
                "inExcludeBAStations": true
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {

                    var str = '';

                    $("#" + control).html("<option value=''>-- Select a Station --</option>");

                    $.each(data.report.rows, function (index) {
                        var obj = data.report.rows[index];
                        str = str + "<option value='" + obj.stationId + "'>" + obj.stationName + "</option>";

                    });

                    $("#" + control).append(str);
                    convertToChosenSelect(control, gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);

                    $("#" + control).val(stationId);

                    if ($("#ddlMarket").val() !== "" ||
                        $("#ddlOwner").val() !== "" ||
                        $("#ddlStation").val() !== "") {

                        getMatchingReport();

                    }
                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });
    }

    function getMediaAdvertiserMediaTypeList() {

        $.ajax({
            url: ServicePrefix + '/api/MediaAdvertiser/GetMediaAdvertiserMediaTypeList',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken")
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {

                    var str = '';
                    str = '<option value="">-- Select a Media Type --</option>';
                    $.each(data.report.rows, function (index) {

                        str = str + '<option value="' + data.report.rows[index].mediaTypeId + '">' + data.report.rows[index].mediaType + '</option>';

                    });

                    $("#ddlMediaType").html(str);

                    convertToChosenSelect('ddlMediaType', gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);

                    console.log(mediaType);
                    if (mediaType.length > 0) {
                        $("#ddlMediaType").val(mediaType.toUpperCase());
                    } else {
                        $("#ddlMediaType").val("");
                    }

                }


            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });

    }

    function getMatchingReport() {

        //fix validation right now only will look at year and period
        if (validationPassed() === false) {
            return;
        }

        //loadReportParameters();

        //this now needs to be based on radio button selection
        if ($('#rdoMedia').is(':checked')) {
            //go do the media items
            getMediaAdvertiserData();
        } else {
            //go do the station/agency items
            getStationAgencyData();
        }

    }

    function getMediaAdvertiserData() {
        //GetMediaAccountListForMatching

        //should only continue
        //has market, media type, period and year
        if ($("#ddlMarket").val() == "" ||
            $("#ddlMediaType").val() == "" ||
            $("#ddlYear").val() == "" ||
            $("#ddlPeriod").val() == "")
        {
            return;
        }

        var bIncludeMatched = false;
        var bIncludeUnMatched = false;

        switch ($("#ddlOptions").val().toLowerCase()) {
            case 'unmatched':
                bIncludeMatched = false;
                bIncludeUnMatched = true;
                break;
            case 'matched':
                bIncludeMatched = true;
                bIncludeUnMatched = false;
                break;
            case 'both':
                bIncludeMatched = true;
                bIncludeUnMatched = true;
                break;
            default:
                bIncludeMatched = false;
                bIncludeUnMatched = true;
                break;
        }

        $.ajax({
            url: ServicePrefix + "/api/XRAYRevenue/GetMediaAccountListForMatching",
            dataType: 'json',
            type: 'post',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inPeriod": $("#ddlPeriod").val(),
                "inYear": $("#ddlYear").val(),
                "inMarketId": $("#ddlMarket").val(),
                "inMediaTypeId": $("#ddlMediaType").val(),
                "inIncludeUnmatched": bIncludeUnMatched,
                "inIncludeMatched": bIncludeMatched
            }),
            contentType: 'application/json',
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {
                    loadMediaAdvertiserData(data);
                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });

    }

    function loadMediaAdvertiserData(data) {
        var columns = getMediaAdvertiserColumns();
        var columnsToExport = getMediaAdvertiserExportColumns();
        var title = "Third Party Advertisers Matching Report";
        loadResults(data, columns, title, columnsToExport);
    }

    function getStationAgencyData() {
        var bIncludeAdvertiserMatched = false;
        var bIncludeAgencyMatched = false;
        var bIncludeBothMatched = true;
        var bDistinctAdvertisers = false;
        var bDistinctAgencies = false;
        var bIncludeAdvertiserUnmatched = false;
        var bIncludeAgencyUnmatched = false;

        //keep getting error that options is null
        //not sure what is causing the issue
        if ($('#rdoAgency').is(':checked')) {
            if ($("#ddlOptions").val().toLowerCase() == "unmatched") {
                bIncludeAgencyMatched = false;
                bIncludeAgencyUnmatched = true;
                bDistinctAgencies = false;
                bIncludeAdvertiserMatched = true;
                bIncludeAdvertiserUnmatched = true;
            } else if ($("#ddlOptions").val().toLowerCase() == "matched") {
                bIncludeAgencyMatched = true;
                bIncludeAgencyUnmatched = false;
                bDistinctAgencies = false;
                bIncludeAdvertiserMatched = true;
                bIncludeAdvertiserUnmatched = true;
            } else if ($("#ddlOptions").val().toLowerCase() == "both") {
                bIncludeAgencyMatched = true;
                bIncludeAgencyUnmatched = true;
                bDistinctAgencies = false;
                bIncludeAdvertiserMatched = true;
                bIncludeAdvertiserUnmatched = true;
            } else {
                bIncludeAgencyMatched = false;
                bIncludeAgencyUnmatched = true;
                bDistinctAgencies = false;
                bIncludeAdvertiserMatched = true;
                bIncludeAdvertiserUnmatched = true;
            }
        } else //should be advertisers at this point
        {
           
            if ($("#ddlOptions").val().toLowerCase() == "unmatched") {
                bIncludeAdvertiserMatched = false;
                bIncludeAdvertiserUnmatched = true;
                bDistinctAdvertisers = false;
                bIncludeAgencyMatched = true;
                bIncludeAgencyUnmatched = true;

            } else if ($("#ddlOptions").val().toLowerCase() == "matched") {
                bIncludeAdvertiserMatched = true;
                bIncludeAdvertiserUnmatched = false;
                bDistinctAdvertisers = false;
                bIncludeAgencyMatched = true;
                bIncludeAgencyUnmatched = true;

            } else if ($("#ddlOptions").val().toLowerCase() == "both") {
                bIncludeAdvertiserMatched = true;
                bIncludeAdvertiserUnmatched = true;
                bDistinctAdvertisers = false;
                bIncludeAgencyMatched = true;
                bIncludeAgencyUnmatched = true;
            } else {
                bIncludeAdvertiserMatched = false;
                bIncludeAdvertiserUnmatched = true;
                bDistinctAdvertisers = false;
                bIncludeAgencyMatched = true;
                bIncludeAgencyUnmatched = true;
            }
        }


        $.ajax({
            url: ServicePrefix + "/api/XRAYRevenue/GetStationAccountListForMatching",
            dataType: 'json',
            type: 'post',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inPeriod": $("#ddlPeriod").val(),
                "inYear": $("#ddlYear").val(),
                "inMarketId": $("#ddlMarket").val(),
                "inOwnerId": $("#ddlOwner").val(),
                "inStationId": $("#ddlStation").val(),
                "inIncludeAdvertiserMatched": bIncludeAdvertiserMatched,
                "inIncludeAgencyMatched": bIncludeAgencyMatched,
                "inIncludeBothMatched": bIncludeBothMatched,
                "inDistinctAdvertisers": bDistinctAdvertisers,
                "inDistinctAgencies": bDistinctAgencies,
                "inIncludeAdvertiserUnmatched": bIncludeAdvertiserUnmatched,
                "inIncludeAgencyUnmatched": bIncludeAgencyUnmatched
            }),
            contentType: 'application/json',
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {

                    //if (matchPageType.toUpperCase() == "AGY") {
                    if ($('#rdoAgency').is(':checked')) {
                        //populate datatable with agency stuff
                        loadAgencyData(data);
                    }
                    else {
                        //populate datatable with advertiser stuff
                        loadAdvertiserData(data);
                    }

                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });
    }

    function loadAdvertiserData(data) {
        //get columns
        var columns = getAdvertiserColumns();
        var columnsToExport = getAdvertiserExportColumns();
        var title = "Advertisers Matching Report";
        loadResults(data, columns, title, columnsToExport);
    }

    function loadAgencyData(data) {
        //get columns
        var columns = getAgencyColumns();
        var columnsToExport = getAgencyExportColumns();
        var title = "Agencies Matching Report";
        loadResults(data, columns, title, columnsToExport);

    }

    function loadResults(data, columns, reportTitle, columnsToExport) {
        //data is the data from the ajax call
        //columns is the array that was built previously

        //assigns the data from the ajax call
        var results = data["report"]["rows"];

        //creating a variable that will used for datatable functions later
        var searchTable;

        //if the datatable already exists need to destroy it before building it
        //again with new results from the search.
        //if you try to destroy before it is a datatable, an error will occur.
        //this code will only destroy it if the table is a datatable.
        if ($.fn.DataTable.isDataTable('#dtResults')) {
            searchTable = $('#dtResults').DataTable();
            searchTable.destroy();
        }

        resetDataTableDOM("dtResults", "dtResultsHolder", "cell-border dataTable-border dataTable-headers dataTable-cell-border");

        //this code rebuilds the datatable with the updated data from the search
        //or initial load.


        searchTable = $("#dtResults").DataTable({
            "dom": "Blfrtip",
            "pageLength": gDataTableDefaultRows,
            "order": [],
            "data": results,
            "columns": columns,
            "select": true,
            language: {
                search: "Filter Results:"
            },
            "buttons": [
               {
                   extend: 'excel',
                   title: reportTitle,
                   exportOptions: {
                       columns: columnsToExport
                   }
               },
               {
                   extend: 'print',
                   title: reportTitle,
                   exportOptions: {
                       columns: columnsToExport

                   }
               }
            ]
        });
    }

    function validationPassed() {

        var loopBreak = true;

        $(".mkaRequired").each(function (index, el) {

            var eID = "#" + $(el).attr("id");
            var errorMessage = $(el).attr("errorMessage");

            // Text
            if ($(eID).prop('tagName').toLowerCase() === "input") {
                if ($(eID).val().trim() === "") {
                    bootbox.alert(errorMessage, function () { });
                    loopBreak = false;
                    return false;
                }
            }

            // Select
            if ($(eID).prop('tagName').toLowerCase() === "select") {
                if ($(eID).val() === "-1" || $(eID).val() === "") {
                    bootbox.alert(errorMessage, function () { });
                    loopBreak = false;
                    return false;
                }
            }

        });

        return loopBreak;
    }

</script>
<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->
<head>
    <title></title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>MKA Internal Media Site</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Facebook and Twitter integration -->
    <meta property="og:title" content="" />
    <meta property="og:image" content="" />
    <meta property="og:url" content="" />
    <meta property="og:site_name" content="" />
    <meta property="og:description" content="" />
    <meta name="twitter:title" content="" />
    <meta name="twitter:image" content="" />
    <meta name="twitter:url" content="" />
    <meta name="twitter:card" content="" />

    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <link rel="shortcut icon" href="favicon.ico">

    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,300,700,900' rel='stylesheet' type='text/css'>

    <link href="https://fonts.googleapis.com/css?family=Playfair+Display:400,700" rel="stylesheet">

    <!-- Animate.css -->
    <link rel="stylesheet" href="/css/animate.css">
    <!-- Icomoon Icon Fonts-->
    <link rel="stylesheet" href="/css/icomoon.css">
    <!-- Simple Line Icons -->
    <link rel="stylesheet" href="/css/simple-line-icons.css">
    <!-- Bootstrap  -->
    <link rel="stylesheet" href="/css/bootstrap.css">
    <!-- Theme style  -->
    <link rel="stylesheet" href="/css/style.css">

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.18/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.2/css/responsive.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.5.2/css/buttons.dataTables.min.css" />
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <!--Chosen Dropdown-->
    <link rel="stylesheet" href="/css/chosen.min.css" />

    <!-- Modernizr JS -->
    <script src="/js/modernizr-2.6.2.min.js"></script>
    <!-- FOR IE9 below -->
    <!--[if lt IE 9]>
    <script src="js/respond.min.js"></script>
    <![endif]-->

    <style>
        .rptView {
            margin-left: 5px;
            vertical-align: top;
            display: inline-block;
        }

        .rtpViewRight {
            margin-right: 5px;
            vertical-align: top;
            display: inline-block;
        }

        .rdo-label {
            padding-left: 5px;
        }

        .rptStartDate, .rptEndDate {
            /*max-width:100px;*/
            text-align: center;
        }

        .container {
            width: 100% !important;
        }

        .requiredText {
            color: red !important;
        }

        .rptButton {
            vertical-align: top;
            display: inline-block;
            float: right;
        }

        select {
            max-width: 200px;
        }

        .vertical-center {
            /*margin: 0;
            position: absolute;
            top: 50%;
            -ms-transform: translateY(-50%);
            transform: translateY(-50%);*/
            vertical-align: middle;
        }
    </style>

</head>
<body>
    <div id="fh5co-page">
        <header id="fh5co-header" role="banner">
            <div class="container">
                <div class="header-inner" id="menu"></div>
            </div>
        </header>

        <div id="fh5co-contact-section" class="contact-section">
            <div class="container">
                <div id="divQuickReport" style="float:right;padding-right:0px;padding-bottom:10px">
                    <label for="ddlQuickReport" class="search-ddl-label" style="text-align:right">Reports:&nbsp;</label>
                    <select class="search-ddl-select" onchange="getQuickReport(this.value)" style="width:207px;font-size:14px" id="ddlQuickReport"></select>
                </div>
                <div class="row" id="reportTitleRow">
                    <div class="col-md-6 col-md-offset-3 text-center fh5co-heading">
                        <h2 id="pageTitle">X-Ray Data Collection</h2>
                    </div>
                </div>

                <div class="row search-section">
                    <div class="col-md-12">
                        <!--
                        radio buttons market, owner

                        market set display and load market list
                        GetMarketListByProduct

                        owner set display and load owner list
                        GetOwnerListByProduct

                        station list
                        GetStationListByProduct


                        media dropdown
                        figure out what needs to load it
                        do we need if not taken in by stored procedure??

                        year dropdown
                        period dropdown

                        button to get list


                        -->
                        <!-- fix spacing on the radio buttons instead of spaces -->
                        <div class="form-group rptView vertical-center">
                            <input type="radio" name="collectionType" id="rdoMarket" value="market"><label class="rdo-label rtpViewRight" for="rdoMarket">Market</label>
                            <br />
                            <input type="radio" name="collectionType" id="rdoOwner" value="owner"><label class="rdo-label rtpViewRight" for="rdoOwner">Owner</label>
                            <br />
                            <input type="radio" name="collectionType" id="rdoThirdParty" value="thirdParty"><label class="rdo-label rtpViewRight" for="rdoThirdParty">Third Party</label>
                        </div>

                        <div class="form-group rptView collection-market vertical-center">
                            <label for="ddlMarket" class="dropdown-label rptView">Market</label>
                            <select id="ddlMarket" apiInput="inMarketId" onchange="" class="dropdown-select rptView"></select>
                        </div>

                        <div class="form-group rptView collection-owner vertical-center">
                            <label for="ddlOwner" class="dropdown-label rptView">Owner</label>
                            <select id="ddlOwner" apiInput="inOwnerId" onchange="" class="dropdown-select rptView"></select>
                        </div>

                        <div class="form-group rptView collection-station vertical-center">
                            <label for="ddlStation" class="dropdown-label rptView">Station</label>
                            <select id="ddlStation" apiInput="inStationId" onchange="" class="dropdown-select rptView"></select>
                        </div>

                        <div class="form-group rptView vertical-center">
                            <label for="ddlYear" class="dropdown-label rptView">Year</label>
                            <select id="ddlYear" apiInput="inYear" class="dropdown-select rptView"></select>
                        </div>

                        <div class="form-group rptView vertical-center">
                            <label for="ddlPeriod" class="dropdown-label rptView">Period</label>
                            <select id="ddlPeriod" apiInput="inPeriod" class="dropdown-select rptView"></select>
                        </div>

                        <div class="form-group rptButton vertical-center" style="float:none;text-align:left">
                            <label for="btnReport" class="dropdown-label">&nbsp;</label>
                            <input type="button" id="btnReport" class="search-button" value="Show" onclick="getDataCollectionList()" />
                        </div>

                    </div>
                </div>

                <!-- datatable -->
                <div class="dataTable-top-margin">
                    <table id="dtResults" class="stripe"></table>
                    <div id="noDataFound" style="display: none; color: red">No data found</div>
                </div>

            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="/js/jquery.min.js"></script>
    <!-- jQuery Easing -->
    <script src="/js/jquery.easing.1.3.js"></script>
    <!-- Bootstrap -->
    <script src="/js/bootstrap.min.js"></script>
    <!-- Bootbox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
    <!-- Waypoints -->
    <script src="/js/jquery.waypoints.min.js"></script>
    <!-- BlockUI JS -->
    <script src="/js/blockUI.js"></script>
    <!-- Config JS -->
    <script src="/js/config.js"></script>
    <!-- MAIN JS -->
    <script src="/js/main.js"></script>
    <!-- genericReport JS -->
    <script src="/js/genericReport.js"></script>

    <script type="text/javascript" src="https://cdn.datatables.net/1.10.18/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.print.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.colVis.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <!--Chosen Dropdown-->
    <script src="/js/chosen.jquery.min.js"></script>
</body>
</html>
<script>

    var product = "XRY";
    var workingMarketId = 0;
    var workingStationId = 0;
    var workingPeriod = "";
    var workingYear = "";
    var bRevision = false;
    var bCorrection = false;
    var workingRevisionNumber = 0;

    $(document).ready(function () {

        buildXRYMenu("Revenue");
        buildQuickReports(['xry']);
        setupUI();

        //load periods
        loadPeriods();
        //load years
        loadYears();
        //load markets
        getMarketListByProduct(product);

    });

    function setupUI() {

        $("#rdoMarket").prop("checked", true);

        $('input[type=radio][name=collectionType]').change(function () {

            $("#ddlMarket").val("").change();
            $("#ddlOwner").val("");

            if (this.value == 'market') {
                //show market dropdown
                //load stations and show
                //hide owner dropdown

                $(".collection-market").show();
                $(".collection-station").show();
                $(".collection-owner").hide();
            }
            else if (this.value == 'owner') {
                //show owner dropdown
                $(".collection-owner").show();
                //hide market and stations
                $(".collection-market").hide();
                $(".collection-station").hide();
            } else if (this.value == 'thirdParty') {
                bootbox.alert(
                    "Functionality under development.",
                    function () {
                        
                    }
                );
            }

        });

        $("#ddlMarket").change(function () {
            getStations();
        });

        $('.collection-owner').hide();

    }

    function loadPeriods() {

        getPeriodList(); //does this only need to be months or do quarters need to be included

    }

    function loadYears() {

        getYearList();

    }

    function getMarketListByProduct(inProduct) {
        var control = "ddlMarket";

        if (inProduct === "" || inProduct == null || inProduct == undefined) {
            var str = '';
            str = '<option value="">-- Select a Market --</option>';
            $("#" + control).html(str);
            convertToChosenSelect(control, gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);
            return;
        }

        $.ajax({
            url: ServicePrefix + '/api/Market/GetMarketListByProduct',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inProductId": product,
                "inActiveOnly ": true
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {

                    var str = '';
                    str = '<option value="">-- Select a Market --</option>';
                    $.each(data.report.rows, function (index) {

                        str = str + '<option value="' + data.report.rows[index].marketId + '">' + data.report.rows[index].marketName + ' (' + data.report.rows[index].marketId + ')' + '</option>';

                    });

                    $("#" + control).html(str);
                    convertToChosenSelect(control, gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);

                    //$("#" + control).val(marketId);

                    getOwnerListByProduct(product);
                }


            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });

    }

    function getOwnerListByProduct(inProduct) {
        var control = "ddlOwner";

        if (inProduct == "" || inProduct == null || inProduct == undefined) {
            $("#" + control).html("<option value=''>-- Select an Owner --</option>");
            convertToChosenSelect(control, gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);
            return;
        }

        $.ajax({
            url: ServicePrefix + '/api/Owner/GetOwnerListByProduct',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inProductId": product
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {

                    var str = '';

                    $("#" + control).html("<option value=''>-- Select an Owner --</option>");

                    $.each(data.report.rows, function (index) {
                        var obj = data.report.rows[index];
                        str = str + "<option value='" + obj.ownerid + "'>" + obj.ownername + "</option>";

                    });
                    $("#" + control).append(str);
                    convertToChosenSelect(control, gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);

                    //$("#" + control).val(ownerId);

                    getStations();
                    //saveLoadedControlSelection(control);
                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });

    }

    function getStations() {

        var control = "ddlStation";

        if ($("#ddlMarket").val() == "") {
            //create a blank version to have a standard width ddl for stations.
            $("#" + control).html("<option value=''>-- Select a Station --</option>");
            convertToChosenSelect(control, gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);
            return;
        }

        var stationApi = "/api/Station/GetStationList";

        $.ajax({
            url: ServicePrefix + stationApi,
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inProductId": product,
                "inMarketId": $("#ddlMarket").val(),
                "inOwnerId": $("#ddlOwner").val(),
                "inActiveOnly": true,
                "inExcludeBAStations": true
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {

                    var str = '';

                    $("#" + control).html("<option value=''>-- Select a Station --</option>");

                    $.each(data.report.rows, function (index) {
                        var obj = data.report.rows[index];
                        str = str + "<option value='" + obj.stationId + "'>" + obj.stationName + "</option>";

                    });

                    $("#" + control).append(str);
                    convertToChosenSelect(control, gChosenParams.allowSearchContains, gChosenParams.allowSplitWordSearch);

                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });
    }

    //unpost revenue process
    function unpostRevenueProcess(stationId, marketId, period, year, stationName) {
       
        workingStationId = stationId;
        workingMarketId = marketId;
        workingPeriod = period;
        workingYear = year;

        //getMarketPeriodYearLatestRevision
        //may need to create a new version for unposting
        //if ask if want to re-post
        //what needs to happen??
        //reset market status
        //reset station status
        //delete station revenue

        getMarketPeriodYearLatestRevisionForUnposting(workingMarketId, workingPeriod, workingYear, stationName);
    }

    function getMarketPeriodYearLatestRevisionForUnposting(marketId, period, year, stationName) {

        var queryString = "";

        queryString += "?inApiToken=" + getLocalStorage("APIToken");
        queryString += "&inMarketId=" + marketId;
        queryString += "&inPeriod=" + period;
        queryString += "&inYear=" + year;

        var latestRevisionApi = "/api/XRAYRevenue/GetLatestRevisionByMarketYearPeriod" + queryString;

        $.ajax({
            url: ServicePrefix + latestRevisionApi,
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {

                    var results = data["report"]["rows"];

                    if (results.length > 0 && results[0]["Release Date"] !== null) {

                        var strMessage = "";
                        strMessage +=
                            "The market has already been released and " + stationName + " cannot be re-posted.";

                        bootbox.alert(strMessage,
                            function () {

                            });
                        
                        return;

                    } else if (results.length > 0 && results[0]["Release Date"] === null) {
                       
                        //display dialog to reformat
                        var strMessage = "";
                        strMessage += "Do you want to un-post this station - " + stationName + "?";

                        bootbox.dialog({
                            message: strMessage,
                            title: "Un-post Station",
                            buttons:
                            {
                                btnRevision: {
                                    label: "Un-Post",
                                    className: "btn-primary",
                                    callback: function () {

                                        workingRevisionNumber = results[0]["Revision Number"];

                                        updateMarketYearPeriodPostedStatusForUnposting();

                                    }
                                },
                                btnCancel: {
                                    label: "Cancel",
                                    callback: function () {
                                        return;
                                    }
                                }
                            }
                        });

                    }
                    else {
                        return;
                    }

                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });
    }

    function updateMarketYearPeriodPostedStatusForUnposting() {

        var updateMarketYearPeriodPostedStatusApi = "/api/XRAYRevenue/UpdatePostedStatusByMarketYearPeriod";

        $.ajax({
            url: ServicePrefix + updateMarketYearPeriodPostedStatusApi,
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inMarketId": workingMarketId,
                "inPeriod": workingPeriod,
                "inYear": workingYear,
                "inRevisionNumber": workingRevisionNumber,
                "inPosted": false
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {
                    //un-post station
                    updateStationYearPeriodPostedStatusForUnposting();
                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });
    }

    function updateStationYearPeriodPostedStatusForUnposting() {
        //if the postedFlag is set to true, this is the second pass
        //and saying that the station has been posted.
        //At that point, start working on updating the status of the market.

        var updateStationYearPeriodPostedStatusApi = "/api/XRAYRevenue/UpdatePostedStatusByStationYearPeriod";

        $.ajax({
            url: ServicePrefix + updateStationYearPeriodPostedStatusApi,
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inStationId": workingStationId,
                "inPeriod": workingPeriod,
                "inYear": workingYear,
                "inPosted": false
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {

                    //delete the revenue
                    unpostRevenueByStationYearPeriodForUnposting();
                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });
    }

    function unpostRevenueByStationYearPeriodForUnposting() {

        var unpostRevenueByStationYearPeriodApi = "/api/XRAYRevenue/UnpostRevenueByStationYearPeriod";

        $.ajax({
            url: ServicePrefix + unpostRevenueByStationYearPeriodApi,
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inStationId": workingStationId,
                "inPeriod": workingPeriod,
                "inYear": workingYear
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {
                    
                    bootbox.alert(
                        "The station has been un-posted.",
                        function () {

                        }
                    );

                    //reload the page.
                    getDataCollectionList();

                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });

    }
    //end unpost revenue process

    //start post revenue functionality
    function postRevenueProcess(stationId, marketId, period, year, stationName) {
    
        //The overall flow of how the posting process works
        //see if the market is already released for that period - getMarketPeriodYearLatestRevision
        //get the latest revision number and initialize revision - initiateRevision
        //determine if there are any off-season submissions with revenue - checkForOffSeasonSubmissionsWithRevenue
        //if there are, list the stations and ask whether to delete. If deleted, continue posting process.
        //set the market, period and year as not posted - updateMarketYearPeriodPostedStatus
        //set the station, period and year as not posted - updateStationYearPeriodPostedStatus
        //insert new owner revenue types - addNewOwnerRevenueTypesByStationYearPeriod
        //check for owner revenue types that need mapping - getOwnerRevenueTypesRequiringMapping
        //if there are any that need mapping, the posting process stops. Otherwise, the process will continue.
        //un-post the station, period and year revenue - unpostRevenueByStationYearPeriod
        //post the station, period and year revenue - postRevenueByStationYearPeriod
        //set the station, period and year as posted - updateStationYearPeriodPostedStatus
        //check if the market has un-posted submissions or un-posted media types - getUnpostedSubmissionsByMarketYearPeriod & getUnpostedMediaTypesByMarketYearPeriod
        //if both of these come back with no records, set the market, period and year as posted - updateMarketYearPeriodPostedStatus
        //Either way, let user know that the station has posted.

        workingStationId = stationId;
        workingMarketId = marketId;
        workingPeriod = period;
        workingYear = year;

        var strMessage = "";
        strMessage += "Would you like to post the revenue for the station - " + stationName + "?";

        bootbox.dialog({
            message: strMessage,
            title: "Post Station",
            buttons:
            {
                btnRevision: {
                    label: "Post",
                    className: "btn-primary",
                    callback: function () {
                     
                        getMarketPeriodYearLatestRevision(workingMarketId, workingPeriod, workingYear);

                    }
                },
                btnCancel: {
                    label: "Cancel",
                    callback: function () {

                        return;

                    }
                }
            }
        });

    }

    function getMarketPeriodYearLatestRevision(marketId, period, year) {

        var queryString = "";

        queryString += "?inApiToken=" + getLocalStorage("APIToken");
        queryString += "&inMarketId=" + marketId;
        queryString += "&inPeriod=" + period;
        queryString += "&inYear=" + year;

        var latestRevisionApi = "/api/XRAYRevenue/GetLatestRevisionByMarketYearPeriod" + queryString;

        $.ajax({
            url: ServicePrefix + latestRevisionApi,
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {

                    var results = data["report"]["rows"];

                    if (results.length > 0 && results[0]["Release Date"] !== null) {
                        //prompt question revision, correction, cancel
                        //if not cancelled initiate revision

                        workingRevisionNumber = results[0]["Revision Number"];

                        var strMessage = "";
                        strMessage +=
                            "The market has already been released. <br/> Is this a revision and want to notify recipients when re-release?";
                        strMessage += "<br/>Or is this a correction and should not notify recipients?";

                        bootbox.dialog({
                            message: strMessage,
                            title: "Initiate Revision",
                            buttons:
                            {
                                btnRevision: {
                                    label: "Revision",
                                    className: "btn-primary",
                                    callback: function () {
                                        bRevision = true;
                                        initiateRevision();
                                    }
                                },
                                btnCorrection: {
                                    label: "Correction",
                                    callback: function () {
                                        bCorrection = true;
                                        initiateRevision();
                                    }
                                },
                                btnCancel: {
                                    label: "Cancel",
                                    callback: function () {
                                        return;
                                    }
                                }
                            }
                        });

                    } else if (results.length > 0 && results[0]["Release Date"] === null) {
                        workingRevisionNumber = results[0]["Revision Number"];
                        initiateRevision();
                    }
                    else {
                        workingRevisionNumber = 0;
                        initiateRevision();
                    }

                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });

    }

    function initiateRevision() {

        var initiateRevisionApi = "/api/XRAYRevenue/InitiateRevisionByMarketYearPeriod";

        $.ajax({
            url: ServicePrefix + initiateRevisionApi,
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inMarketId": workingMarketId,
                "inPeriod": workingPeriod,
                "inYear": workingYear
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {

                    //check for off-season submissions with revenue
                    checkForOffSeasonSubmissionsWithRevenue();

                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });

    }

    function checkForOffSeasonSubmissionsWithRevenue() {

        var queryString = "";

        queryString += "?inApiToken=" + getLocalStorage("APIToken");
        queryString += "&inMarketId=" + workingMarketId;
        queryString += "&inPeriod=" + workingPeriod;
        queryString += "&inYear=" + workingYear;

        var offSeasonRevenueApi = "/api/XRAYRevenue/GetOffSeasonSubmissionsWithRevenueByMarketYearPeriod" + queryString;

        $.ajax({
            url: ServicePrefix + offSeasonRevenueApi,
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {

                    var results = data["report"]["rows"];

                    if (results.length > 0) {

                        var strMessage = "";

                        strMessage = "There is off-season revenue for the following stations: <br/><br/>";

                        for (var i = 0; i < results.length; i++) {

                            if (i % 3 && i > 0) {
                                strMessage += "<br/>";
                            }

                            if (i === 0 && results.length === 1) {
                                strMessage += results[i]["Station"];
                            } else {
                                strMessage += results[i]["Station"] + ",";
                            }

                        }

                        //do we list everything out on the dialog??
                        //asked christine, she said that station call letters
                        //would be enough
                        bootbox.dialog({
                            message: strMessage,
                            title: "Has Off Season Submissions with Revenue",
                            buttons:
                            {
                                btnDelete: {
                                    label: "Delete Submissions",
                                    className: "btn-primary",
                                    callback: function () {
                                        //delete submissions
                                        removeOffSeasonSubmissionsWithRevenue();
                                    }
                                },
                                btnCancel: {
                                    label: "Cancel",
                                    callback: function () {
                                        return;
                                    }
                                }
                            }
                        });

                    } else {
                        updateMarketYearPeriodPostedStatus(false);
                    }

                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });
    }

    function removeOffSeasonSubmissionsWithRevenue() {

        var offSeasonRevenueApi = "/api/XRAYRevenue/DeleteOffSeasonSubmissionsWithRevenueByMarketYearPeriod";

        $.ajax({
            url: ServicePrefix + offSeasonRevenueApi,
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inMarketId": workingMarketId,
                "inPeriod": workingPeriod,
                "inYear": workingYear
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {

                    //need to write the function call
                    updateMarketYearPeriodPostedStatus(false);
                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });
    }

    function updateMarketYearPeriodPostedStatus(postedFlag) {

        var updateMarketYearPeriodPostedStatusApi = "/api/XRAYRevenue/UpdatePostedStatusByMarketYearPeriod";

        $.ajax({
            url: ServicePrefix + updateMarketYearPeriodPostedStatusApi,
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inMarketId": workingMarketId,
                "inPeriod": workingPeriod,
                "inYear": workingYear,
                "inRevisionNumber": workingRevisionNumber,
                "inPosted": postedFlag
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {

                    //need to write the function call
                    //may need to split programming path based on posted status flag
                    if (postedFlag === false) {
                        //un-post station
                        updateStationYearPeriodPostedStatus(false);
                    } else {
                        //using this to update the datatable to show the station was posted
                        getDataCollectionList();
                    }
                    //if true there shouldn't be any other steps
                    //but this could change based on any additional flow changes

                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });
    }

    function updateStationYearPeriodPostedStatus(postedFlag) {
        //if the postedFlag is set to true, this is the second pass
        //and saying that the station has been posted.
        //At that point, start working on updating the status of the market.

        var updateStationYearPeriodPostedStatusApi = "/api/XRAYRevenue/UpdatePostedStatusByStationYearPeriod";

        $.ajax({
            url: ServicePrefix + updateStationYearPeriodPostedStatusApi,
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inStationId": workingStationId,
                "inPeriod": workingPeriod,
                "inYear": workingYear,
                "inPosted": postedFlag
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {

                    if (postedFlag) {
                        //go to the process of looking for unposted submissions and unposted media types
                        getUnpostedSubmissionsByMarketYearPeriod();
                    } else {
                        //look for new owner revenue types
                        addNewOwnerRevenueTypesByStationYearPeriod();
                    }

                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });
    }

    function addNewOwnerRevenueTypesByStationYearPeriod() {

        var addOwnerRevenueTypesByStationYearPeriodApi = "/api/XRAYRevenue/AddOwnerRevenueTypesByStationYearPeriod";

        $.ajax({
            url: ServicePrefix + addOwnerRevenueTypesByStationYearPeriodApi,
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inStationId": workingStationId,
                "inPeriod": workingPeriod,
                "inYear": workingYear
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {
                    //get owner revenue types requiring mapping
                    getOwnerRevenueTypesRequiringMapping();
                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });

    }

    function getOwnerRevenueTypesRequiringMapping() {

        var queryString = "";

        queryString += "?inApiToken=" + getLocalStorage("APIToken");
        queryString += "&inStationId=" + workingStationId;
        queryString += "&inPeriod=" + workingPeriod;
        queryString += "&inYear=" + workingYear;

        var offSeasonRevenueApi = "/api/XRAYRevenue/GetOwnerRevenueTypeRequiringMappingByStationYearPeriod" + queryString;

        $.ajax({
            url: ServicePrefix + offSeasonRevenueApi,
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {

                    var results = data["report"]["rows"];

                    if (results.length > 0) {

                        //need to build message and stop processing

                        var strMessage = "";

                        //need to determine what the message and content should be
                        strMessage = "There are owner revenue types that require mapping.";

                        bootbox.alert({
                            message: strMessage,
                            function() {
                                return;
                            }
                        });

                    } else {
                        //unpost revenue by station year and period
                        unpostRevenueByStationYearPeriod();
                    }

                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });
    }

    function unpostRevenueByStationYearPeriod() {

        var unpostRevenueByStationYearPeriodApi = "/api/XRAYRevenue/UnpostRevenueByStationYearPeriod";

        $.ajax({
            url: ServicePrefix + unpostRevenueByStationYearPeriodApi,
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inStationId": workingStationId,
                "inPeriod": workingPeriod,
                "inYear": workingYear
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {
                    //post revenue
                    postRevenueByStationYearPeriod();
                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });

    }

    function postRevenueByStationYearPeriod() {

        var postRevenueByStationYearPeriodApi = "/api/XRAYRevenue/PostRevenueByStationYearPeriod";

        $.ajax({
            url: ServicePrefix + postRevenueByStationYearPeriodApi,
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inStationId": workingStationId,
                "inPeriod": workingPeriod,
                "inYear": workingYear
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {
                    updateStationYearPeriodPostedStatus(true);
                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });

    }

    function getUnpostedSubmissionsByMarketYearPeriod() {

        var queryString = "";

        queryString += "?inApiToken=" + getLocalStorage("APIToken");
        queryString += "&inMarketId=" + workingMarketId;
        queryString += "&inPeriod=" + workingPeriod;
        queryString += "&inYear=" + workingYear;

        var unpostedSubmissionsApi = "/api/XRAYRevenue/GetUnpostedSubmissionsByMarketYearPeriod" + queryString;

        $.ajax({
            url: ServicePrefix + unpostedSubmissionsApi,
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {

                    var results = data["report"]["rows"];

                    if (results.length > 0) {

                        //need to build message and stop processing

                        var strMessage = "";

                        //need to determine what the message and content should be
                        //do i need to let them know??
                        strMessage = "The station has been posted. However, there are un-posted submissions for the market.";

                        bootbox.alert({
                            message: strMessage,
                            function() {
                                //reloading the datatable
                            }
                        });

                        getDataCollectionList();

                    } else {
                        //unpost revenue by station year and period
                        getUnpostedMediaTypesByMarketYearPeriod();
                    }

                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });

    }

    function getUnpostedMediaTypesByMarketYearPeriod() {

        //if no records update the market posted status
        var queryString = "";

        queryString += "?inApiToken=" + getLocalStorage("APIToken");
        queryString += "&inMarketId=" + workingMarketId;
        queryString += "&inPeriod=" + workingPeriod;
        queryString += "&inYear=" + workingYear;

        var unpostedMediaTypesApi = "/api/XRAYRevenue/GetUnpostedMediaTypesByMarketYearPeriod" + queryString;

        $.ajax({
            url: ServicePrefix + unpostedMediaTypesApi,
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {

                    var results = data["report"]["rows"];

                    if (results.length > 0) {

                        //need to build message and stop processing

                        var strMessage = "";

                        //need to determine what the message and content should be
                        //do i even need to let them know??
                        strMessage = "The station has been posted. However, there are un-posted media types for the market.";

                        bootbox.alert({
                            message: strMessage,
                            function() {
                                //reloading the datatable
                            }
                        });

                        getDataCollectionList();

                    } else {
                        //reset the market posted status
                        updateMarketYearPeriodPostedStatus(true);
                    }

                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });

    }
    //end posting functionality

    //other action links
    function enable() {
        bootbox.alert(
            "Functionality under development.",
            function () {

            }
        );
    }

    function disable() {
        bootbox.alert(
            "Functionality under development.",
            function () {

            }
        );
    }

    function changeAvailability(stationId, marketId, ownerId, stationName, mediaType) {

        setLocalStorage("tempStationMarketId", marketId);
        setLocalStorage("tempStationOwnerId", ownerId);
        setLocalStorage("tempStationName", stationName);
        setLocalStorage("tempStationMedia", mediaType);

        window.location = "/products/xry/xrystationproduct.html?StationID=" + stationId;

    }

    //start data table functionality
    //get datatable columns and load data functionality
    function getDataColumns() {
        var columnsToDisplay = new Array();

        columnsToDisplay.push({
            "title": "Station",
            "visible": true,
            "mData": "Station",
            "orderable": true,
            "searchable": true
        });

        columnsToDisplay.push({
            "title": "Market",
            "visible": true,
            "mData": "Market",
            "orderable": true,
            "searchable": true
        });

        columnsToDisplay.push({
            "title": "Submission",
            "visible": true,
            "mData": "Submission",
            "orderable": true,
            "searchable": true
        });

        columnsToDisplay.push({
            "title": "Records",
            "visible": true,
            "mData": "Number of Records",
            "orderable": true,
            "searchable": true,
            "className": "text-align-right"
        });

        columnsToDisplay.push({
            "title": "Advertisers Matched",
            "visible": true,
            "mData": "Advertisers Matched",
            "orderable": true,
            "searchable": true,
            "className": "text-align-right"
        });

        columnsToDisplay.push({
            "title": "Agencies Matched",
            "visible": true,
            "mData": "Agencies Matched",
            "orderable": true,
            "searchable": true,
            "className": "text-align-right"
        });

        columnsToDisplay.push({
            "title": "Rev Rec $",
            "visible": true,
            "mData": "Revenue",
            "mRender": $.fn.dataTable.render.number(',', '.', 0, '$'),
            "orderable": true,
            "searchable": true,
            "className": "text-align-right"
        });

        columnsToDisplay.push({
            "title": "Rev Rec $<br/>Prev Period",
            "visible": true,
            "mData": "Revenue Previous Period",
            "mRender": $.fn.dataTable.render.number(',', '.', 0, '$'),
            "orderable": true,
            "searchable": true,
            "className": "text-align-right"
        });

        columnsToDisplay.push({
            "title": "Rev Rec $<br/>Prev Year",
            "visible": true,
            "mData": "Revenue Previous Year",
            "mRender": $.fn.dataTable.render.number(',', '.', 0, '$'),
            "orderable": true,
            "searchable": true,
            "className": "text-align-right"
        });

        columnsToDisplay.push({
            "title": "Media Type",
            "visible": true,
            "mData": "Media Type",
            "orderable": true,
            "searchable": true
        });

        columnsToDisplay.push({
            "title": "Status",
            "mRender": function (data, type, row) {
                if (row["Posted"].toLowerCase() === "no") {
                    return "Un-Posted";
                } else {
                    return "Posted";
                }
            },
            "visible": true,
            "orderable": true,
            "searchable": true
        });

        columnsToDisplay.push({
            "title": "Enabled",
            "mRender": function (data, type, row) {
                if (row["enabled"] === true) {
                    return "True";
                } else {
                    return "False";
                }
            },
            "visible": true,
            "orderable": true,
            "searchable": true
        });

        columnsToDisplay.push({
            "title": "Actions",
            "mRender": function (data, type, row) {
                //create the list of actions
                var actions = "";
                var parameters = "";

                if (row["enabled"] === true &&
                    row["Number of Records"] > 0 &&
                    row["Advertisers Matched"] === row["Number of Records"] &&
                    row["Agencies Matched"] === row["Number of Records"] &&
                    row["Posted"].toLowerCase() === "no") {

                    parameters = "";
                    parameters += row["stationId"] + "," + row["marketId"];
                    parameters += ",\"" + $("#ddlPeriod").val() + "\"";
                    parameters += ",\"" + $("#ddlYear").val() + "\"";
                    parameters += ",\"" + row["Station"] + "\"";

                    actions += "<a href='#' onclick='postRevenueProcess(" + parameters + ");'>Post</a><br/>";

                }

                if (row["enabled"] === true && row["Posted"].toLowerCase() === "yes") {

                    parameters = "";
                    parameters += row["stationId"] + "," + row["marketId"];
                    parameters += ",\"" + $("#ddlPeriod").val() + "\"";
                    parameters += ",\"" + $("#ddlYear").val() + "\"";
                    parameters += ",\"" + row["Station"] + "\"";

                    actions += "<a href='#' onclick='unpostRevenueProcess(" + parameters + ");'>Un-Post</a><br/>";
                }

                var link = "";

                if (row["Number of Records"] > 0)
                {
                    link = "";
                    link = '/products/xry/revenue/xrymatch.html?MatchPage=adv';
                    link += '&OwnerID=' + row["ownerId"];
                    link += '&MarketID=' + row["marketId"];
                    link += '&StationID=' + row["stationId"];
                    link += '&Period=' + $("#ddlPeriod").val();
                    link += '&Year=' + $("#ddlYear").val();

                    if (row["Number of Records"] !== row["Advertisers Matched"])
                    {
                        link += '&OptionFlag=unmatched';
                        actions += "<a href='" + link + "'>Match&nbsp;Advertisers</a><br/>";
                    } else
                    {
                        link += '&OptionFlag=matched';
                        actions += "<a href='" + link + "'>View&nbsp;Advertisers</a><br/>";
                    }
                }

                if (row["Number of Records"] > 0)
                {
                    link = "";
                    link = '/products/xry/revenue/xrymatch.html?MatchPage=agy';
                    link += '&OwnerID=' + row["ownerId"];
                    link += '&MarketID=' + row["marketId"];
                    link += '&StationID=' + row["stationId"];
                    link += '&Period=' + $("#ddlPeriod").val();
                    link += '&Year=' + $("#ddlYear").val();

                    if (row["Number of Records"] !== row["Agencies Matched"])
                    {
                        link += '&OptionFlag=unmatched';
                        actions += "<a href='" + link + "'>Match&nbsp;Agencies</a><br/>";
                    } else
                    {
                        link += '&OptionFlag=matched';
                        actions += "<a href='" + link + "'>View&nbsp;Agencies</a><br/>";
                    }
                }

                if (row["enabled"] === false) {
                    actions += "<a href='#' onclick='enable();'>Enable</a><br/>";
                }

                if (row["enabled"] === true) {
                    actions += "<a href='#' onclick='disable();'>Disable</a><br/>";
                }

                //page uses local storage
                //use onclick and pass variables
                //set local storage as part of the function
                parameters = "";
                parameters = row["stationId"] +
                    ',' +
                    row["marketId"] +
                    ',' +
                    row["ownerId"] +
                    ',"' +
                    //converted to whitespace to a non-breaking space
                    //the white space was causing an unseen "
                    row["Station"].replace(/[\s]/g, "&nbsp;") +
                    '","' +
                    row["Media Type"] +
                    '"';
                actions += '<a href="#" onclick=changeAvailability(' + parameters + ');>Change&nbsp;Availability</a>';

                return actions;
            },
            "orderable": false,
            "searchable": false,
            "visible": true
        });

        return columnsToDisplay;
    }

    function getDataCollectionList() {
        //determine the validation
        //call new api once built
        //load table with results

        var queryString = "?";

        queryString += "inApiToken=" + getLocalStorage("APIToken");
        queryString += "&inPeriod=" + $("#ddlPeriod").val();
        queryString += "&inYear=" + $("#ddlYear").val();
        queryString += "&inMarketId=" + $("#ddlMarket").val();
        queryString += "&inOwnerId=" + $("#ddlOwner").val();
        queryString += "&inStationId=" + $("#ddlStation").val();

        var collectionStatusApi = "/api/XRAYRevenue/GetReformatListMarketStationOwner" + queryString;

        $.ajax({
            url: ServicePrefix + collectionStatusApi,
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {

                    loadCollectionStatusData(data);

                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });

    }

    function loadCollectionStatusData(data) {
        //get columns
        var columns = getDataColumns();
        loadResults(data, columns);
    }

    function loadResults(data, columns) {
        //data is the data from the ajax call
        //columns is the array that was built previously

        //assigns the data from the ajax call
        var results = data["report"]["rows"];

        //creating a variable that will used for datatable functions later
        var searchTable;

        //if the datatable already exists need to destroy it before building it
        //again with new results from the search.
        //if you try to destroy before it is a datatable, an error will occur.
        //this code will only destroy it if the table is a datatable.
        if ($.fn.DataTable.isDataTable('#dtResults')) {
            searchTable = $('#dtResults').DataTable();
            searchTable.clear().draw();
            searchTable.destroy();
        }

        //this code rebuilds the datatable with the updated data from the search
        //or initial load.


        searchTable = $("#dtResults").DataTable({
            "dom": "Blfrtip",
            "pageLength": gDataTableDefaultRows,
            "order": [],
            //"data": results,
            "columns": columns,
            "select": true,
            language: {
                search: "Filter Results:"
            },
            "buttons": [
                //{
                //    extend: 'excel',
                //    title: reportTitle,
                //    exportOptions: {
                //        columns: columnsToExport
                //    }
                //},
                //{
                //    extend: 'print',
                //    title: reportTitle,
                //    exportOptions: {
                //        columns: columnsToExport

                //    }
                //}
            ]
        });

        //re-drawing the table with the new data
        searchTable.rows.add(results).draw();

    }

    //end datatable functionality

</script>
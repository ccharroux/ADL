
<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>MKA Internal Media Site</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Facebook and Twitter integration -->
    <meta property="og:title" content="" />
    <meta property="og:image" content="" />
    <meta property="og:url" content="" />
    <meta property="og:site_name" content="" />
    <meta property="og:description" content="" />
    <meta name="twitter:title" content="" />
    <meta name="twitter:image" content="" />
    <meta name="twitter:url" content="" />
    <meta name="twitter:card" content="" />
    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <link rel="shortcut icon" href="favicon.ico">
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,300,700,900' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css?family=Playfair+Display:400,700" rel="stylesheet">
    <!-- Animate.css -->
    <link rel="stylesheet" href="/css/animate.css">
    <!-- Icomoon Icon Fonts-->
    <link rel="stylesheet" href="/css/icomoon.css">
    <!-- Simple Line Icons -->
    <link rel="stylesheet" href="/css/simple-line-icons.css">
    <!-- Bootstrap  -->
    <link rel="stylesheet" href="/css/bootstrap.css">
    <!--Chosen Dropdown-->
    <link rel="stylesheet" href="/css/chosen.min.css" />
    <!-- Theme style  -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.18/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.2/css/responsive.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.5.2/css/buttons.dataTables.min.css" />
    <style type="text/css">
        .dropdown-select {
            max-width: 200px;
        }

        .revenue-detail {
            max-width: 100px;
        }

        .implicit-thousands {
            color: #ccc;
        }

        .total-category {
            background-color: #eef;
            font-weight: bold;
        }

        .primary-contact {
            font-weight: bold;
            background: lightblue;
            border-radius: 10px;
            padding: 3px 3px 3px 3px;
            margin: 1px 1px 1px 1px;
        }

        .secondary-contact {
            font-weight: normal;
            background: none;
            border-radius: 10px;
            padding: 3px 3px 3px 3px;
            margin: 1px 1px 1px 1px;

        }

        .search-section {
            margin-top: -50px !important;
        }

        .marketStatus {
            margin-left: 15px !important;
            margin-right: 0px !important;
        }
    </style>
    <!-- Modernizr JS -->
    <script src="/js/modernizr-2.6.2.min.js"></script>
    <!-- FOR IE9 below -->
    <!--[if lt IE 9]>
    <script src="js/respond.min.js"></script>
    <![endif]-->
</head>
<body>

    <div id="fh5co-page">
        <header id="fh5co-header" role="banner">
            <div class="container">
                <div class="header-inner" id="menu"></div>
            </div>
        </header>
        <div id="fh5co-contact-section" class="contact-section">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 col-md-offset-3 text-center fh5co-heading">
                        <h2 id="pageTitle">Revenue Detail - TVB</h2>
                    </div>
                </div>
                <div id="divQuickReport" style="float:right;padding-right:25px;padding-bottom:10px;margin-top: -100px">
                    <label for="ddlQuickReport" class="search-ddl-label" style="text-align:right">Reports:&nbsp;</label>
                    <select class="search-ddl-select" onchange="getQuickReport(this.value)" style="width:207px;font-size:14px" id="ddlQuickReport"></select>
                </div>
                <!-- search / filter area -->
                <div class="row search-section">
                    <div class="col-md-12">
                        <center>
                            <div>
                                <div class="col-md-3">
                                    <label for="ddlMarket">Market</label><br />
                                    <select id="ddlMarket" style="width:220px" onchange="getStations();"></select>
                                </div>
                                <div class="col-md-3">
                                    <label for="ddlYearPeriod">Year-Period</label><br />
                                    <select id="ddlYearPeriod" onchange="getRevenueDetail();"></select><br />
                                    <a href="#" onclick="moveToPreviousPeriod();">Previous Period</a> | <a href="#" onclick="moveToNextPeriod();">Next Period</a>
                                </div>

                            </div>
                        </center>
                        <hr />
                    </div>
                </div>
                <div class="row marketStatusEmpty" style="display:none;border:silver solid 1px;background:#F7F1F1;border-radius:15px;padding-bottom:5px">
                    <div class="col-md-12">
                        <div>
                            <label for="MarketStatusEmpty"><u>Market Status</u> </label><br />
                            <div id="MarketStatusEmpty">No data for selected Market and Period.</div>
                        </div>

                    </div>
                </div>
                <div class="row marketStatus" style="display:none;border:silver solid 1px;background:#F7F1F1;border-radius:15px;padding-bottom:5px">
                    <div class="col-md-6">
                        <div>
                            <input type="hidden" id="revision" value="0" />
                            <label for="MarketStatus"><u>Year/Period Status</u> </label><br />
                            <div id="MarketStatus"></div>
                            <br />
                            <label for="TimeSalesStationsSubmitted"><u>Time Sales Stations Submitted</u></label><br />
                            <div id="TimeSalesStationsSubmitted"></div>
                        </div>
                        <div class="divInternalComment" style="display:none">
                            <label for="InternalCommentText"><u>Internal Comment</u></label>
                            <div id="InternalCommentText"></div>
                        </div>
                        <div style="text-align:center">
                            <hr style="margin-top:0;margin-bottom:10px" />
                            <input type="button" id="marketCommentButton" class="marketHistoryButton" onclick="openinternalCommentDialog()" value="Update Internal Comment" />
                        </div>
                        <div class="divExternalComment" style="display:none">
                            <label for="divExternalCommentText"><u>Client Comment</u></label>
                            <div id="divExternalCommentText"></div>
                        </div>
                    </div>

                    <div class="col-md-6" style="text-align:center">
                        <div style="padding-top:5px" id="rankSection">
                            <input type="button" style="width:200px" class="marketHistoryButton" onclick="rankYearPeriod();" value="Rank All Markets" />
                        </div>
                        <div style="display:none;padding-top:5px" id="unrankSection">
                            <input type="button" style="width:200px" class="marketHistoryButton" onclick="unrankYearPeriod();" value="Un-rank market (revision)" />
                        </div>
                    </div>
                </div>

                <!-- start datatable-->
                <a href="#" name="topOfStations"></a>
                <div class="dataTable-top-margin">

                    <div class="col-md-8  ">
                        <div class="stationNavigation">
                            <div class="col-md-6 ">
                                <label for="ddlStation">Station</label>
                                <select id="ddlStation" onchange="getRevenueDetail();"></select>
                                <div class="stationNavigation" style="display:none">
                                    <a href="#" onclick="moveToPreviousStation();">Previous Station</a> | <a href="#" onclick="moveToNextStation();">Next Station</a>
                                </div>
                            </div>
                            <div class="col-md-6" style="padding-top: 20px;height: 62px;vertical-align: middle;">
                                <center>
                                    <input type="button" href="#" onclick="postSaveCallback = null; saveChanges();" class="saveChanges" value="Save Changes" />
                                </center>
                            </div>
                        </div>
                        <table id="dtRevenueDetail" class="stripe">
                            <thead>
                                <tr>
                                    <th class="exportColumn">Category</th>
                                    <th class="exportColumn text-align-right"><span class="current-year-period">Current</span></th>
                                    <th class="exportColumn text-align-right"><span class="prior-year-period">Prior</span></th>
                                    <th class="exportColumn text-align-right">Change</th>
                                </tr>
                            </thead>
                            <tfoot>
                                <tr>
                                    <th class="exportColumn">Category</th>
                                    <th class="exportColumn text-align-right"><span class="current-year-period">Current</span></th>
                                    <th class="exportColumn text-align-right"><span class="prior-year-period">Prior</span></th>
                                    <th class="exportColumn text-align-right">Change</th>
                                </tr>
                            </tfoot>
                        </table>
                        <div>
                            <div class="stationNavigation" style="margin-top:20px">
                                <div class="col-md-6">
                                    <label for="ddlStationBottom">Station</label>
                                    <span id="ddlStationBottom"></span>
                                    <div class="stationNavigation" style="display:none">
                                        <a href="#" onclick="moveToPreviousStation();">Previous Station</a> | <a href="#" onclick="moveToNextStation();">Next Station</a>
                                    </div>
                                </div>
                                <div class="col-md-6" style="padding-top: 20px;height: 62px;vertical-align: middle;">
                                    <center>
                                        <input type="button" href="#" onclick="postSaveCallback = null; saveChanges();" class="saveChanges" value="Save Changes" />
                                    </center>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 stationNavigation" style="border-radius:15px;border:silver solid 1px; padding-bottom:5px;margin-top: 60px;" id="stationDetail">
                        <label for="StationEntered" id="stationStatusLabel">Station Status: </label>
                        <span id="StationEntered"></span>
                        <hr style="margin: 0;" />
                        <strong>Contact(s)</strong><hr style="margin: 0;" />
                        <div style="max-height:600px; overflow:auto">
                            <span id="StationContact"></span>
                        </div>
                        <label for="txtStationComment">Station comment</label><br />
                        <textarea type="text" id="txtStationComment" style="width:100%;overflow:auto" maxlength="250"></textarea>
                        <div style="text-align:center">
                            <hr style="margin-top:0;margin-bottom:10px" />
                            <input type="button" id="stationCommentButton" onclick="updateStationComment()" value="Update Comments" />
                        </div>
                    </div>
                </div>
                <!-- end datatable -->
            </div>
        </div>
        <!--<div id="map" data-animate-effect="fadeIn"></div>-->
    </div>
    <div id="internalCommentDialog" title="" style="display:none">
        <center>
            <textArea style="width:100%;overflow:auto" maxlength="250" id="comments" placeholder="Enter comments here..."></textArea><hr />
            <div style="margin-top:5px;margin-bottom:5px">
                <input type="button" id="btnProcess" value="Process" onclick="updateMarketHistoryComment()" \>
            </div>
            <div style="margin-top:5px;margin-bottom:5px">
                <input type="button" id="btnCancel" value="Cancel" onclick="cancelIt()" \>
            </div>
        </center>
    </div>

    <!-- jQuery -->
    <script src="/js/jquery.min.js"></script>
    <!-- jQuery Easing -->
    <script src="/js/jquery.easing.1.3.js"></script>
    <!-- Bootstrap -->
    <script src="/js/bootstrap.min.js"></script>
    <!-- Bootbox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
    <!-- Waypoints -->
    <script src="/js/jquery.waypoints.min.js"></script>
    <!-- BlockUI JS -->
    <script src="/js/blockUI.js"></script>
    <!-- Config JS -->
    <script src="/js/config.js"></script>
    <!-- MAIN JS -->
    <script src="/js/main.js"></script>
    <!-- genericReport JS -->
    <script src="/js/genericReport.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.18/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.print.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.colVis.min.js"></script>
    <!--Chosen Dropdown-->
    <script src="/js/chosen.jquery.min.js"></script>

</body>
</html>
<script>

    var bInvalidDataFound = false;

    var gotMarkets = false;
    var gotYearsPeriods = false;
    var gotStations = false;
    var initializedRevenueDetail = false;
    var revenueDetailChanged = false;
    var needUnrank = false;
    var revenueAmountsAllValid = true;
    var postSaveCallback = null;
    var minimumPercentSubmittedBeforeRank = 80;

    $(document).ready(function () {


        buildTVBMenu('Revenue');
        getMarkets();
        // stations will be loaded once market is selected
        getYearsPeriods();
        getRevenueDetail(); // just to initialize table

        //setEventListeners();

        clearSearchButtonSetup();

        buildQuickReports(['tvb']);

        // Reset this variable
        //setLocalStorage("quickReportQS", null);

        //setTimeout(loadLastSearch, 1000);

        //setLocalStorage("search", $("#searchText").val().trim() + '|' + $("#searchTextNumber").val().trim() + '|' + $("#ddlMediaType").val()  );
        //setLocalStorage("searchPage", window.location);

    });
    function cancelIt()
    {
        $("#internalCommentDialog").dialog("close");
    }
    function openinternalCommentDialog()
    {

        buildDialog();

        $("#internalCommentDialog").dialog({ title: 'Update Internal Comment' });

        $("#internalCommentDialog").dialog("open");
        $("#comments").val($("#InternalCommentText").html());
    }
    function buildDialog()
    {

        $(function () {

            $("#internalCommentDialog").dialog({
                autoOpen: false,
                resizable: false,
                width: 600,
                height: 300,
                modal: true
            });
        });
    }
    function getChangeRatio(revenueAmount, priorRevenueAmount) {
        var changeRatio = 0;
        if (revenueAmount == 0 && priorRevenueAmount == 0) {
            changeRatio = 0;
        } else if (priorRevenueAmount == 0) {
            changeRatio = 1;
        } else {
            changeRatio = (revenueAmount - priorRevenueAmount) / priorRevenueAmount;
        }
        return (changeRatio * 100).toFixed(1);
    }

    function clearSearchButtonSetup()
    {
        $("body").on("click", "#clear_search_button", function () {
            var table = $("#dtMarketList").DataTable();
            table.search('').draw();
        });

    }
    function setDataTable()
    {
        var reportTitle = "Reminders List";
        var exportColumns = returnTableColumnsByClass("dtRevenueDetail", "exportColumn");

        $("#dtRevenueDetail").DataTable({
            "dom": "Blfrtip",
            "pageLength": gDataTableDefaultRows,
            "columns": [
                { "data": 'categoryDescription' },
                { "data": 'revenueAmount' },
                { "data": 'priorRevenueAmount' },
                {
                    mRender: function (data, type, row) {
                        var changeRatio = getChangeRatio(row.revenueAmount, row.priorRevenueAmount);
                        return '<span id="change-' + row.categoryId + '">' + changeRatio + "</span>%";
                    },
                    "orderable": false,
                    "searchable": false
                },
            ],
            "columnDefs": [
                {
                    "targets": [
                        1 // Current
                    ],
                    "className": "text-align-right",
                    "render": function (data, type, row) {
                        return '$<input type="text" onFocus="this.select()" class="revenue-detail' + (row['isTotal'] ? ' revenue-detail-total' : '') + ' text-align-right"'
                            + ' id="revenue-detail-' + row['categoryId'] + '"'
                            + ' data-category-id="' + row['categoryId'] + '"'
                            + ' data-contributes-to-category-id="' + row['contributesToCategoryId'] + '"'
                            + ' onchange="recalculateTotals();"'
                            + ' value="' + data + '"></input><span class="implicit-thousands">,000</span>';
                    }
                },
                {
                    "targets": [
                        2 // Prior,
                    ],
                    "className": "text-align-right",
                    "render": function (data, type, row) {
                        return '$<span id="prior-revenue-detail-' + row['categoryId'] + '">' + data
                            + '</span><span class="implicit-thousands">,000</span>';
                    }
                },
                {
                    "targets": [
                        3 // Change
                    ],
                    "className": "text-align-right"
                }
            ],
            "ordering": false,
            "paging":   false,
            "info": false,
            "searching": false,
            "pagingType": "full_numbers",
            "buttons": [],
            //"buttons": [
            //   {
            //       extend: 'csv',
            //       exportOptions: {
            //           columns: exportColumns,
            //           format: {
            //               header: function (data, columnIdx) {
            //                   return returnExportColumnHeadingTitle("dtRevenueDetail", data, columnIdx);
            //               }
            //           }
            //       }
            //   },
            //   {
            //       extend: 'excel',
            //       title: reportTitle,
            //       exportOptions: {
            //           columns: exportColumns,
            //           format: {
            //               header: function (data, columnIdx) {
            //                   return returnExportColumnHeadingTitle("dtRevenueDetail", data, columnIdx);
            //               }
            //           }
            //       }
            //   },
            //   {
            //       extend: 'pdf',
            //       title: reportTitle,
            //       exportOptions: {
            //           columns: exportColumns,
            //           format: {
            //               header: function (data, columnIdx) {
            //                   return returnExportColumnHeadingTitle("dtRevenueDetail", data, columnIdx);
            //               }
            //           }
            //       }
            //   },
            //   {
            //       extend: 'print',
            //       title: reportTitle,
            //       exportOptions: {
            //           columns: exportColumns,
            //           format: {
            //               header: function (data, columnIdx) {
            //                   return returnExportColumnHeadingTitle("dtRevenueDetail", data, columnIdx);
            //               }
            //           }
            //       }
            //   }
            //   //,
            //   //this button is supposed to handle column visibility
            //   //however it isn't working on our site
            //   //'colvis'
            //],
            initComplete: function () {
                $(".dataTables_filter").append('<button type="button" class="clear-button" id="clear_search_button"><img width="29" height="29" src="/images/red-x.png" /></button>');
            },
            createdRow: function (row, data, index) {
                //this adds the class to every row
                $(row).addClass('single-line-height');
                //this adds the class to total rows
                if (data["isTotal"]) {
                    // need to target td's because tr's already have background colors, with or without striping
                    $(row).find("td").addClass("total-category");
                }
            },
            language: {
                //this changes search box label from Search: to Filter Results:
                search: "Filter Results:"
            }
        });

    }

    function setEventListeners()
    {
        var input = document.getElementById("searchTextNumber");
        input.addEventListener("keyup", function (event) {
            // Cancel the default action, if needed
            event.preventDefault();
            // Number 13 is the "Enter" key on the keyboard
            if (event.keyCode === 13) {
                setLocalStorage("search", "");
                editMarket(document.getElementById("searchTextNumber").value);
            }
        });

        var input = document.getElementById("searchText");
        input.addEventListener("keyup", function (event) {
            // Cancel the default action, if needed
            event.preventDefault();
            // Number 13 is the "Enter" key on the keyboard
            if (event.keyCode === 13) {

                getMarkets();
            }
        });
    }

    function getMarkets() {
        var url = ServicePrefix + '/api/Market/GetMarketListForReminders';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inProductId": "TVB",
                "inActiveOnly": true
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                getMarketsSuccess(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);

    }

    function getMarketsSuccess(data, textStatus, jQxhr) {

        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        var previousMarketId = gotMarkets ? $("#ddlMarket").val() : -1;
        var str = '';

        str = '<option value="-1">-- Select a Market</option>';
        $.each(data.report.rows, function (index) {

            str = str + '<option value="' + data.report.rows[index].marketId + '">' + data.report.rows[index].marketName + '</option>';

        });

        $("#ddlMarket").html(str);
        convertToChosenSelect("ddlMarket", false, false);

        var previousMarketIdStillInList = false;
        $("#ddlMarket option").each(function () {
            if (this.value == previousMarketId) {
                previousMarketIdStillInList = true;
                return false;
            }
        });
        $("#ddlMarket").val(previousMarketIdStillInList ? previousMarketId : -1);

        gotMarkets = true;
        getStations();

    }

    function getYearsPeriods() {
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        var d = new Date();
        var thisYear = d.getFullYear();
        var thisMonth = d.getMonth() + 1; // getMonth() returns 0 to 11
        var priorYear = thisYear;
        var priorMonth = thisMonth - 1;
        if (priorMonth < 1) {
            priorMonth = 12;
            priorYear -= 1;
        }

        var str = '';

        for (var y = thisYear - 1; y <= thisYear; y++) {
            for (var m = 1; m <= 12; m++) {
                str = str + '<option ';
                if (y == priorYear && m == priorMonth) {
                    str = str + " selected ";
                }
                str = str + ' value="' + y.toString() + (m < 10 ? '0' + m.toString() : m.toString()) + '">' + y.toString() + '-' + monthNames[m - 1] + '</option>';
            }
        }

        $("#ddlYearPeriod").html(str);
        convertToChosenSelect("ddlYearPeriod", false, false);

        gotYearsPeriods = true;
        getRevenueDetail();
    }

    function setStationLabels()
    {


        $("#ddlStationBottom").html($("#ddlStation option:selected").text());
        $("#stationStatusLabel").text("Station [ " + $("#ddlStation option:selected").text() + " ] Status:");
    }

    function getStations() {

        var marketId = $("#ddlMarket").val();
        $(".marketStatus").hide();
        $(".marketStatusEmpty").hide();
        $(".marketSelected").hide();
        $(".stationNavigation").hide();

        if (marketId == -1)
        {
            var str = '<option value="-1">-- Market not yet selected</option>';
            $("#ddlStation").html(str);
            return;
        }

        //$(".marketStatus").show();
        //$(".marketSelected").show();

        var url = ServicePrefix + '/api/Station/GetStationListByMarket';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inProductId": "TVB",
                "inMarketId": $("#ddlMarket").val(),
                "inActiveOnly": "1",
                "inOmitNonReportingStations": "1"
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                getStationsSuccess(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);

    }

    function getStationsSuccess(data, textStatus, jQxhr)
    {
        $(".stationNavigation").hide();

        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        var previousStationId = gotStations ? $("#ddlStation").val() : -1;

        var str = '';
        str = '<option value="-1">-- Select a Station</option>';

        var stationToSelectId = "";

        $.each(data.report.rows, function (index) {

            if (stationToSelectId == "")
            {
                stationToSelectId = data.report.rows[index].reid;
            }

            $(".marketStatus").show();
            $(".marketStatusEmpty").hide();
            $(".stationNavigation").show();
            str = str + '<option value="' + data.report.rows[index].reid + '">' + data.report.rows[index].fullName + '</option>';

        });



        // this means no data found
        if (stationToSelectId == "")
        {
            $(".marketStatus").hide();
            $(".marketStatusEmpty").show();
        }

        $("#ddlStation").html(str);

        $("#ddlStationBottom").html($("#ddlStation option:selected").text());
        $("#stationStatusLabel").text("Station [ " + $("#ddlStation option:selected").text() + " ] Status:");

        var previousStationIdStillInList = false;


        $("#ddlStation option").each(function () {
            if (this.value == previousStationId)
            {
                previousStationIdStillInList = true;
                return false;
            }
        });

        $("#ddlStation").html(str);
        $("#ddlStation").val(previousStationIdStillInList && previousStationId > -1 ? previousStationId : stationToSelectId);

        $("#ddlStationBottom").html($("#ddlStation option:selected").text());
        $("#stationStatusLabel").text("Station [ " + $("#ddlStation option:selected").text() + " ] Status:");

        convertToChosenSelect("ddlStation", false, false);

        gotStations = true;

        getRevenueDetail();

    }

    function loadLastSearch() {

        var search = getParameterByName("search");

        if (!search == false) {
            if (search.length > 0) {
                var sArray = new Array();
                sArray = search.split("|");

                $("#searchText").val(sArray[0].toString());
                $("#searchTextNumber").val(sArray[1].toString());
                $("#ddlMediaType").val(sArray[2].toString());

                getMarkets();
            }
        }

    }

    function currentRevenueYear() {
        return $("#ddlYearPeriod").val().toString().substring(0, 4);
    }

    function currentRevenuePeriod() {
        return $("#ddlYearPeriod").val().toString().substring(4, 6); // second argument is also index, not length like .NET
    }

    function getRevenueDetail()
    {
        $("#dtRevenueDetail").hide();
        $("#dtRevenueDetail_wrapper").hide();
        setStationLabels();
        $("#txtStationComment").val("");

        if (!initializedRevenueDetail)
        {
            setDataTable();
            initializedRevenueDetail = true;
        }

        var currentYearPeriod = $("#ddlYearPeriod option:selected").text();
        var priorYearPeriod = (currentYearPeriod.substring(0, 4) - 1) + currentYearPeriod.substring(4, currentYearPeriod.length);

        $(".current-year-period").html(currentYearPeriod);
        $(".prior-year-period").html(priorYearPeriod);

        if (!gotStations || !gotYearsPeriods)
        {

            return;
        }

        var stationId = $("#ddlStation").val();
        if (stationId == -1 || stationId == null)
        {
            $("#dtRevenueDetail").DataTable().clear().draw();
            return;
        }
        $("#dtRevenueDetail_wrapper").show();

        $("#dtRevenueDetail").show();

        //setLocalStorage("search", $("#searchText").val().trim() + '|' + $("#searchTextNumber").val().trim() + '|' + $("#ddlMediaType").val());
        //setLocalStorage("searchPage", window.location);

        var url = ServicePrefix + '/api/TVB/GetRevenueDetail'
                + '?inApiToken=' + getLocalStorage("APIToken")
                + '&inYear=' + currentRevenueYear()
                + '&inPeriod=' + currentRevenuePeriod()
                + '&inStationId=' + stationId;

        $.ajax({
            url: url,
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',
            processData: false,
            success: function (data, textStatus, jQxhr) {
                getRevenueDetailSuccess(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });

    }

    function getRevenueDetailSuccess(data, textStatus, jQxhr) {

        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        populateDataTable("dtRevenueDetail", data);

        if (revenueDetailChanged) {
            bootbox.alert("Changes were not saved");
        }
        revenueDetailChanged = false;
        needUnrank = false; // will be checked when changes are saved

        showStationEnteredStatus();
        showStationContactInfo();
        showStationComment();
        showMarketStatus();
        showTimeSalesStationsSubmitted();
    }

    function showStationEnteredStatus()
    {


        var url = ServicePrefix + '/api/TVB/GetStationYearPeriodEnteredTimeSales';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inStationId": $("#ddlStation").val(),
                "inYear": currentRevenueYear(),
                "inPeriod": currentRevenuePeriod()
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                showStationEnteredStatusSuccess(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);
    }

    function showStationEnteredStatusSuccess(data, textStatus, jQxhr)
    {


        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        if (data.report.rows.length == 0) {
            MKAErrorMessageRtn("Failed to get station entered status");
            return;
        }

        var stationEnteredWho = (data.report.rows[0].enteredUser == null ? "" : "Entered by " + data.report.rows[0].enteredUser);
        stationEnteredWho = stationEnteredWho.toString().toLowerCase().replace("@millerkaplan.com", "");

        var stationText = (data.report.rows[0].isEntered ? stationEnteredWho + " on " + data.report.rows[0].enteredDateTime : "Not entered");


        $("#StationEntered").text(stationText);


    }

    function showStationContactInfo() {
        var url = ServicePrefix + '/api/PersonnelReport/GetPersonnelContactList'
            + '?inApiToken=' + getLocalStorage("APIToken")
            + '&inStationId=' + $("#ddlStation").val()
            + '&inProductId=TVB';

        var settings = {
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',
            processData: false,
            success: function (data, textStatus, jQxhr) {
                showStationContactInfoSuccess(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);
    }

    function showStationContactInfoSuccess(data, textStatus, jQxhr) {
        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        var str = '';
        if (data.report.rows.length == 0) {
            str = str + '<div>NONE</div>';
        }
        else {

            $.each(data.report.rows, function (index) {
                str = str + '<div ' + (data.report.rows[index]["Primary Contact"] ? ' class="primary-contact"' : 'secondary-contact') + '>';
                str = str + data.report.rows[index]["User"];
                str = str + (data.report.rows[index]["Phone"].length > 0 ? '<br>' + data.report.rows[index]["Phone"] : '');
                str = str + '<br><a href="mailto:' + data.report.rows[index]["Email"] + '">' + data.report.rows[index]["Email"] + '</a>';
                str = str + '</div>';
            });
        }

        $("#StationContact").html(str);
    }

    function showStationComment() {
        var url = ServicePrefix + '/api/Station/GetStation';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inStationId": $("#ddlStation").val()
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                showStationCommentSuccess(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);
    }

    function showStationCommentSuccess(data, textStatus, jQxhr)
    {
        $("#txtStationComment").html("");
 

        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        if (data.report.rows.length == 0) {
            MKAErrorMessageRtn("Failed to get station comment");
            return;
        }
        else
        {
            $("#txtStationComment").val( data.report.rows[0].comment);
        }


    }

    function showMarketStatus()
    {
        $("#rankSection").hide();
        $("#unrankSection").hide();
        $(".saveChanges").hide();
        $(".revenue-detail").prop("disabled", true);
        $(".divInternalComment").hide();
        $(".divExternalComment").hide();

        var url = ServicePrefix + '/api/TVB/GetYearPeriodReleasedOrRanked';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inYear": currentRevenueYear(),
                "inPeriod": currentRevenuePeriod()
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                showMarketStatusSuccess(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);
    }

    function showMarketStatusSuccess(data, textStatus, jQxhr) {
        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        if (data.report.rows.length == 0) {
            MKAErrorMessageRtn("Failed to get market status");
            return;
        }

        // null means no MarketHistory record created yet
        var message = (data.report.rows[0].revision === null ? '' : "<strong>Revision:</strong> " + data.report.rows[0].revision + ', ');

        if (message.length == 0) {
            message = "Preparing";
        } else if (data.report.rows[0].isReleased) {
            message = message + " RELEASED <br><strong>by:</strong> " + data.report.rows[0].releaseUser + " <strong>on:</strong> " + data.report.rows[0].releaseDateTime;
        } else if (data.report.rows[0].isRanked) {
            message = message + " RANKED <br><strong>by:</strong> " + data.report.rows[0].rankUser + " <strong>on:</strong> " + data.report.rows[0].rankDateTime;
        } else {
            message = message + " NOT RANKED";
        }

        $("#MarketStatus").html("<div>" + message + "</div>");

        $("#revision").val((data.report.rows[0].revision || 0));

        $("#InternalCommentText").html("");
        if (data.report.rows[0].internalMessage.length > 0) {
            $("#InternalCommentText").html(data.report.rows[0].internalMessage);
            $("#comments").val(data.report.rows[0].internalMessage);
            $(".divInternalComment").show();
        }

        $("#ExternalCommentText").html("");
        if (data.report.rows[0].externalMessage.length > 0) {
            $("#ExternalCommentText").html(data.report.rows[0].externalMessage);
            $(".divExternalComment").show();
        }

        if (data.report.rows[0].isReleased == false) {
            $(".saveChanges").show();
            $(".revenue-detail").prop("disabled", false);
            $(".revenue-detail-total").prop("disabled", true);
        }

        if (data.report.rows[0].isRanked == true) {
            $("#unrankSection").show();
        } else {
            $("#rankSection").show();
        }
    }

    function showTimeSalesStationsSubmitted() {
        var url = ServicePrefix + '/api/TVB/GetTimeSalesStationsSubmitted';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inYear": currentRevenueYear(),
                "inPeriod": currentRevenuePeriod()
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                showTimeSalesStationsSubmittedSuccess(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);
    }

    function showTimeSalesStationsSubmittedSuccess(data, textStatus, jQxhr) {

        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        if (data.report.rows.length == 0) {
            MKAErrorMessageRtn("Failed to get time sales stations submitted");
            return;
        }

        var submittedCount = data.report.rows[0].submittedCount;
        var totalCount = data.report.rows[0].totalCount;
        var submittedPercent = Math.round(1000 * submittedCount / totalCount) / 10; // one decimal place, .toFixed() apparently has occasional float weirdness
        var newText = submittedPercent + "% (" + submittedCount + " of " + totalCount + ")";

        if (submittedPercent >= minimumPercentSubmittedBeforeRank) {
            $(".marketHistoryButton").show();
        } else {
            $(".marketHistoryButton").hide();
            newText += " - need at least " + minimumPercentSubmittedBeforeRank + "% before ranking";
        }

        $("#TimeSalesStationsSubmitted").text(newText);
    }


    function validRevenueAmount(revenueAmount)
    {
        if (bInvalidDataFound  == true)
        {
            return;
        }

        if (isNaN(revenueAmount))
        {
            bInvalidDataFound = true;
            bootbox.alert("Invalid amount (not a number): " + revenueAmount, function () { bInvalidDataFound = false });
            return false;
        }

        iRevenueAmount = parseInt(revenueAmount);
        fRevenueAmount = parseFloat(revenueAmount);

        if (fRevenueAmount != iRevenueAmount)
        {
            bInvalidDataFound = true;
            bootbox.alert("Invalid amount (fractions not allowed): " + revenueAmount, function () { bInvalidDataFound = false });
            return false;
        }

        if (iRevenueAmount < 0)
        {
            bInvalidDataFound = true;
            bootbox.alert("Invalid amount (negative numbers not allowed): " + revenueAmount, function () { bInvalidDataFound = false });
            return false;
        }

        if (iRevenueAmount > 99999)
        { // same limit imposed by Submit Revenue on public site (totals are allowed to be larger)
            bInvalidDataFound = true;
            bootbox.alert("Invalid amount (too large): " + revenueAmount, function () { bInvalidDataFound = false });
            return false;
        }

        return true;
    }

    function recalculateTotals()
    {

        revenueDetailChanged = true;

        var categoryId = '';
        var isTotal = false;
        var revenueAmount = 0;
        var foundInvalidRevenueAmount = false;
        var priorRevenueAmount = 0;
        var contributesToCategoryId = '';
        var categoryTotals = {};
        var changeRatio = 0;

        revenueAmountsAllValid = false;

        $(".revenue-detail").each(function (index, value)
        {

            categoryId = $(this).attr("data-category-id");

            // if we calculated a new total, then copy the result back into the form
            isTotal = (categoryId in categoryTotals);

            if (isTotal == true)
            {
                $(this).val(categoryTotals[categoryId]);
            }

            revenueAmount = $(this).val(); // not $(this).attr("value") as it's not updated by user input

            if (isTotal==false && validRevenueAmount(revenueAmount)==false)
            {
                foundInvalidRevenueAmount = true;
                return; // doesn't exit the outer function, just this specific .each() call, hence shared variable for signaling
            }

            // calculate the total (if any) that is directly affected by this category
            contributesToCategoryId = $(this).attr("data-contributes-to-category-id");

            if (contributesToCategoryId != null)
            {
                if ((contributesToCategoryId in categoryTotals) == false)
                {
                    categoryTotals[contributesToCategoryId] = 0;
                }
                categoryTotals[contributesToCategoryId] += parseInt(revenueAmount);
            }

            // recalculate the change % in case the current amount changed
            priorRevenueAmount = $("#prior-revenue-detail-" + categoryId).text();
            changeRatio = getChangeRatio(revenueAmount, priorRevenueAmount);
            $("#change-" + categoryId).text(changeRatio);

        });

        if (foundInvalidRevenueAmount == true)
        {
            return;
        }

        revenueAmountsAllValid = true;
    }

    function getRevenueDetailFromPage() {
        var categoryId = null;
        var revenueAmount = null;
        var isTotal = null;
        var revenueDetailFromPage = [];
        $(".revenue-detail").each(function (index, value)
        {
            categoryId = $(this).attr("data-category-id");
            revenueAmount = $(this).val();
            isTotal = $(this).prop("disabled");

            revenueDetailObj = new Object();
            revenueDetailObj = {
                categoryId: categoryId,
                revenueAmount: revenueAmount,
                isTotal: isTotal
            }
            revenueDetailFromPage.push(revenueDetailObj);
        });
        return revenueDetailFromPage;
    }

    function confirmIfNeeded(isNeeded, confirmMessage, nextFunction)
    {
        if (!isNeeded) {
            nextFunction();
            return;
        }

        bootbox.confirm({
            message: confirmMessage,
            buttons: {
                confirm: {
                    label: "Proceed"
                },
                cancel: {
                    label: "Cancel"
                }
            },
            callback: function (result) {
                if (result) {
                    nextFunction();
                }
            }
        });
    }

    function saveChanges()
    {
        if (revenueDetailChanged==false)
        {
            if (postSaveCallback != null)
            {
                postSaveCallback();
            }
            else
            {
                bootbox.alert("No changes to save");
            }

            return;
        }

        if (postSaveCallback == null)
        {
            saveChanges_tryToSaveChanges();
            return;
        }

        bootbox.dialog({
            message: "Save Revenue",
            buttons: {
                saveAndProceed: {
                    label: "Save and proceed",
                    callback: saveChanges_tryToSaveChanges
                },
                proceedWithoutSaving: {
                    label: "Proceed without saving",
                    callback: saveChanges_postSaveChanges
                },
                cancel: {
                    label: "Cancel",
                    callback: function () {
                        // do nothing further
                    }
                }
            }
        });
    }

    function saveChanges_tryToSaveChanges()
    {
        if (revenueAmountsAllValid == false)
        {
            bootbox.alert("Can't save an invalid amount");
            return;
        }

        var url = ServicePrefix + '/api/TVB/GetRankStatus';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inYear": currentRevenueYear(),
                "inPeriod": currentRevenuePeriod()
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                saveChanges_getRankStatusSuccess(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);
    }

    function saveChanges_getRankStatusSuccess(data, textStatus, jQxhr)
    {
        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        if (data.report.rows.length == 0) {
            MKAErrorMessageRtn("Failed to get rank status");
            return;
        }

        if (data.report.rows[0].rankingInProgress) {
            bootbox.alert("Ranking is still in progress");
            return;
        }

        needUnrank = data.report.rows[0].ranked;
        confirmIfNeeded(
            needUnrank,
            "Year/period will be flagged as unranked",
            saveChanges_updateRevenueDetailInternalEdit
        );
    }

    function saveChanges_updateRevenueDetailInternalEdit() {
        var url = ServicePrefix + '/api/TVB/UpdateRevenueDetailInternalEdit';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inStationId": $("#ddlStation").val(),
                "inYear": currentRevenueYear(),
                "inPeriod": currentRevenuePeriod(),
                "inRevenueDetail": getRevenueDetailFromPage()
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                saveChanges_updateRevenueDetailInternalEditSuccess(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);

    }

    function saveChanges_updateRevenueDetailInternalEditSuccess(data, textStatus, jQxhr) {
        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        var url = ServicePrefix + '/api/TVB/GetRevenueDetailWarningsInternalEdit';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inStationId": $("#ddlStation").val(),
                "inYear": currentRevenueYear(),
                "inPeriod": currentRevenuePeriod()
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                saveChanges_getWarningsSuccess(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);

    }

    function saveChanges_getWarningsSuccess(data, textStatus, jQxhr) {
        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        var warningMessage = null;
        if (data.report.rows.length == 1) {
            warningMessage = data.report.rows[0].WarningMessage;
        }
        if (data.report.rows.length > 1) {
            warningMessage = "Large changes in revenue";
        }
        confirmIfNeeded(
            warningMessage != null,
            warningMessage,
            saveChanges_saveRevenueDetail
        );
    }

    function saveChanges_saveRevenueDetail() {
        var url = ServicePrefix + '/api/TVB/UpdateRevenueDetail';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inStationId": $("#ddlStation").val(),
                "inYear": currentRevenueYear(),
                "inPeriod": currentRevenuePeriod(),
                "inStationComment": $("#txtStationComment").val()
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                saveChanges_saveRevenueDetailSuccess(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);
    }

    function saveChanges_saveRevenueDetailSuccess(data, textStatus, jQxhr) {
        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        if (needUnrank) {
            saveChanges_unrank();
        } else {
            saveChanges_postSaveChanges();
        }
    }

    function saveChanges_unrank() {
        var url = ServicePrefix + '/api/TVB/UpdateYearPeriodUnrank';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inRevenueYear": currentRevenueYear(),
                "inRevenuePeriod": currentRevenuePeriod()
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                saveChanges_unrankSuccess(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);
    }

    function saveChanges_unrankSuccess(data, textStatus, jQxhr) {
        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        showMarketStatus();
        saveChanges_postSaveChanges();
    }

    function saveChanges_postSaveChanges()
    {
        revenueDetailChanged = false;
        needUnrank = false;

        if (postSaveCallback != null)
        {
            postSaveCallback();
        }
        else
        {
            if ($("#ddlStation option:selected").index() < $("#ddlStation option").length - 1) {
                moveToNextStation();
            }
            else
            {
                showStationEnteredStatus();
            }
        }
    }

    function moveToPreviousStation() {

        scrollToAnchor("topOfStations");

        if ($("#ddlStation option:selected").index() == 1) { // index 0 is "Select a station"
            bootbox.alert("Already on first station");
            return;
        }
        postSaveCallback = moveToPreviousStationSuccess;
        saveChanges();
    }

    function moveToPreviousStationSuccess() {
        var previousIndex = $("#ddlStation option:selected").index() - 1;
        $("#ddlStation").get(0).selectedIndex = previousIndex;
        $("#ddlStation").trigger("change");
    }

    function moveToNextStation()
    {
        scrollToAnchor("topOfStations");
        if ($("#ddlStation option:selected").index() == $("#ddlStation option").length - 1) {
            bootbox.alert("Already on last station");
            return;
        }

        postSaveCallback = moveToNextStationSuccess;

        saveChanges();

    }

    function moveToNextStationSuccess() {
        var nextIndex = $("#ddlStation option:selected").index() + 1;
        $("#ddlStation").get(0).selectedIndex = nextIndex;
        $("#ddlStation").trigger("change");
    }

    function moveToPreviousPeriod() {
        if ($("#ddlYearPeriod option:selected").index() == 0) {
            bootbox.alert("Already on first period");
            return;
        }
        postSaveCallback = moveToPreviousPeriodSuccess;
        saveChanges();
    }

    function moveToPreviousPeriodSuccess() {
        var previousIndex = $("#ddlYearPeriod option:selected").index() - 1;
        $("#ddlYearPeriod").get(0).selectedIndex = previousIndex;
        $("#ddlYearPeriod").trigger("change");
    }

    function moveToNextPeriod() {
        if ($("#ddlYearPeriod option:selected").index() == $("#ddlYearPeriod option").length - 1) {
            bootbox.alert("Already on last period");
            return;
        }
        postSaveCallback = moveToNextPeriodSuccess;
        saveChanges();
    }

    function moveToNextPeriodSuccess()
    {
        var nextIndex = $("#ddlYearPeriod option:selected").index() + 1;
        $("#ddlYearPeriod").get(0).selectedIndex = nextIndex;
        $("#ddlYearPeriod").trigger("change");
    }

    function rankYearPeriod()
    {
        var url = ServicePrefix + '/api/TVB/GetYearPeriodOkayToRank';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inYear": currentRevenueYear(),
                "inPeriod": currentRevenuePeriod()
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                rankMarket_okayToRankSuccess(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);
    }

    function rankMarket_okayToRankSuccess(data, textStatus, jQxhr) {
 
        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        if (data.report.rows.length == 0) {
            MKAErrorMessageRtn("Failed to get okay-to-rank status");
            return;
        }

        if (data.report.rows[0].ranked == true) {
            bootbox.alert("Ranking has already been done.");
            return;
        }
        if (data.report.rows[0].rankingInProgress == true) {
            bootbox.alert("Ranking already in process. You will be notified when it is complete.");
            return;
        }

 

        var url = ServicePrefix + '/api/TVB/InsertRankIntoQueue';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inYear": currentRevenueYear(),
                "inPeriod": currentRevenuePeriod(),
                "inInternalRevisionMessage": $("#txtInternalRevisionMessage").val(),
                "inClientRevisionMessage": $("#txtClientRevisionMessage").val()
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                rankMarket_insertRankIntoQueueSuccess(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);
    }

    function rankMarket_insertRankIntoQueueSuccess(data, textStatus, jQxhr) {
        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        bootbox.alert("Year/period scheduled for ranking - you should receive an e-mail when it is complete")
    }

    function unrankYearPeriod() {
        var url = ServicePrefix + '/api/TVB/UpdateReviewAndApproval';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inYear": currentRevenueYear(),
                "inPeriod": currentRevenuePeriod()
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                unrankMarket_updateReviewAndApprovalSuccess(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);
    }

    function unrankMarket_updateReviewAndApprovalSuccess(data, textStatus, jQxhr)
    {

        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        if (data.report.rows.length == 0) {
            MKAErrorMessageRtn("Failed to get update-review-and-approval status");
            return;
        }

        if (!data.report.rows[0].wouldBeRevision) {
            // in this situation, the last unreleased revision was already marked as unranked by UpdateReviewAndApproval, so skip ahead to the end
            unrankMarket_indicateOverallSuccess();
            return;
        }

        bootbox.dialog({
            message: "This will initiate a revision",
            buttons: {
                cancel: {
                    label: "Cancel",
                    callback: function() { }
                },
                initiateRevision_Available: {
                    label: "Leave old data available",
                    callback: function () {
                        unrankMarket_initiateRevision(true);
                    }
                },
                initiateRevision_Unavailable: {
                    label: "Make old data unavailable",
                    callback: function () {
                        unrankMarket_initiateRevision(false);
                    }
                }
            }
        });
    }

    function unrankMarket_initiateRevision(leaveOldDataAvailable) {
        var url = ServicePrefix + '/api/TVB/InitiateRevision';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inYear": currentRevenueYear(),
                "inPeriod": currentRevenuePeriod(),
                "inLeaveOldDataAvailable": leaveOldDataAvailable
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                unrankMarket_initiateRevisionSuccess(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);
    }

    function unrankMarket_initiateRevisionSuccess(data, textStatus, jQxhr) {
        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        unrankMarket_indicateOverallSuccess();
    }

    function unrankMarket_updateYearPeriodUnrank() {
        var url = ServicePrefix + '/api/TVB/UpdateYearPeriodUnrank';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inRevenueYear": currentRevenueYear(),
                "inRevenuePeriod": currentRevenuePeriod()
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                unrankMarket_updateYearPeriodUnrankSuccess(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);
    }

    function unrankMarket_updateYearPeriodUnrankSuccess(data, textStatus, jQxhr) {
        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        unrankMarket_indicateOverallSuccess();
    }

    function unrankMarket_indicateOverallSuccess() {
        showMarketStatus();
        bootbox.alert("Year/period has been un-ranked");
    }


    function updateMarketHistoryComment() {



        if ($("#ddlMarket").val() == "-1" ||
            $("#ddlMarket").val() == "") {
            bootbox.alert("A market must be selected to save a comment.");
            return;
        }

        if ($("#comments").val() == "") {
            bootbox.alert("An empty internal comment is not allowed.");
            return;
        }

        var url = ServicePrefix + '/api/TVB/UpdateTVBMarketHistoryDescription';

        //console.log($("#comments").text());
        //console.log($("#comments").val());
        //console.log($("#comments").html());
        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inRevenueYear": $("#ddlYearPeriod").val().toString().substring(0, 4),
                "inRevenuePeriod": $("#ddlYearPeriod").val().toString().substring(4, 6),
                "inDescription": $("#comments").val(),
                "inRevision": $("#revision").val()
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                updateMarketHistoryComment_Success(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);
    }
    function updateMarketHistoryComment_Success(data, textStatus, jQxhr) {

        if (data.response.status != "SUCCESS")
        {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }

        bootbox.alert("Market History Comment Updated");
        $("#internalCommentDialog").dialog('close');
        showMarketStatus();

    }

    function updateStationComment()
    {

        if ($("#ddlStation").val() == "-1" ||
            $("#ddlStation").val() == "")
        {
            bootbox.alert("A station must be selected to save a comment.");
            return;
        }

        if ($("#txtStationComment").val().trim() == "")
        {
            bootbox.alert("An empty station comment is not allowed.");
            return;
        }

        var url = ServicePrefix + '/api/Station/UpdateStationComment';

        var settings = {
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inStationId": $("#ddlStation").val(),
                "inComment": $("#txtStationComment").val()
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {
                UpdateStationComment_Success(data, textStatus, jQxhr);
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        };

        $.ajax(url, settings);
    }
    function UpdateStationComment_Success(data, textStatus, jQxhr)
    {

        if (data.response.status != "SUCCESS") {
            MKAErrorMessageRtn(data.response.errorMessage[0]);
            return;
        }
        else {
            bootbox.alert("Station Comment Updated");
        }
    }

</script>

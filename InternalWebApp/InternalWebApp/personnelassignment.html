
<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>MKA Internal Media Site</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">



    <!-- Facebook and Twitter integration -->
    <meta property="og:title" content="" />
    <meta property="og:image" content="" />
    <meta property="og:url" content="" />
    <meta property="og:site_name" content="" />
    <meta property="og:description" content="" />
    <meta name="twitter:title" content="" />
    <meta name="twitter:image" content="" />
    <meta name="twitter:url" content="" />
    <meta name="twitter:card" content="" />

    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <link rel="shortcut icon" href="favicon.ico">

    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,300,700,900' rel='stylesheet' type='text/css'>

    <link href="https://fonts.googleapis.com/css?family=Playfair+Display:400,700" rel="stylesheet">

    <!-- Animate.css -->
    <link rel="stylesheet" href="/css/animate.css">
    <!-- Icomoon Icon Fonts-->
    <link rel="stylesheet" href="/css/icomoon.css">
    <!-- Simple Line Icons -->
    <link rel="stylesheet" href="/css/simple-line-icons.css">
    <!-- Bootstrap  -->
    <link rel="stylesheet" href="/css/bootstrap.css">
    <!-- Theme style  -->
    <link rel="stylesheet" href="/css/style.css">

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.18/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.2/css/responsive.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.5.2/css/buttons.dataTables.min.css" />

    <!-- Modernizr JS -->
    <script src="/js/modernizr-2.6.2.min.js"></script>

    <!-- FOR IE9 below -->
    <!--[if lt IE 9]>
    <script src="js/respond.min.js"></script>
    <![endif]-->
    <style type="text/css">
        .assignmentBoxes
        {
            border:silver solid 1px; 
            border-radius:15px; 
            padding:5px 5px 5px 5px;
            height:287px;
        }
        .fh5co-heading
        {
            margin-bottom:unset;
        }
        hr
        {
            margin-top:5px;
            margin-bottom:5px;
        }
        .assignmentBoxHeader
        {
            padding-bottom: 3px;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            text-align:center;
            margin-bottom:5px;
            margin-top:0px;
            background-color:#34587a;
            color:white;
        }
    </style>

</head>
<body>


    <div id="fh5co-page">
        <header id="fh5co-header" role="banner">
            <div class="container">
                <div class="header-inner" id="menu"></div>
            </div>
        </header>
        <div id="fh5co-contact-section" class="contact-section">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 col-md-offset-3 text-center fh5co-heading">
                        <a name="workArea"></a> 
                        <h2>Personnel Assignment</h2>
                        <h3 id="nameOfPersonnel"></h3>
                    </div>
                </div>

                <!-- search / filter area -->
                <div class="row">
                    <div class="col-md-12">
                        <label for="ddlProduct" class="search-ddl-label">Product</label>
                        <select id="ddlProduct" class="search-ddl-select" style="" onchange="loadScreenForProductChange()"></select>
                    </div>
                </div>
                <div class="col-md-12" id="marketChoice" style="display:none">
                    <hr />
                    <div class="row" style="padding-bottom:10px">
                        <div >
                            <label for="ddlMarketAssign" class="search-ddl-label">Market</label>
                            <select id="ddlMarketAssign" class="search-ddl-select" style="" onchange="loadStationList()"></select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6" id="marketChoice">
                            <div class="assignmentBoxes">

                                <label for="ddlStation" class="search-ddl-label" style="vertical-align: top;">Stations</label>
                                <br /><div><input type="checkbox" id="chkSelectedStations" onclick="selectItems('chkSelectedStations', 'ddlStation')" /><span>&nbsp;Select All</span></div>
                                <select id="ddlStation" class="search-ddl-select" style="width:400px" multiple size="10"></select>
                            </div>
                        </div>
                        <div class="col-md-6 ProductChoices DMAChoices">
                            <div class="assignmentBoxes">
                                <label for="ddlReportDMA" class="search-ddl-label" style="vertical-align: top;">Reports</label><br />
                                <div><input type="checkbox" id="chkSelectedReportsDMA" onclick="selectItems('chkSelectedReportsDMA', 'ddlReportDMA')" /><span>&nbsp;Select All</span></div>

                                <select id="ddlReportDMA" class="search-ddl-select" style="width:400px" multiple size="10"></select>
                            </div>
                        </div>
                        <div class="col-md-6 ProductChoices MRRChoices">
                            <div class="assignmentBoxes">
                                <label for="ddlReport" class="search-ddl-label" style="vertical-align: top;">Reports</label><br />
                                <div><input type="checkbox" id="chkSelectedReports" onclick="selectItems('chkSelectedReports', 'ddlReport')" /><span>&nbsp;Select All</span></div>

                                <select id="ddlReport" class="search-ddl-select" style="width:400px" multiple size="10"></select>
                            </div>
                        </div>
                        <div class="col-md-6 ProductChoices XRYChoices" style="display:none">
                            <div class="assignmentBoxes" style="padding-top:0px;padding-left:0px;padding-right:0px">
                                <h4 class="assignmentBoxHeader">Assignment Actions</h4>
                                <div style="padding-left:10px; padding-right:10px">
                                    <input type="radio" name="radContactXRY" id="radXRYNotAContact" style="margin-right:5px" checked="checked" value="" /><label for="radXRYNotAContact">No Contact Assignment</label>
                                    &nbsp;&nbsp;
                                    <input type="radio" name="radContactXRY" id="radXRYPrimaryContact" style="margin-right:5px" value="primary" /><label for="radXRYPrimaryContact">Primary Contact</label>
                                    &nbsp;&nbsp;
                                    <input type="radio" name="radContactXRY" id="radXRYSecondaryContact" style="margin-right:5px" value="secondary" /><label for="radXRYSecondaryContact">Secondary Contact</label>
                                    <hr />
                                    <input type="checkbox" id="chkXRYRecipient" style="margin-right:5px" /><label for="chkXRYRecipient">Recipient</label> <br />
                                    <label for="ddlAccessXRY" class="search-ddl-label" style="vertical-align: top; margin-left:10px">Access Levels</label>
                                    <select id="ddlAccessXRY" class="search-ddl-select" style="height: 170px;width: 340px;" size="10"></select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 ProductChoices MRRChoices" style="margin-top:10px;" >
                                                           
                            <div class="assignmentBoxes" style="padding-top:0px;padding-left:0px;padding-right:0px;height:auto">
                                <h4 class="assignmentBoxHeader">Assignment Actions</h4>
                                <div style="padding-left:20px; padding-right:20px">
                                    <input type="checkbox" id="chkMRRAdministrator" style="margin-right:5px" /><label for="chkMRRAdministrator">Administrator</label>
                                    <hr />
                                    <input type="radio" name="radContactMRR" id="radMRRNotAContact" style="margin-right:5px" checked="checked" value="" /><label for="radMRRNotAContact">No Contact Assignment</label>
                                    &nbsp;&nbsp;&nbsp;
                                    <input type="radio" name="radContactMRR" id="radMRRPrimaryContact" style="margin-right:5px" value="primary" /><label for="radMRRPrimaryContact">Primary Contact</label>
                                    &nbsp;&nbsp;&nbsp;
                                    <input type="radio" name="radContactMRR" id="radMRRSecondaryContact" style="margin-right:5px" value="secondary" /><label for="radMRRSecondaryContact">Secondary Contact</label>
                                    <hr />
                                    <input type="checkbox" id="chkMRRRecipient" style="margin-right:5px" /><label for="chkMRRRecipient">Recipient</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 ProductChoices TVBChoices" style="display:none">
                        <div class="assignmentBoxes">
                            <hr />
                            <input type="checkbox" id="chkTVBWebSubmitter" style="margin-right:5px" /><label for="chkTVBWebSubmitter">Web Submitter</label>
                            <hr />
                            <input type="checkbox" id="chkTVBAllOwners" style="margin-right:5px" /><label for="chkTVBAllOwners">All Owners</label>
                            <hr />
                            <input type="radio" name="radContactTVB" id="radTVBNotAContact" style="margin-right:5px" checked="checked" /><label for="radTVBNotAContact">Not a Contact</label>
                            <br />
                            <input type="radio" name="radContactTVB" id="radTVBPrimaryContact" style="margin-right:5px" /><label for="radTVBPrimaryContact">Primary Contact</label>
                            <br />
                            <input type="radio" name="radContactTVB" id="radTVBSecondaryContact" style="margin-right:5px" /><label for="radTVBSecondaryContact">Secondary Contact</label>
                            <hr />
                            <label for="ddlAccessTVB" class="search-ddl-label" style="vertical-align: top; margin-left:10px">Access</label>
                            <select id="ddlAccesTVB" class="search-ddl-select" style="" multiple size="10"></select>
                            <hr />
                            <label for="ddlRepFirms" class="search-ddl-label" style="vertical-align: top; margin-left:10px">Rep Firms</label>
                            <select id="ddlRepFirms" class="search-ddl-select" style="" multiple size="10"></select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12" style="width:100%;text-align:center">
                        <hr />
                        <input value="Assign" id="btnAssign" class="default-button" type="button" style="display:none" onclick="doAssignment();" />
                        <div class="back-button-div">
                            <input value="Back" onclick="goBackToDashboard();" class="default-button" type="button">
                        </div>
                        <hr />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <label for="ddlOwner" class="search-ddl-label">Owner</label>
                        <select id="ddlOwner" class="search-ddl-select" style="" onchange="resetFiltersAndRefreshGrid('owner');"></select>
                    </div>
                    <div class="col-md-3">
                        <label for="ddlMarket" class="search-ddl-label">Market</label>
                        <select id="ddlMarket" class="search-ddl-select" style="" onchange="resetFiltersAndRefreshGrid('market');"></select>
                    </div>
                    <div class="col-md-2">
                        <label for="ddlStationProduct" class="search-ddl-label">Station</label>
                        <select id="ddlStationProduct" class="search-ddl-select" style="" onchange="resetFiltersAndRefreshGrid('station');"></select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12" style="text-align:center">
                        <hr />
                        <strong>Data Level View:</strong> &nbsp;&nbsp;

                        <input type="radio" name="dataView" checked="checked" value="role" onclick="loadPersonnelAssignmentList('dtPersonnelAssignmentList');" />&nbsp;Role&nbsp;&nbsp;
                        <input type="radio" name="dataView" value="market" onclick="loadPersonnelAssignmentList('dtPersonnelAssignmentList');" />&nbsp;Market&nbsp;&nbsp;
                        <input type="radio" name="dataView" value="owner" onclick="loadPersonnelAssignmentList('dtPersonnelAssignmentList');" />&nbsp;Owner&nbsp;&nbsp;
                        <input type="radio" name="dataView" value="station" onclick="loadPersonnelAssignmentList('dtPersonnelAssignmentList');" />&nbsp;Station
                    </div>
                </div>
                <!-- start datatable-->
                <div id="dtPersonnelAssignmentListHolder" class="dataTable-top-margin" style="padding-top:10px; padding-bottom:10px">
                    <table id="dtPersonnelAssignmentList" class="stripe"></table>
                </div>
                <div id="NotFunctional" style="display:none">
                    <h3>This functionality is not available at this time.</h3>
                </div>
                <!-- end datatable -->

            </div>
            </div>
            <!--<div id="map" data-animate-effect="fadeIn"></div>-->
        </div>
 

    <!-- jQuery -->
    <script src="/js/jquery.min.js"></script>
    <!-- jQuery Easing -->
    <script src="/js/jquery.easing.1.3.js"></script>
    <!-- Bootstrap -->
    <script src="/js/bootstrap.min.js"></script>
    <!-- Bootbox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
    <!-- Waypoints -->
    <script src="/js/jquery.waypoints.min.js"></script>
    <!-- BlockUI JS -->
    <script src="/js/blockUI.js"></script>
    <!-- Config JS -->
    <script src="/js/config.js"></script>
    <!-- MAIN JS -->
    <script src="/js/main.js"></script>

    <script type="text/javascript" src="https://cdn.datatables.net/1.10.18/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.print.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.colVis.min.js"></script>

</body>
</html>
<script>

    //global vars

    var personnelId = 0;
    var nameOfUser = "";

    var columns = [];
    var columnsToDisplay = new Array();
    var columnsToExport = new Array();

    $(document).ready(function () {

        pullQSData();

        setUI();

        buildMainMenu("Personnel");

        loadProductList();
        //loadOwnerList();
        //loadMarketList();
        //loadStationListByProduct();
        //loadPersonnelAssignmentList("dtPersonnelAssignmentList");
        gDataTableDefaultRows = 10;
    });
    function scrollToAnchor(aid) {
        var aTag = $("a[name='" + aid + "']");
        $('html,body').animate({ scrollTop: aTag.offset().top }, 'slow');
    }


    //--------------------------------//
    // Assignment start
    //--------------------------------//
    function doAssignment()
    {

        // validation
        if (areAssignmentsValid()==false)
        {
            return;
        }
        else
        {
            alert('passed');
        }


    }

    function areAssignmentsValid()
    {
        // a market must be selected
        if ($("#ddlMarketAssign").val() == "") {
            bootbox.alert("You must select a market to perform the assignment operation.");
            return false;
        }

        // at least 1 station
        var count = $("#ddlStation :selected").length;

        if (count <= 0) {
            bootbox.alert("You must select at least 1 station to perform the assignment operation.");
            return false;
        }

        switch ($("#ddlProduct").val().toString().toLowerCase())
        {

            case "dma":
                return areDMAAssignmentsValid();

            case "mrr":
                return areMRRAssignmentsValid();

            case "xry":
                return areXRYAssignmentsValid();

            default:
                return false;

        }
    }

    function areMRRAssignmentsValid()
    {



        // at least 1 action
        if ($("#chkMRRAdministrator").is(':checked') == false &&
            $("#chkMRRRecipient").is(':checked') == false &&
            $('input[name=radContactMRR]:checked').val() == "")
        {
            bootbox.alert("You must select at least 1 assignment action to perform the assignment operation.");
            return false;
        }


        // Recipients
        if ($("#chkMRRRecipient").is(':checked'))
        {
            var count = $("#ddlReport :selected").length;

            if (count <= 0) {
                bootbox.alert("You must select at least 1 report to perform the assignment operation.");
                return false;
            }
        }


    }
    function areDMAAssignmentsValid()
    {

        // Recipients
 
        var count = $("#ddlReportDMA :selected").length;

        if (count <= 0) {
            bootbox.alert("You must select at least 1 report to perform the assignment operation.");
            return false;
        }

    }
    function areXRYAssignmentsValid()
    {

        // at least 1 action
        if ($("#chkXRYRecipient").is(':checked') == false &&
            $('input[name=radContactXRY]:checked').val() == "")
        {
            bootbox.alert("You must select at least 1 assignment action to perform the assignment operation.");
            return false;
        }


        // Recipients
        if ($("#chkXRYRecipient").is(':checked'))
        {
            var count = $("#ddlAccessXRY :selected").length;

            if (count <= 0)
            {
                bootbox.alert("You must select an Access Level to perform the assignment operation.");
                return false;
            }
        }


    }
    //--------------------------------//
    // Assignment end
    //--------------------------------//

    function resetFiltersAndRefreshGrid(filter)
    {
        if (filter.toLowerCase() == "station")
        {
            $("#ddlMarket").val("");
            $("#ddlOwner").val("");
        }

        if (filter.toLowerCase() == "market")
        {
            $("#ddlStationProduct").val("");
            $("#ddlOwner").val("");
        }

        if (filter.toLowerCase() == "owner")
        {
            $("#ddlMarket").val("");
            $("#ddlStationProduct").val("");
        }

        loadPersonnelAssignmentList('dtPersonnelAssignmentList');
    }
    function pullQSData()
    {
        personnelId = getParameterByName("PersonnelId");
        if (personnelId == null) {
            window.location = "/dashboard.html";
        }
        nameOfUser = getParameterByName("Name");

        $("#nameOfPersonnel").html(nameOfUser.toUpperCase());
    }

    function setUI()
    {
        $("body").on("click", "#clear_search_button",
                     function () {
                         var table = $("#dtPersonnelList").DataTable();
                         table.search('').draw();
                     });
    }

    function selectItems(controlchecked, control)
    {

        if ($("#" + controlchecked).is(':checked') == false)
        {
            $("#" + control + " option:selected").each(function () {
                console.log('in');
                $(this).prop("selected", false);
            });
        }
        else
        {
            $("#" + control + " option").each(function () {
                $(this).prop("selected", true);
            });
        }
    }
    function loadScreenForProductChange()
    {
        // Hide all choices
        $(".ProductChoices").hide();

        // show selected choice
        $("." + $("#ddlProduct").val() + "Choices").show();

        // hide / show assign button
        if ($("#ddlProduct").val() == "") {
            $("#btnAssign").hide();
            $("#marketChoice").hide();
        }
        else
        {
            $("#btnAssign").show();
            $("#marketChoice").show();
        }

        scrollToAnchor('workArea');
        loadMarketList();
        loadOwnerList();
        loadStationListByProduct();
        loadPersonnelAssignmentList("dtPersonnelAssignmentList");
    }

    function loadPersonnelAssignmentList(dataTable)
    {
        if ($("#ddlProduct").val() == "MSS")
        {
            destroyDataTable('dtPersonnelAssignmentList');
            $("#NotFunctional").show();
            return;
        }
        else
        {
            $("#NotFunctional").hide();
        }

        if (!$("input[name='dataView']:checked").val())
        {
            //bootbox.alert("A view must be selected");
            return;
        }
        if ($("#ddlProduct").val() == "")
        {
            return;
        }

        var apiParameters = new Object();
        var columns = [];
        var apiToken = getLocalStorage("APIToken");
 
        // need to branch here by product...
        var api = '/api/' + getProductController($("#ddlProduct").val()) + '/Get' + $("#ddlProduct").val() + 'PersonnelAssignmentsBy';
        api = api + $("input[name='dataView']:checked").val();
        api = api + "?inApiToken=" + apiToken;
        api = api + "&inPersonnelId=" + personnelId;

        if ($("#ddlStationProduct").val() != "")
        {
            api = api + "&inStationId=" + $("#ddlStationProduct").val();
        }
        if ($("#ddlOwner").val() != "") {
            api = api + "&inOwnerId=" + $("#ddlOwner").val();
        }
 
        if ($("#ddlMarket").val() != "") {
            api = api + "&inMarketId=" + $("#ddlMarket").val();
        }

        //if ($("#ddlProduct").val() != "")
        //{
        //    apiParameters["inProductId"] = $("#ddlProduct").val();
        //}


        $.ajax({
            url: ServicePrefix + api,
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',
            processData: false,
            success: function (data, textStatus, jQxhr) {
                if (data.response.status.toUpperCase() === "SUCCESS") {

                    buildColumnsArray(data, dataTable);

                }
                else {
                    var msg = data.response.errorMessage[0];
                    bootbox.alert(msg, function () { });
                    return false;
                }
            },
            error: function (jqXhr, textStatus, errorThrown) {
                genericAjaxError(jqXhr, textStatus, errorThrown);
            }
        });
    }

    function destroyDataTable(tableToDestroy)
    {
        if ($.fn.DataTable.isDataTable('#' + tableToDestroy))
        {
                var searchTable = $('#' + tableToDestroy).DataTable();
                searchTable.destroy();
                $('#' + tableToDestroy).hide();
        }

        //If you want to repopulate the datatable with new columns and data,
        //you need to remove the datatable from the DOM. 
        //The .remove function will remove it.
        $("#" + tableToDestroy).remove();

        //Once you remove the datatable from the DOM, you need add the HTML back to the page.
        //I added a name to the DIV that has the table html. I used the datatable name plus added "Holder".
        //The following coding adds the table back.
        $("#" + tableToDestroy + "Holder").html('<table id="' + tableToDestroy + '" class="stripe"></table>');
    }

    function buildColumnsArray(dataObj, dataTable)
    {
        //destroyDataTable("dtPersonnelAssignmentList");

        columnsToDisplay = new Array();

        if ($("input[name='dataView']:checked").val() == "market")
        {
            columnsToDisplay.push("Market");
            //columnsToDisplay.push("Owner");
            //columnsToDisplay.push("Station");
            columnsToDisplay.push("Role");
            columnsToDisplay.push("Station Count");
            //columnsToDisplay.push("Report Count");
        }

        if ($("input[name='dataView']:checked").val() == "owner") {
            //columnsToDisplay.push("Market");
            columnsToDisplay.push("Owner");
            //columnsToDisplay.push("Station");
            columnsToDisplay.push("Role");
            columnsToDisplay.push("Station Count");
            //columnsToDisplay.push("Report Count");
        }


        if ($("input[name='dataView']:checked").val() == "role") {
            //columnsToDisplay.push("Market");
            //columnsToDisplay.push("Owner");
            //columnsToDisplay.push("Station");
            columnsToDisplay.push("Role");
            columnsToDisplay.push("Station Count");
            //columnsToDisplay.push("Report Count");
        }

        if ($("input[name='dataView']:checked").val() == "station") {
            columnsToDisplay.push("Market");
            columnsToDisplay.push("Owner");
            columnsToDisplay.push("Station");
            columnsToDisplay.push("Role");
            //columnsToDisplay.push("Station Count");
            columnsToDisplay.push("Report Count");
        }
        //columnsToDisplay.push("Market");
        //columnsToDisplay.push("Owner");
        //columnsToDisplay.push("Station");
        //columnsToDisplay.push("Role");
        //columnsToDisplay.push("Station Count");
        //columnsToDisplay.push("Report Count");

        columnsToExport = new Array();

        if (!dataObj["report"]["rows"]) {
            destroyDataTable("dtPersonnelAssignmentList");
            return;
        }

        if (dataObj["report"]["rows"].length == 0) {
            destroyDataTable("dtPersonnelAssignmentList");
            return;
        }


        $('#' + dataTable).show();
        var data = dataObj["report"]["rows"][0];
        var ctr = -1;
        columns = new Array();

        $.each(data, function (objectName, objectValue)
        {

            if (columnsToDisplay.includes(objectName))
            {
                var className = "";

                if (isNaN(objectValue) == false)
                {
                    className = "text-align-right";
                }

                ctr++;
                columnsToExport.push(ctr);

                columns.push({
                    "title": objectName,
                    "visible": true,
                    "mData": objectName,
                    "orderable": true,
                    "className": className
                });
            }
        });
        //console.log(columns);
        //$('#dtPersonnelAssignmentList').show();
        loadResults(dataObj, columns, dataTable);
    }
    function getProductController(product)
    {
        if (product.toLowerCase() == 'xry')
        {
            return 'xray';
        }
        else
        {
            return product;
        }
    }
    function loadResults(data, columns, dataTable) {
        //data is the data from the ajax call
        //columns is the array that was built previously

        //assigns the data from the ajax call
        var results = data["report"]["rows"];




        //if the datatable already exists need to destroy it before building it
        //again with new results from the search.
        //if you try to destroy before it is a datatable, an error will occur.
        //this code will only destroy it if the table is a datatable.

        //The destroy function only destroys the data in the datatable.
        //However, the columns need to be same if repopulating the table.
        //if ($.fn.DataTable.isDataTable('#' + dataTable)) {
        //    searchTable = $('#' + dataTable).DataTable();
        //    searchTable.destroy();
        //}

        destroyDataTable(dataTable);

        //this code rebuilds the datatable with the updated data from the search 
        //or initial load.
       
        //////If you want to repopulate the datatable with new columns and data,
        //////you need to remove the datatable from the DOM. 
        //////The .remove function will remove it.
        ////$("#" + dataTable).remove();

        //////Once you remove the datatable from the DOM, you need add the HTML back to the page.
        //////I added a name to the DIV that has the table html. I used the datatable name plus added "Holder".
        //////The following coding adds the table back.
        ////$("#"+ dataTable +"Holder").html('<table id="' + dataTable +'" class="stripe"></table>');

        //creating a variable that will used for datatable functions later
        var searchTable;
        //once the remove and the html is added back, you can reload the table.
        //the new columns and data should now populate properly in the datatable.
        searchTable = $('#' + dataTable).DataTable({
            "dom": "Blfrtip",
            "pageLength": gDataTableDefaultRows,
            "order": [],
            "data": results,
            "columns": columns,
            "select": true,
            language: {
                search: "Filter Results:"
            },
            "buttons": [
               //{
               //    extend: 'csv',
               //    exportOptions: {
               //        columns: columnsToExport
               //    }
               //},
               {
                   extend: 'excel',
                   title: "Personnel Assignments",
                   exportOptions: {
                       columns: columnsToExport
                   }
               },
               //{
               //    extend: 'pdf',
               //    title: reportObject.reportTitle,
               //    exportOptions: {
               //        columns: columnsToExport
               //     }
               //},
               {
                   extend: 'print',
                   title: "Personnel Assignments",
                   exportOptions: {
                       columns: columnsToExport

                   }
               }
            ],
        });

    }

    function loadStationList()
    {
        var str = '';
        var controlToLoad = "#ddlStation";

        $(controlToLoad).html("");

        // no market select
        if ($("#ddlMarketAssign").val() == "")
        {



            $("#ddlReport").html("");
            $("#ddlReportDMA").html("");

            return;
        }

        var apiParameters = new Object();
        var apiToken = getLocalStorage("APIToken");

        apiParameters["inApiToken"] = apiToken;
        apiParameters["inMarketId"] = $("#ddlMarketAssign").val();
        apiParameters["inPersonnelId"] = personnelId;

        if ($("#ddlProduct").val() != "") {
            apiParameters["inProductId"] = $("#ddlProduct").val();
        }


        $.ajax({
            url: ServicePrefix + '/api/Station/GetStationListByMarketPersonnel',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify(apiParameters),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {

                        str = '';
                        var obj = data.report.rows[index];

                        str = str + '<option value="' + obj.reid + '">';
                        str = str + (obj.fullName).toUpperCase();
                        str = str + '</option>';

                        $(controlToLoad).append(str);

                    });



                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });

        if ($("#ddlProduct").val().toString().toLowerCase() == 'mrr')
        {
            loadReportList();
        }

        if ($("#ddlProduct").val().toString().toLowerCase() == 'xry')
        {
            loadXrayAccessLevelList();
        }

        if ($("#ddlProduct").val().toString().toLowerCase() == 'dma') {
            loadReportListDMA();
 
        }


    }
    function loadXrayAccessLevelList()
    {
        var str = '';
        var controlToLoad = "#ddlAccessXRY";

        $(controlToLoad).html("");
        //str = str + '<option value="">';
        //str = str + '-- Select an Access Level';
        //str = str + '</option>';
        //$(controlToLoad).append(str);

        var apiParameters = new Object();
        var apiToken = getLocalStorage("APIToken");

        apiParameters["inApiToken"] = apiToken;
        apiParameters["inMarketId"] = $("#ddlMarket").val();


        var api = 

        $.ajax({
            url: ServicePrefix + '/api/XRAY/GetXRYAccessLevelList?inApiToken=' + apiToken,
            dataType: 'json',
            type: 'get',
            contentType: 'application/json',
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {

                        str = '';
                        var obj = data.report.rows[index];

                        str = str + '<option value="' + obj.AccessLevelId + '">';
                        str = str + (obj['Access Description']);
                        str = str + '</option>';

                        $(controlToLoad).append(str);

                    });



                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });


    }

    function loadReportListDMA()
    {
        var str = '';
        var controlToLoad = "#ddlReportDMA";

        $(controlToLoad).html("");
        //str = str + '<option value="">';
        //str = str + '-- Select a Market';
        //str = str + '</option>';
        //$(controlToLoad).append(str);

        var apiParameters = new Object();
        var apiToken = getLocalStorage("APIToken");

        apiParameters["inApiToken"] = apiToken;

        $.ajax({
            url: ServicePrefix + '/api/DMA/GetReportList',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify(apiParameters),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {

                        str = '';
                        var obj = data.report.rows[index];

                        str = str + '<option value="' + obj.reportId + '">';
                        str = str + (obj.reportTitle);
                        str = str + '</option>';

                        $(controlToLoad).append(str);

                    });



                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });


    }
    function loadReportList() {
        var str = '';
        var controlToLoad = "#ddlReport";

        $(controlToLoad).html("");
        //str = str + '<option value="">';
        //str = str + '-- Select a Market';
        //str = str + '</option>';
        //$(controlToLoad).append(str);

        var apiParameters = new Object();
        var apiToken = getLocalStorage("APIToken");

        apiParameters["inApiToken"] = apiToken;
        apiParameters["inMarketId"] = $("#ddlMarket").val();
 
 


        $.ajax({
            url: ServicePrefix + '/api/MRR/GetMarketReportList',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify(apiParameters),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {

                        str = '';
                        var obj = data.report.rows[index];

                        str = str + '<option value="' + obj.reportId + '">';
                        str = str + (obj.reportTitle);
                        str = str + '</option>';

                        $(controlToLoad).append(str);

                    });



                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });


    }
    function loadMarketList() {

        var str = '';
        var controlToLoad = "#ddlMarket";

        $(controlToLoad).html("");
        str = str + '<option value="">';
        str = str + '-- Select a Market';
        str = str + '</option>';

        $("#ddlMarketAssign").html("");

        $(controlToLoad).append(str);
        $("#ddlMarketAssign").append(str);

        $.ajax({
            url: ServicePrefix + '/api/Market/GetMarketListByPersonnel',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inPersonnelId": personnelId,
                "inProductId": $("#ddlProduct").val(),
                "inActiveOnly" : true
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {

                        str = '';
                        var obj = data.report.rows[index];

                        str = str + '<option value="' + obj.marketId + '">';
                        str = str + obj.marketName;
                        str = str + '</option>';

                        $(controlToLoad).append(str);
                        $("#ddlMarketAssign").append(str);

                    });



                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });


    }
    function loadProductList() {

        var str = '';

        $("#ddlProduct").html("");
        str = str + '<option value="">';
        str = str + '-- Select a Product';
        str = str + '</option>';

        $("#ddlProduct").append(str);

        $.ajax({
            url: ServicePrefix + '/api/Personnel/GetPersonnelProductList',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inPersonnelId": personnelId
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {

                        str = '';
                        var obj = data.report.rows[index];
                        if (obj.active == true) {
                            str = str + '<option value="' + obj.productId.toUpperCase() + '">';
                            str = str + obj.productId.toUpperCase();
                            str = str + '</option>';
                        }
                        $("#ddlProduct").append(str);

                    });



                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });


    }
    function loadOwnerList() {

        var str = '';

        if ($("#ddlProduct").val()=="")
        {
            return;
        }


        $("#ddlOwner").html("");
        str = str + '<option value="">';
        str = str + '-- Select an Owner';
        str = str + '</option>';

        $("#ddlOwner").append(str);

        $.ajax({
            url: ServicePrefix + '/api/Personnel/GetPersonnelAssignedOwnershipList',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inPersonnelId": personnelId,
                "inProduct": $("#ddlProduct").val()
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {

                        str = '';
                        var obj = data.report.rows[index];

                        str = str + '<option value="' + obj.ownerId + '">';
                        str = str + obj.ownerName;
                        str = str + '</option>';

                        $("#ddlOwner").append(str);

                    });



                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });


    }
    function loadStationListByProduct() {

        var str = '';

        if ($("#ddlProduct").val() == "") {
            return;
        }


        $("#ddlStationProduct").html("");
        str = str + '<option value="">';
        str = str + '-- Select a Station';
        str = str + '</option>';

        $("#ddlStationProduct").append(str);

        $.ajax({
            url: ServicePrefix + '/api/Personnel/GetPersonnelAssignedStationListByProduct',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            data: JSON.stringify({
                "inApiToken": getLocalStorage("APIToken"),
                "inPersonnelId": personnelId,
                "inProduct": $("#ddlProduct").val()
            }),
            processData: false,
            success: function (data, textStatus, jQxhr) {

                if (data.response.status != "SUCCESS") {
                    MKAErrorMessageRtn(data.response.errorMessage[0]);
                }
                else {


                    $.each(data.report.rows, function (index) {

                        str = '';
                        var obj = data.report.rows[index];

                        str = str + '<option value="' + obj["Station Id"] + '">';
                        str = str + obj.Station;
                        str = str + '</option>';

                        $("#ddlStationProduct").append(str);

                    });



                }

            },
            error: function (jqXhr, textStatus, errorThrown) {
                MKAErrorMessageRtn(errorThrown);

            }
        });


    }



    function loadLastSearch() {

        var search = getParameterByName("search");

        if (!search == false) {
            if (search.length > 0) {
                var sArray = new Array();
                sArray = search.split("|");

                $("#ddlOwner").val(sArray[0]);
                $("#searchText").val(sArray[1].toString());
                $("#searchText2").val(sArray[2].toString());

                getPersonnelList();
            }
        }

    }

</script>

